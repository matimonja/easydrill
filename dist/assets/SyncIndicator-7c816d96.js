var ye=Object.defineProperty;var ve=(v,t,e)=>t in v?ye(v,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):v[t]=e;var c=(v,t,e)=>(ve(v,typeof t!="symbol"?t+"":t,e),e);import{_ as Ee}from"./preload-helper-cf010ec4.js";import{P as I,B as W,D as ue,a as k,b as Z,F as ne,L as K,T as se,c as ae,R as oe,d as le,e as ce,f as re,S as te,g as Q,h as ie,G as j,C as J,i as q,E as me,o as be}from"./ExerciseStorage-321cadc6.js";class xe{constructor(t=0,e=0){c(this,"x",0);c(this,"y",0);c(this,"zoom",1);c(this,"rotation",0);c(this,"minZoom",.1);c(this,"maxZoom",5);this.x=t,this.y=e}applyTransform(t,e){t.translate(e.width/2,e.height/2),t.scale(this.zoom,this.zoom),t.rotate(this.rotation),t.translate(-this.x,-this.y)}screenToWorld(t,e,i){const n=t-i.width/2,s=e-i.height/2,a=Math.cos(-this.rotation),o=Math.sin(-this.rotation),r=n*a-s*o,p=n*o+s*a,g=r/this.zoom+this.x,S=p/this.zoom+this.y;return{x:g,y:S}}zoomAt(t,e,i,n){const s=this.screenToWorld(e,i,n);this.zoom*=t,this.zoom=Math.max(this.minZoom,Math.min(this.zoom,this.maxZoom));const a=this.screenToWorld(e,i,n);this.x+=s.x-a.x,this.y+=s.y-a.y}pan(t,e){const i=Math.cos(-this.rotation),n=Math.sin(-this.rotation),s=t*i-e*n,a=t*n+e*i;this.x-=s/this.zoom,this.y-=a/this.zoom}toggleRotation(){this.rotation===0?this.rotation=-Math.PI/2:this.rotation=0}}class Se{constructor(t=914,e=550){c(this,"width");c(this,"height");c(this,"color","#3b82f6");c(this,"runoffColor","#f472b6");c(this,"lineColor","#ffffff");this.width=t,this.height=e}draw(t){const e=this.width/2,i=this.height/2,n=50;t.fillStyle=this.runoffColor,t.fillRect(-(e+n),-(i+n),this.width+n*2,this.height+n*2),t.fillStyle=this.color,t.fillRect(-e,-i,this.width,this.height),t.strokeStyle=this.lineColor,t.lineWidth=2,t.strokeRect(-e,-i,this.width,this.height),t.beginPath(),t.moveTo(0,-i),t.lineTo(0,i),t.stroke();const s=229;t.beginPath(),t.moveTo(-e+s,-i),t.lineTo(-e+s,i),t.stroke(),t.beginPath(),t.moveTo(e-s,-i),t.lineTo(e-s,i),t.stroke(),this.drawStrikingCircle(t,-e,1),this.drawStrikingCircle(t,e,-1),this.drawSpot(t,-e+64,0),this.drawSpot(t,e-64,0),this.drawMarks(t,-e,1),this.drawMarks(t,e,-1),this.drawGoal(t,-e,1),this.drawGoal(t,e,-1)}drawMarks(t,e,i){const n=this.height/2,s=3;t.strokeStyle=this.lineColor,t.lineWidth=2,t.beginPath(),[-18.3,18.3].forEach(r=>{const p=r<0?-1:1,g=r+50*p;t.moveTo(e,g),t.lineTo(e+s*i,g);const S=r+100*p;t.moveTo(e,S),t.lineTo(e+s*i,S)});const o=e+50*i;t.moveTo(o,-n),t.lineTo(o,-n+s),t.moveTo(o,n),t.lineTo(o,n-s),t.stroke()}drawStrikingCircle(t,e,i){t.strokeStyle=this.lineColor,t.lineWidth=2,t.beginPath();const o=e,r=-18.3,p=e,g=18.3;i===1?(t.arc(o,r,146.3,-Math.PI/2,0),t.lineTo(o+146.3,g),t.arc(p,g,146.3,0,Math.PI/2)):(t.moveTo(e,r-146.3),t.arc(o,r,146.3,-Math.PI/2,Math.PI,!0),t.lineTo(e-146.3,g),t.arc(p,g,146.3,Math.PI,Math.PI/2,!0)),t.stroke(),t.save(),t.setLineDash([10,10]),t.beginPath(),i===1?(t.arc(o,r,196.3,-Math.PI/2,0),t.lineTo(o+196.3,g),t.arc(p,g,196.3,0,Math.PI/2)):(t.arc(o,r,196.3,-Math.PI/2,Math.PI,!0),t.lineTo(e-196.3,g),t.arc(p,g,196.3,Math.PI,Math.PI/2,!0)),t.stroke(),t.restore()}drawSpot(t,e,i){t.beginPath(),t.fillStyle=this.lineColor,t.arc(e,i,2,0,Math.PI*2),t.fill()}drawGoal(t,e,i){t.strokeStyle=this.lineColor,t.lineWidth=2;const a=i===1?e-12:e,o=-36.6/2;t.strokeRect(a,o,12,36.6)}}class Ie{constructor(){c(this,"history",[]);c(this,"redoStack",[]);c(this,"maxHistory",50);c(this,"onChange",null)}execute(t){var e;t.execute(),this.history.push(t),this.redoStack=[],this.history.length>this.maxHistory&&this.history.shift(),(e=this.onChange)==null||e.call(this)}undo(){var e;const t=this.history.pop();t&&(t.undo(),this.redoStack.push(t),(e=this.onChange)==null||e.call(this))}redo(){var e;const t=this.redoStack.pop();t&&(t.execute(),this.history.push(t),(e=this.onChange)==null||e.call(this))}}const P={MIN_DELAY_AFTER_BALL_ACTION:.3,WAIT_BEFORE_EPSILON:.001,BALL_OFFSET_DISTANCE:17,ROTATION_LERP_FACTOR:.2,PICKUP_RADIUS:20,BASE_SPEED_PX_PER_SEC:50,MAX_ADDITIONAL_SPEED_PX_PER_SEC:350,DEFAULT_SPEED_PERCENT:50,INSTANT_ACTION_DURATION:1,ZERO_LENGTH_DURATION:1,BALL_RADIUS:6,BALL_COLOR_DEFAULT:"#FFA500",BALL_COLOR_MOVING:"#FFA500",BALL_STROKE_COLOR:"#fff"};class we{constructor(){c(this,"isPlaying",!1);c(this,"isPaused",!1);c(this,"speedMultiplier",1);c(this,"entities",[]);c(this,"playerStates",new Map);c(this,"balls",[]);c(this,"initialMemento",new Map);c(this,"ballEntityMementos",[])}play(t,e){this.entities=e,this.isPlaying=!0,this.isPaused=!1,this.resetState(),this.initializeState(t)}stop(){this.isPlaying&&(this.isPlaying=!1,this.isPaused=!1,this.restoreState(),this.balls=[])}pause(){this.isPlaying&&(this.isPaused=!this.isPaused)}setSpeed(t){this.speedMultiplier=t}update(t){if(!this.isPlaying||this.isPaused)return;const e=t*this.speedMultiplier;this.entities.forEach(i=>{i instanceof I&&this.updatePlayer(i,e)}),this.balls.forEach(i=>this.updateBall(i))}render(t){this.isPlaying&&(this.balls.forEach(e=>{e.status!=="held"&&(t.beginPath(),t.arc(e.x,e.y,P.BALL_RADIUS,0,Math.PI*2),t.fillStyle=e.color,t.fill(),t.strokeStyle=P.BALL_STROKE_COLOR,t.lineWidth=1,t.stroke())}),this.playerStates.forEach((e,i)=>{if(e.isWaitingForBall){const n=this.entities.find(s=>s.id===i);n&&(t.fillStyle="rgba(255, 255, 255, 0.7)",t.font="10px Arial",t.fillText("Esperando...",n.x-20,n.y-15))}}))}resetState(){this.playerStates.clear(),this.balls=[],this.initialMemento.clear(),this.ballEntityMementos=[]}initializeState(t){this.entities.forEach(e=>{e instanceof I?this.initializePlayer(e,t):e instanceof W&&this.initializeBallEntity(e)})}initializePlayer(t,e){this.initialMemento.set(t.id,{originalX:t.x,originalY:t.y,originalRotation:t.rotation,hasBall:t.hasBall});const i=t.actions.filter(n=>n.sceneIndex===e);this.playerStates.set(t.id,{currentAction:null,actionQueue:[...i],timeInAction:0,duration:0,isWaitingForBall:!1,isWaitingDelay:!1,delayTimer:0,hasBall:t.hasBall,propelsInProgress:[],ballActionCooldownRemaining:0}),t.hasBall&&(this.balls.push({id:crypto.randomUUID(),status:"held",ownerId:t.id,x:t.x+12,y:t.y+12,color:ue}),t.ballColor=ue)}initializeBallEntity(t){t.isGroup||(this.ballEntityMementos.push({id:t.id,visible:t.visible}),t.visible=!1,this.balls.push({id:crypto.randomUUID(),status:"loose",ownerId:null,x:t.x,y:t.y,color:t.color}))}restoreState(){this.entities.forEach(t=>{if(t instanceof I){const e=this.initialMemento.get(t.id);e&&(t.x=e.originalX,t.y=e.originalY,t.rotation=e.originalRotation,t.hasBall=e.hasBall),t.ballColor=void 0}}),this.ballEntityMementos.forEach(t=>{const e=this.entities.find(i=>i.id===t.id);e&&e instanceof W&&(e.visible=t.visible)})}updatePlayer(t,e){const i=this.playerStates.get(t.id);if(i){if(this.updatePropelsInProgress(t,i,e),i.ballActionCooldownRemaining>0&&(i.ballActionCooldownRemaining=Math.max(0,i.ballActionCooldownRemaining-e)),i.isWaitingDelay){i.delayTimer-=e,i.delayTimer<=0&&(i.isWaitingDelay=!1,this.startAction(t,i));return}for(i.hasBall||this.tryPickupBall(t,i);;){if(i.currentAction){this.processCurrentAction(t,i,e);break}if(i.hasBall||this.tryPickupBall(t,i),!this.tryStartNextAction(t,i))break}}}tryPickupBall(t,e){for(const n of this.balls){if(n.status==="held"||n.status==="moving"&&n.lastOwnerId===t.id)continue;if(Math.hypot(t.x-n.x,t.y-n.y)<=P.PICKUP_RADIUS){this.assignBallToPlayer(t,e,n);return}}const i=this.entities.filter(n=>n instanceof W&&n.isGroup&&n.visible);for(const n of i)if(n.containsPoint(t.x,t.y)){const s={id:crypto.randomUUID(),status:"held",ownerId:t.id,x:t.x+12,y:t.y+12,color:n.color};this.balls.push(s),this.assignBallToPlayer(t,e,s,!1);return}}assignBallToPlayer(t,e,i,n=!0){e.hasBall=!0,t.hasBall=!0,t.ballColor=i.color,e.isWaitingForBall=!1,n&&(i.status="held",i.ownerId=t.id,i.lastOwnerId=null)}updatePropelsInProgress(t,e,i){const n=e.propelsInProgress;for(let s=n.length-1;s>=0;s--){const a=n[s];a.timeElapsed+=i;const o=Math.min(1,a.timeElapsed/a.duration),r=this.balls.find(p=>p.id===a.ballId);if(r){const p=a.action.getPositionAt(o);r.x=p.x,r.y=p.y}if(a.timeElapsed>=a.duration){if(r){r.status="loose";const p=a.action.getPositionAt(1);r.x=p.x,r.y=p.y}n.splice(s,1)}}}processCurrentAction(t,e,i){const n=e.currentAction;if(n.ballInteraction==="propel")return;e.timeInAction+=i;const s=Math.min(1,e.timeInAction/e.duration);this.applyActionPhysics(t,n,s),e.timeInAction>=e.duration&&this.finishAction(t,e)}tryStartNextAction(t,e){const i=e.actionQueue[0];if(!i||e.ballActionCooldownRemaining>0)return!1;const n=i.waitBefore??0;return n>P.WAIT_BEFORE_EPSILON&&!e.isWaitingDelay?(e.actionQueue.shift(),e.currentAction=i,e.isWaitingDelay=!0,e.delayTimer=n,!1):this.canStartAction(i,e.hasBall)?(e.actionQueue.shift(),e.currentAction=i,this.startAction(t,e),!0):(e.isWaitingForBall=!0,!1)}startAction(t,e){const i=e.currentAction;if(e.timeInAction=0,e.duration=this.calculateDuration(i),e.isWaitingForBall=!1,i.ballInteraction==="propel"){e.ballActionCooldownRemaining=P.MIN_DELAY_AFTER_BALL_ACTION;const n=this.releaseBall(t,e);n&&e.propelsInProgress.push({action:i,timeElapsed:0,duration:e.duration,ballId:n}),e.currentAction=null}}releaseBall(t,e){const i=this.balls.find(n=>n.ownerId===t.id);return i?(i.status="moving",i.ownerId=null,i.lastOwnerId=t.id,e.hasBall=!1,t.hasBall=!1,t.ballColor=void 0,i.id):(e.hasBall=!1,t.hasBall=!1,t.ballColor=void 0,null)}canStartAction(t,e){return t.ballInteraction!=="none"?e:!0}applyActionPhysics(t,e,i){if(e.movesPlayer){const n=e.getPositionAt(i),s=e.getHeadingAt(i);if(t.rotation=this.lerpAngle(t.rotation,s,P.ROTATION_LERP_FACTOR),t.x=n.x,t.y=n.y,e.ballInteraction==="carry"){const a=this.balls.find(o=>o.ownerId===t.id);a&&this.updateBallPositionRelative(a,t)}}}finishAction(t,e){const i=e.currentAction;e.currentAction=null,i.ballInteraction==="carry"&&(e.ballActionCooldownRemaining=P.MIN_DELAY_AFTER_BALL_ACTION)}updateBall(t){if(t.status==="held"&&t.ownerId){const e=this.entities.find(i=>i.id===t.ownerId);e&&e instanceof I&&this.updateBallPositionRelative(t,e)}}calculateDuration(t){let e=P.DEFAULT_SPEED_PERCENT;t.speed!==void 0&&t.speed!==null&&(e=t.speed);const i=P.BASE_SPEED_PX_PER_SEC+e/100*P.MAX_ADDITIONAL_SPEED_PX_PER_SEC;return t.getPathLength()===0?P.ZERO_LENGTH_DURATION:!t.movesPlayer&&!t.movesBall&&t.ballInteraction==="none"?P.INSTANT_ACTION_DURATION:t.getPathLength()/i}updateBallPositionRelative(t,e){const i=P.BALL_OFFSET_DISTANCE,n=e.rotation+Math.PI/4;t.x=e.x+Math.cos(n)*i,t.y=e.y+Math.sin(n)*i}lerpAngle(t,e,i){const n=e-t,s=Math.atan2(Math.sin(n),Math.cos(n));return t+s*i}}class ee{constructor(t,e){this.game=t,this.entity=e}execute(){this.game.addEntity(this.entity)}undo(){this.game.removeEntity(this.entity)}}class Pe{constructor(t,e){this.game=t,this.entity=e}execute(){this.game.removeEntity(this.entity)}undo(){this.game.addEntity(this.entity)}}class Te{constructor(t,e,i,n,s){this.entity=t,this.oldX=e,this.oldY=i,this.newX=n,this.newY=s}execute(){this.entity.setPosition(this.newX,this.newY)}undo(){this.entity.setPosition(this.oldX,this.oldY)}}class Le{constructor(t,e,i){this.entity=t,this.oldState=e,this.newState=i}execute(){this.applyState(this.newState)}undo(){this.applyState(this.oldState)}applyState(t){t.x!==void 0&&(this.entity.x=t.x),t.y!==void 0&&(this.entity.y=t.y),t.rotation!==void 0&&(this.entity.rotation=t.rotation),t.width!==void 0&&(this.entity.width=t.width),t.height!==void 0&&(this.entity.height=t.height),t.radiusX!==void 0&&(this.entity.radiusX=t.radiusX),t.radiusY!==void 0&&(this.entity.radiusY=t.radiusY),t.endX!==void 0&&(this.entity.endX=t.endX),t.endY!==void 0&&(this.entity.endY=t.endY),t.points!==void 0&&(this.entity.points=JSON.parse(JSON.stringify(t.points))),this.entity instanceof k&&this.entity.owner&&this.entity.owner.updateActionChain()}}class ge{constructor(t,e){this.player=t,this.action=e}execute(){this.action.owner=this.player,this.player.actions.push(this.action)}undo(){const t=this.player.actions.indexOf(this.action);t>-1&&this.player.actions.splice(t,1),this.action.owner=null}}class Be{constructor(t,e){c(this,"removedActions",[]);c(this,"startIndex",-1);this.player=t,this.action=e}execute(){this.startIndex=this.player.actions.indexOf(this.action),this.startIndex>-1&&(this.removedActions=this.player.actions.splice(this.startIndex),this.removedActions.forEach(t=>t.owner=null))}undo(){this.startIndex>-1&&this.removedActions.length>0&&(this.removedActions.forEach(t=>t.owner=this.player),this.player.actions.splice(this.startIndex,0,...this.removedActions))}}class G{constructor(t){this.game=t}render(t){}activate(){}deactivate(){}getWorldPoint(t){const e=this.game.canvas.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;return this.game.camera.screenToWorld(i,n,this.game.canvas)}}class Ae extends G{constructor(){super(...arguments);c(this,"isDraggingEntity",!1);c(this,"dragStartPos",null);c(this,"initialEntityPos",null);c(this,"dragOffset",null);c(this,"isResizing",!1);c(this,"activeHandleId",null);c(this,"initialResizeState",null);c(this,"isDraggingZone",!1);c(this,"isResizingZone",!1);c(this,"zoneDragStart",null);c(this,"zoneInitialRect",null);c(this,"zoneActiveHandle",null)}onMouseDown(e){const i=this.getWorldPoint(e),n=this.game.getSelectedEntity();if(n){const r=10*(1/this.game.camera.zoom);if(n instanceof Z){const p=n.getHandles(),g=i.x-n.x,S=i.y-n.y,B=Math.cos(-n.rotation),T=Math.sin(-n.rotation),M=g*B-S*T,C=g*T+S*B;for(const L of p)if(Math.abs(M-L.x)<r&&Math.abs(C-L.y)<r){this.isResizing=!0,this.activeHandleId=L.id,this.initialResizeState=this.captureState(n);return}}else if(n instanceof k){const p=n.getHandles();for(const g of p)if(Math.hypot(i.x-g.x,i.y-g.y)<r){this.isResizing=!0,this.activeHandleId=g.id,this.initialResizeState=this.captureState(n);return}}}if(this.game.isZoneEditing()){const r=10*(1/this.game.camera.zoom),p=this.game.getZoneHandles();for(const g of p)if(Math.abs(i.x-g.x)<r&&Math.abs(i.y-g.y)<r){this.isResizingZone=!0,this.zoneActiveHandle=g.id,this.zoneDragStart={...i},this.zoneInitialRect=this.game.getZoneRect();return}}let s;const a=this.game.entities.slice().reverse();for(const o of a)if(o instanceof I){if(o.containsPoint(i.x,i.y)){s=o;break}const r=o.actions.slice().reverse();for(const p of r)if(p.containsPoint(i.x,i.y)){s=p;break}if(s)break}else if(o.containsPoint(i.x,i.y)){s=o;break}if(s){this.game.selectEntity(s),s instanceof k||(this.isDraggingEntity=!0,this.dragStartPos={x:i.x,y:i.y},this.initialEntityPos={x:s.x,y:s.y},this.dragOffset={x:s.x-i.x,y:s.y-i.y});return}if(this.game.hasZone()){const o=this.game.getZoneRect(),r=8/this.game.camera.zoom;if(o&&this.isPointOnRectEdge(i.x,i.y,o,r)){this.game.isZoneSelected()?this.game.isZoneEditing()&&(this.isDraggingZone=!0,this.zoneDragStart={...i},this.zoneInitialRect={...o}):this.game.selectZone();return}}this.game.selectEntity(null),this.game.isZoneSelected()&&this.game.deselectZone()}onMouseMove(e){const i=this.getWorldPoint(e),n=this.game.getSelectedEntity();if(this.isResizingZone&&this.zoneDragStart&&this.zoneInitialRect&&this.zoneActiveHandle){const s=this.zoneInitialRect,a=i.x-this.zoneDragStart.x,o=i.y-this.zoneDragStart.y,r={...s};switch(this.zoneActiveHandle){case"nw":r.x=s.x+a,r.y=s.y+o,r.w=s.w-a,r.h=s.h-o;break;case"ne":r.y=s.y+o,r.w=s.w+a,r.h=s.h-o;break;case"sw":r.x=s.x+a,r.w=s.w-a,r.h=s.h+o;break;case"se":r.w=s.w+a,r.h=s.h+o;break}r.w<20&&(r.w=20,r.x=s.x+s.w-20),r.h<20&&(r.h=20,r.y=s.y+s.h-20),this.game.setZoneRect(r);return}if(this.isDraggingZone&&this.zoneDragStart&&this.zoneInitialRect){const s=i.x-this.zoneDragStart.x,a=i.y-this.zoneDragStart.y;this.game.setZoneRect({x:this.zoneInitialRect.x+s,y:this.zoneInitialRect.y+a,w:this.zoneInitialRect.w,h:this.zoneInitialRect.h});return}if(this.isResizing&&this.activeHandleId&&n){if(n instanceof Z)if(this.activeHandleId==="rotate"){const s=i.x-n.x,a=i.y-n.y;n.rotation=Math.atan2(a,s)+Math.PI/2}else{const s=i.x-n.x,a=i.y-n.y,o=Math.cos(-n.rotation),r=Math.sin(-n.rotation),p=s*o-a*r,g=s*r+a*o;n.resize(this.activeHandleId,p,g)}else n instanceof k&&n.resize(this.activeHandleId,i.x,i.y);return}this.isDraggingEntity&&n&&!this.isResizing&&this.dragOffset&&n.setPosition(i.x+this.dragOffset.x,i.y+this.dragOffset.y)}onMouseUp(e){const i=this.game.getSelectedEntity();if(this.isResizingZone||this.isDraggingZone){this.isResizingZone=!1,this.isDraggingZone=!1,this.zoneDragStart=null,this.zoneInitialRect=null,this.zoneActiveHandle=null,this.game.updateSelectionUI();return}if(this.isResizing&&i&&this.initialResizeState){const n=this.captureState(i);JSON.stringify(this.initialResizeState)!==JSON.stringify(n)&&this.game.commandManager.execute(new Le(i,this.initialResizeState,n)),this.isResizing=!1,this.activeHandleId=null,this.initialResizeState=null}if(this.isDraggingEntity&&i&&this.initialEntityPos&&!this.isResizing){const n=i.x-this.initialEntityPos.x,s=i.y-this.initialEntityPos.y;(Math.abs(n)>1||Math.abs(s)>1)&&this.game.commandManager.execute(new Te(i,this.initialEntityPos.x,this.initialEntityPos.y,i.x,i.y))}this.isDraggingEntity=!1,this.dragStartPos=null,this.initialEntityPos=null,this.dragOffset=null}render(e){const i=this.game.getSelectedEntity();if(i){const n=1/this.game.camera.zoom,s=8*n;if(e.lineWidth=1*n,i instanceof Z){const a=i.getHandles();e.save(),e.translate(i.x,i.y),e.rotate(i.rotation);for(const o of a)o.id==="rotate"?(e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(o.x,o.y+25),e.strokeStyle="#ffffff",e.stroke(),e.beginPath(),e.arc(o.x,o.y,s,0,2*Math.PI),e.fillStyle="#22c55e",e.strokeStyle="#ffffff",e.fill(),e.stroke()):(e.fillStyle="#ffffff",e.strokeStyle="#000000",e.fillRect(o.x-s/2,o.y-s/2,s,s),e.strokeRect(o.x-s/2,o.y-s/2,s,s));e.restore()}else if(i instanceof k){const a=i.getHandles();e.save();for(const o of a)e.fillStyle="#ffffff",e.strokeStyle="#000000",e.fillRect(o.x-s/2,o.y-s/2,s,s),e.strokeRect(o.x-s/2,o.y-s/2,s,s);e.restore()}}}isPointOnRectEdge(e,i,n,s){const{x:a,y:o,w:r,h:p}=n,g=e>=a-s&&e<=a+r+s,S=i>=o-s&&i<=o+p+s;return!!(g&&(Math.abs(i-o)<=s||Math.abs(i-(o+p))<=s)||S&&(Math.abs(e-a)<=s||Math.abs(e-(a+r))<=s))}captureState(e){const i={x:e.x,y:e.y,rotation:e.rotation};return e.width!==void 0&&(i.width=e.width),e.height!==void 0&&(i.height=e.height),e.radiusX!==void 0&&(i.radiusX=e.radiusX),e.radiusY!==void 0&&(i.radiusY=e.radiusY),e.endX!==void 0&&(i.endX=e.endX),e.endY!==void 0&&(i.endY=e.endY),e.points!==void 0&&(i.points=JSON.parse(JSON.stringify(e.points))),i}}class Me extends G{constructor(){super(...arguments);c(this,"team","A");c(this,"color","#ef4444");c(this,"quantity",1)}setTeam(e){this.team=e}setColor(e){this.color=e}setQuantity(e){this.quantity=Math.max(1,e)}getTeam(){return this.team}getColor(){return this.color}getQuantity(){return this.quantity}onMouseDown(e){const i=this.getWorldPoint(e);for(let n=0;n<this.quantity;n++){const s=n*15,a=(this.game.entities.filter(r=>r instanceof I).length+1).toString(),o=new I(i.x+s,i.y+s,a,this.color);o.team=this.team,this.game.commandManager.execute(new ee(this.game,o))}}onMouseMove(e){}onMouseUp(e){}}class Ce extends G{constructor(){super(...arguments);c(this,"isPanning",!1);c(this,"lastMouseX",0);c(this,"lastMouseY",0);c(this,"_isPanEnabled",!1)}get isPanEnabled(){return this._isPanEnabled}setPanEnabled(e){this._isPanEnabled=e,e||(this.isPanning=!1)}onMouseDown(e){this._isPanEnabled&&(this.isPanning=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY)}onMouseMove(e){if(this.isPanning){const i=e.clientX-this.lastMouseX,n=e.clientY-this.lastMouseY;this.game.camera.pan(i,n),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY}}onMouseUp(e){this.isPanning=!1}deactivate(){this.isPanning=!1}}class ze extends G{constructor(){super(...arguments);c(this,"isDrawing",!1);c(this,"drawStartPos",null);c(this,"tempShape",null);c(this,"currentShapeType","line")}setShapeType(e){this.currentShapeType=e}onMouseDown(e){const i=this.getWorldPoint(e);switch(this.isDrawing=!0,this.drawStartPos={x:i.x,y:i.y},this.currentShapeType){case"rectangle":this.tempShape=new oe(i.x,i.y);break;case"circle":this.tempShape=new ae(i.x,i.y);break;case"triangle":this.tempShape=new se(i.x,i.y),this.tempShape.points=[{x:0,y:0},{x:0,y:0},{x:0,y:0}];break;case"line":this.tempShape=new K(i.x,i.y);break;case"freehand":this.tempShape=new ne(i.x,i.y),this.tempShape.points.push({x:0,y:0});break}}onMouseMove(e){if(!this.isDrawing||!this.tempShape||!this.drawStartPos)return;const i=this.getWorldPoint(e),n=i.x-this.drawStartPos.x,s=i.y-this.drawStartPos.y;if(this.tempShape instanceof oe)this.tempShape.width=Math.abs(n),this.tempShape.height=Math.abs(s),this.tempShape.x=this.drawStartPos.x+n/2,this.tempShape.y=this.drawStartPos.y+s/2;else if(this.tempShape instanceof ae){const a=n/2,o=s/2;this.tempShape.x=this.drawStartPos.x+a,this.tempShape.y=this.drawStartPos.y+o,this.tempShape.radiusX=Math.abs(a),this.tempShape.radiusY=Math.abs(o)}else if(this.tempShape instanceof se){const a=n/2,o=s/2;this.tempShape.x=this.drawStartPos.x+a,this.tempShape.y=this.drawStartPos.y+o,this.tempShape.points=[{x:0,y:-o},{x:a,y:o},{x:-a,y:o}]}else this.tempShape instanceof K?(this.tempShape.endX=n,this.tempShape.endY=s):this.tempShape instanceof ne&&this.tempShape.points.push({x:n,y:s})}onMouseUp(e){if(this.isDrawing&&this.tempShape){let i=!0;if(this.tempShape instanceof oe&&(this.tempShape.width<1||this.tempShape.height<1)&&(i=!1),this.tempShape instanceof ae&&(this.tempShape.radiusX<1||this.tempShape.radiusY<1)&&(i=!1),this.tempShape instanceof K&&this.tempShape.endX===0&&this.tempShape.endY===0&&(i=!1),this.tempShape instanceof se){const n=this.tempShape.points,s=Math.min(...n.map(o=>o.x));Math.max(...n.map(o=>o.x))-s<1&&(i=!1)}i&&(this.game.commandManager.execute(new ee(this.game,this.tempShape)),this.game.selectEntity(this.tempShape)),this.tempShape=null,this.isDrawing=!1,this.game.setTool("select")}}render(e){this.isDrawing&&this.tempShape&&this.tempShape.draw(e)}}class ke extends G{constructor(){super(...arguments);c(this,"currentPlayer",null);c(this,"actionType","run");c(this,"lineType","straight");c(this,"isDrawing",!1);c(this,"tempAction",null)}setContext(e,i,n){this.currentPlayer=e,this.actionType=i,this.lineType=n}onMouseDown(e){if(!this.currentPlayer)return;const i=this.getWorldPoint(e);let n=this.currentPlayer.x,s=this.currentPlayer.y;if(this.currentPlayer.actions.length>0){const p=this.currentPlayer.actions[this.currentPlayer.actions.length-1].getFinalPosition();n=p.x,s=p.y}if(this.actionType==="turn"||this.actionType==="tackle"){let r;this.actionType==="turn"?r=new le(n,s,n,s):r=new ce(n,s,n,s),r.sceneIndex=this.game.currentScene,this.game.commandManager.execute(new ge(this.currentPlayer,r)),this.game.selectEntity(this.currentPlayer),this.game.setTool("select");return}const a=this.lineType==="straight"?i.x:n,o=this.lineType==="straight"?i.y:s;switch(this.actionType){case"run":this.tempAction=new re(n,s,a,o);break;case"pass":this.tempAction=new ie(n,s,a,o);break;case"dribble":this.tempAction=new Q(n,s,a,o);break;case"shoot":this.tempAction=new te(n,s,a,o);break;default:this.tempAction=new re(n,s,a,o)}this.tempAction.pathType=this.lineType,this.tempAction.owner=this.currentPlayer,this.tempAction.sceneIndex=this.game.currentScene,this.lineType==="freehand"&&(this.tempAction.points=[{x:n,y:s}]),this.isDrawing=!0}onMouseMove(e){if(this.isDrawing&&this.tempAction){const i=this.getWorldPoint(e);this.lineType==="straight"?(this.tempAction.endX=i.x,this.tempAction.endY=i.y):(this.tempAction.points.push(i),this.tempAction.endX=i.x,this.tempAction.endY=i.y)}}onMouseUp(e){this.isDrawing&&this.tempAction&&this.currentPlayer&&(this.game.commandManager.execute(new ge(this.currentPlayer,this.tempAction)),this.game.selectEntity(this.currentPlayer),this.game.setTool("select")),this.isDrawing=!1,this.tempAction=null}render(e){this.isDrawing&&this.tempAction&&this.tempAction.draw(e)}}class Re extends G{constructor(){super(...arguments);c(this,"objectType","cone");c(this,"coneShape","single");c(this,"isDragging",!1);c(this,"tempEntity",null);c(this,"dragStart",{x:0,y:0})}setObjectType(e){this.objectType=e,e==="cone"&&(this.coneShape="single")}setConeShape(e){this.coneShape=e}getObjectType(){return this.objectType}getConeShape(){return this.coneShape}onMouseDown(e){const i=this.getWorldPoint(e);if(this.dragStart={x:i.x,y:i.y},this.objectType==="ball"){const n=new W(i.x,i.y);this.game.commandManager.execute(new ee(this.game,n)),this.game.selectEntity(n),this.game.setTool("select");return}if(this.objectType==="goal"){this.isDragging=!0,this.tempEntity=new j(i.x,i.y),this.tempEntity.width=0,this.tempEntity.height=0;return}if(this.objectType==="cone"){if(this.coneShape==="single"){const n=new J(i.x,i.y);this.game.commandManager.execute(new ee(this.game,n)),this.game.selectEntity(n),this.game.setTool("select");return}this.isDragging=!0,this.tempEntity=new q(this.coneShape,i.x,i.y),this.coneShape==="freehand"?this.tempEntity.points=[{x:0,y:0}]:this.coneShape==="triangle"&&(this.tempEntity.points=[{x:0,y:0},{x:0,y:0},{x:0,y:0}])}}onMouseMove(e){if(!this.isDragging||!this.tempEntity)return;const i=this.getWorldPoint(e),n=this.dragStart.x,s=this.dragStart.y;if(this.tempEntity instanceof j)this.tempEntity.width=Math.abs(i.x-n),this.tempEntity.height=Math.abs(i.y-s),this.tempEntity.x=(n+i.x)/2,this.tempEntity.y=(s+i.y)/2;else if(this.tempEntity instanceof q){if(this.tempEntity.shapeType==="line")this.tempEntity.endX=i.x-n,this.tempEntity.endY=i.y-s;else if(this.tempEntity.shapeType==="rectangle")this.tempEntity.width=Math.abs(i.x-n),this.tempEntity.height=Math.abs(i.y-s),this.tempEntity.x=(n+i.x)/2,this.tempEntity.y=(s+i.y)/2;else if(this.tempEntity.shapeType==="ellipse")this.tempEntity.radiusX=Math.abs(i.x-n)/2,this.tempEntity.radiusY=Math.abs(i.y-s)/2,this.tempEntity.x=(n+i.x)/2,this.tempEntity.y=(s+i.y)/2;else if(this.tempEntity.shapeType==="triangle"){const a=i.x-n,o=i.y-s;this.tempEntity.x=n+a/2,this.tempEntity.y=s+o/2,this.tempEntity.points=[{x:0,y:-o/2},{x:a/2,y:o/2},{x:-a/2,y:o/2}]}else if(this.tempEntity.shapeType==="freehand"){const a=i.x-this.tempEntity.x,o=i.y-this.tempEntity.y;this.tempEntity.points.push({x:a,y:o})}}}onMouseUp(e){if(this.isDragging&&this.tempEntity){let i=0,n=0,s=!1;this.tempEntity instanceof j?(i=this.tempEntity.width,n=this.tempEntity.height,s=i>5||n>5):this.tempEntity instanceof q&&(i=this.tempEntity.width||Math.abs(this.tempEntity.endX)||10,n=this.tempEntity.height||Math.abs(this.tempEntity.endY)||10,s=i>5||n>5||this.tempEntity.points.length>2),s&&(this.game.commandManager.execute(new ee(this.game,this.tempEntity)),this.game.selectEntity(this.tempEntity)),this.game.setTool("select")}this.isDragging=!1,this.tempEntity=null}render(e){this.isDragging&&this.tempEntity&&this.tempEntity.draw(e)}}class Xe{constructor(t,e,i){c(this,"canvas");c(this,"ctx");c(this,"camera");c(this,"field");c(this,"commandManager");c(this,"animationManager");c(this,"entities",[]);c(this,"selectedEntity",null);c(this,"currentScene",0);c(this,"sceneCount",1);c(this,"currentMode","edit");c(this,"currentToolId","select");c(this,"tools",new Map);c(this,"currentActionType","run");c(this,"currentActionLineType","straight");c(this,"useAIOptimization",!1);c(this,"zoneConfig");c(this,"_zoneSelected",!1);c(this,"_zoneEditEnabled",!1);c(this,"activePointerId",null);c(this,"pinchPointers",new Map);c(this,"pinchInitialDistance",0);c(this,"pinchInitialZoom",1);c(this,"loadPromise",null);c(this,"exerciseId");c(this,"exerciseStorage");c(this,"exerciseMetadata",{title:"Sin título"});c(this,"lastTime",0);this.zoneConfig=e,this.exerciseId=i||me.generateId(),this.exerciseStorage=new me;const n=document.getElementById(t);if(!n)throw new Error("Canvas not found");this.canvas=n,this.ctx=n.getContext("2d"),this.camera=new xe(0,0),this.field=new Se,this.commandManager=new Ie,this.animationManager=new we,this.commandManager.onChange=()=>{this.exerciseStorage.scheduleAutoSave(this.exerciseId,this.getGameSnapshot(),this.exerciseMetadata)},this.tools.set("select",new Ae(this)),this.tools.set("player",new Me(this)),this.tools.set("camera",new Ce(this)),this.tools.set("shape",new ze(this)),this.tools.set("action",new ke(this)),this.tools.set("exercise",new Re(this)),this.setupUI(),this.setupEvents(),this.resize(),this.setTool("select"),window.addEventListener("resize",()=>this.resize()),i?this.loadPromise=this.loadExercise(i):this.loadPromise=Promise.resolve()}addEntity(t){this.entities.push(t)}removeEntity(t){const e=this.entities.indexOf(t);e>-1&&this.entities.splice(e,1),this.selectedEntity===t&&this.selectEntity(null)}selectEntity(t){this.selectedEntity&&(this.selectedEntity.isSelected=!1),this.selectedEntity=t,this.selectedEntity&&(this.selectedEntity.isSelected=!0),t&&(this._zoneSelected=!1),this.currentMode==="edit"&&this.updateSelectionUI()}getSelectedEntity(){return this.selectedEntity}hasZone(){return!!this.zoneConfig&&this.zoneConfig.preset!=="full"}isZoneSelected(){return this._zoneSelected}isZoneEditing(){return this._zoneSelected&&this._zoneEditEnabled}selectZone(){this.selectedEntity&&(this.selectedEntity.isSelected=!1,this.selectedEntity=null),this._zoneSelected=!0,this.currentMode==="edit"&&this.updateSelectionUI()}deselectZone(){this._zoneSelected=!1,this._zoneEditEnabled=!1,this.currentMode==="edit"&&this.updateSelectionUI()}getZoneRect(){return!this.zoneConfig||this.zoneConfig.preset==="full"?null:{...this.zoneConfig.zone}}setZoneRect(t){this.zoneConfig&&(this.zoneConfig.zone={...t})}getZoneHandles(){const t=this.getZoneRect();return t?[{id:"nw",x:t.x,y:t.y},{id:"ne",x:t.x+t.w,y:t.y},{id:"sw",x:t.x,y:t.y+t.h},{id:"se",x:t.x+t.w,y:t.y+t.h}]:[]}setTool(t){var i,n,s;this.currentToolId&&((i=this.tools.get(this.currentToolId))==null||i.deactivate()),this.currentToolId=t,(n=this.tools.get(t))==null||n.activate(),document.querySelectorAll(".tool-btn").forEach(a=>a.classList.remove("active"));let e="";t==="select"&&(e="tool-select"),t==="player"&&(e="tool-player"),t==="camera"&&(e="tool-camera"),t==="shape"&&(e="tool-shape"),t==="exercise"&&(e="tool-exercise"),e&&((s=document.getElementById(e))==null||s.classList.add("active")),(t==="camera"||t==="shape"||t==="exercise")&&this.selectEntity(null),this.updatePropertiesPanel(t)}activateActionTool(t){this.setTool("action");const e=this.tools.get("action");e&&e.setContext(t,this.currentActionType,this.currentActionLineType),this.updatePropertiesPanel("action")}setupEvents(){this.canvas.addEventListener("wheel",t=>{t.preventDefault();const e=t.deltaY>0?.9:1.1;this.camera.zoomAt(e,t.clientX,t.clientY,this.canvas)},{passive:!1}),this.canvas.addEventListener("pointerdown",t=>{var i;if(t.preventDefault(),t.target!==this.canvas)return;if(t.pointerType==="touch"&&(this.pinchPointers.set(t.pointerId,{clientX:t.clientX,clientY:t.clientY}),this.pinchPointers.size===2)){this.startPinch(t);return}this.pinchPointers.size>=2||(this.activePointerId=t.pointerId,this.canvas.setPointerCapture(t.pointerId),(i=this.tools.get(this.currentToolId))==null||i.onMouseDown(t))}),this.canvas.addEventListener("pointermove",t=>{var e;if(t.target===this.canvas){if(this.pinchPointers.size===2){this.updatePinch(t);return}this.activePointerId===t.pointerId?(t.pointerType==="touch"&&this.pinchPointers.set(t.pointerId,{clientX:t.clientX,clientY:t.clientY}),(e=this.tools.get(this.currentToolId))==null||e.onMouseMove(t)):t.pointerType==="touch"&&this.pinchPointers.has(t.pointerId)&&this.pinchPointers.set(t.pointerId,{clientX:t.clientX,clientY:t.clientY})}}),this.canvas.addEventListener("pointerup",t=>{var e;t.pointerType==="touch"&&(this.pinchPointers.delete(t.pointerId),this.pinchPointers.size<2&&this.endPinch()),this.activePointerId===t.pointerId&&(this.activePointerId=null,(e=this.tools.get(this.currentToolId))==null||e.onMouseUp(t))}),this.canvas.addEventListener("pointercancel",t=>{var e;this.pinchPointers.delete(t.pointerId),this.pinchPointers.size<2&&this.endPinch(),this.activePointerId===t.pointerId&&(this.activePointerId=null,(e=this.tools.get(this.currentToolId))==null||e.onMouseUp(t))}),window.addEventListener("keydown",t=>{const e=t.target;if(!(e.tagName==="INPUT"||e.tagName==="TEXTAREA")){if(this.currentMode==="play"){t.key.toLowerCase()==="r"&&this.camera.toggleRotation();return}(t.key==="Delete"||t.key==="Backspace")&&this.deleteSelected(),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="z"&&this.commandManager.undo(),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="y"&&this.commandManager.redo(),t.key.toLowerCase()==="v"&&this.setTool("select"),t.key.toLowerCase()==="p"&&this.setTool("player"),t.key.toLowerCase()==="c"&&this.setTool("camera"),t.key.toLowerCase()==="s"&&this.setTool("shape"),t.key.toLowerCase()==="o"&&this.setTool("exercise"),t.key.toLowerCase()==="r"&&this.camera.toggleRotation()}})}pinchDistance(){const t=[...this.pinchPointers.entries()];if(t.length<2)return 0;const[e,i]=t;return Math.hypot(e[1].clientX-i[1].clientX,e[1].clientY-i[1].clientY)||1}pinchCenter(){const t=[...this.pinchPointers.values()],e=t.length;if(e===0)return{clientX:0,clientY:0};const i=t.reduce((s,a)=>s+a.clientX,0),n=t.reduce((s,a)=>s+a.clientY,0);return{clientX:i/e,clientY:n/e}}startPinch(t){var i;const e=[...this.pinchPointers.keys()].find(n=>n!==t.pointerId);if(e!=null&&this.activePointerId===e){const n=this.pinchPointers.get(e),s=new PointerEvent("pointerup",{pointerId:e,clientX:n.clientX,clientY:n.clientY});(i=this.tools.get(this.currentToolId))==null||i.onMouseUp(s),this.activePointerId=null}this.pinchInitialDistance=this.pinchDistance(),this.pinchInitialZoom=this.camera.zoom}updatePinch(t){this.pinchPointers.set(t.pointerId,{clientX:t.clientX,clientY:t.clientY});const e=this.pinchDistance();if(this.pinchInitialDistance<=0)return;const i=e/this.pinchInitialDistance,s=Math.max(.1,Math.min(5,this.pinchInitialZoom*i))/this.camera.zoom,a=this.pinchCenter();this.camera.zoomAt(s,a.clientX,a.clientY,this.canvas)}endPinch(){this.pinchInitialDistance=0,this.pinchInitialZoom=1}setMode(t){this.currentMode=t;const e=document.getElementById("btn-mode-edit"),i=document.getElementById("btn-mode-play"),n=document.getElementById("edit-tools-panel"),s=document.getElementById("play-tools-panel");if(t==="edit"){this.animationManager.stop(),this.updateSceneState(),e==null||e.classList.add("active"),i==null||i.classList.remove("active"),n==null||n.classList.remove("hidden"),s==null||s.classList.add("hidden");const a=document.getElementById("section-scenes");a&&(a.style.display="flex"),this.setTool("select"),this.updateSelectionUI()}else{e==null||e.classList.remove("active"),i==null||i.classList.add("active"),n==null||n.classList.add("hidden"),s==null||s.classList.remove("hidden");const a=document.getElementById("section-scenes");a&&(a.style.display="none"),this.selectEntity(null),this.updatePropertiesPanel(null),this.setTool("camera"),this.tools.get("camera").setPanEnabled(!0)}}setupUI(){var M,C,L,R,D,F,$,_,O,X,Y,H,N,U;(M=document.getElementById("btn-mode-edit"))==null||M.addEventListener("click",()=>this.setMode("edit")),(C=document.getElementById("btn-mode-play"))==null||C.addEventListener("click",()=>this.setMode("play")),(L=document.getElementById("btn-save"))==null||L.addEventListener("click",()=>{this.saveAndNavigate()});const t=document.querySelector(".section-modes");if(t){const l=document.createElement("div");l.className="separator-vertical",t.after(l);const h=document.createElement("div");h.id="section-scenes",h.className="toolbar-section section-modes",h.style.flexDirection="column",h.style.gap="5px",h.style.minWidth="100px",h.innerHTML=`
            <div style="font-size: 0.7rem; color: #888; text-transform: uppercase;">Escena</div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <button class="mode-btn" id="scene-prev" style="width: 24px; height: 24px; font-size: 12px;"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="scene-display" style="font-weight: bold; min-width: 20px; text-align: center; font-size: 1.1rem;">1</span>
                <button class="mode-btn" id="scene-next" style="width: 24px; height: 24px; font-size: 12px;"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <button class="prop-btn" id="scene-add" style="padding: 2px 8px; font-size: 0.75rem; width: 100%; justify-content: center; height: 24px;"><i class="fa-solid fa-plus"></i> Nueva</button>
            <button class="prop-btn danger" id="scene-delete" style="padding: 2px 8px; font-size: 0.75rem; width: 100%; justify-content: center; height: 24px; display: none;"><i class="fa-solid fa-trash"></i> Eliminar</button>
        `,l.after(h),(R=document.getElementById("scene-prev"))==null||R.addEventListener("click",()=>this.setScene(this.currentScene-1)),(D=document.getElementById("scene-next"))==null||D.addEventListener("click",()=>this.setScene(this.currentScene+1)),(F=document.getElementById("scene-add"))==null||F.addEventListener("click",()=>{this.sceneCount++,this.setScene(this.sceneCount-1)}),($=document.getElementById("scene-delete"))==null||$.addEventListener("click",()=>this.deleteScene())}(_=document.getElementById("tool-select"))==null||_.addEventListener("click",()=>this.setTool("select")),(O=document.getElementById("tool-player"))==null||O.addEventListener("click",()=>this.setTool("player")),(X=document.getElementById("tool-camera"))==null||X.addEventListener("click",()=>this.setTool("camera")),(Y=document.getElementById("tool-shape"))==null||Y.addEventListener("click",()=>this.setTool("shape")),(H=document.getElementById("tool-exercise"))==null||H.addEventListener("click",()=>this.setTool("exercise")),(N=document.getElementById("action-undo"))==null||N.addEventListener("click",()=>this.commandManager.undo()),(U=document.getElementById("action-redo"))==null||U.addEventListener("click",()=>this.commandManager.redo());const e=document.getElementById("secondary-menu"),i=document.getElementById("btn-collapse-menu"),n=document.getElementById("btn-open-menu"),s=(l=!1)=>{l?(e==null||e.classList.remove("collapsed"),n==null||n.classList.add("hidden")):(e==null||e.classList.toggle("collapsed"),e!=null&&e.classList.contains("collapsed")?n==null||n.classList.remove("hidden"):n==null||n.classList.add("hidden"))};i==null||i.addEventListener("click",()=>s()),n==null||n.addEventListener("click",()=>s());const a=document.getElementById("main-toolbar"),o=document.getElementById("toolbar-collapse-btn");o==null||o.addEventListener("click",()=>{a==null||a.classList.toggle("collapsed");const l=a==null?void 0:a.classList.contains("collapsed");o.setAttribute("aria-label",l?"Expandir menú":"Colapsar menú"),o.title=l?"Expandir menú":"Colapsar menú"});const r=document.getElementById("btn-close-props-panel");r==null||r.addEventListener("click",()=>this.closePropsPanel());const p=document.getElementById("anim-play"),g=document.getElementById("anim-stop"),S=document.getElementById("anim-speed"),B=document.getElementById("anim-speed-val"),T=document.getElementById("play-tools-panel");if(T){const l=document.createElement("div");l.className="menu-control-group checkbox-wrapper",l.style.margin="0 10px",l.style.background="rgba(0,0,0,0.2)",l.style.padding="4px 8px",l.style.borderRadius="4px",l.innerHTML=`
            <input type="checkbox" id="ai-opt-toggle">
            <label class="menu-label" for="ai-opt-toggle" style="cursor:pointer; color: #a855f7; font-weight: bold;">
                <i class="fa-solid fa-wand-magic-sparkles"></i> AI Opt
            </label>
        `,T.insertBefore(l,T.firstChild),l.querySelector("#ai-opt-toggle").addEventListener("change",d=>{this.useAIOptimization=d.target.checked})}p==null||p.addEventListener("click",async()=>{var h;this.animationManager.isPlaying?this.animationManager.pause():((((h=document.getElementById("ai-opt-toggle"))==null?void 0:h.checked)??this.useAIOptimization)&&await this.optimizeDrill(),this.animationManager.play(this.currentScene,this.entities));const l=p.querySelector("i");this.animationManager.isPlaying&&!this.animationManager.isPaused?l==null||l.classList.replace("fa-play","fa-pause"):l==null||l.classList.replace("fa-pause","fa-play")}),g==null||g.addEventListener("click",()=>{this.animationManager.stop();const l=p==null?void 0:p.querySelector("i");l==null||l.classList.replace("fa-pause","fa-play")}),S==null||S.addEventListener("input",l=>{const h=parseFloat(l.target.value);this.animationManager.setSpeed(h),B&&(B.textContent=h.toFixed(1)+"x")})}setScene(t){t<0||t>=this.sceneCount||(this.currentScene=t,this.updateSceneState())}updateSceneState(){const t=document.getElementById("scene-display");t&&(t.textContent=(this.currentScene+1).toString()),this.updateSceneButtons(),this.entities.forEach(e=>{e instanceof I&&e.updateForScene(this.currentScene)}),this.selectEntity(null)}updateSceneButtons(){const t=document.getElementById("scene-delete");if(t){const e=this.sceneCount>1&&this.currentScene===this.sceneCount-1;t.style.display=e?"":"none"}}deleteScene(){if(this.sceneCount<=1||this.currentScene!==this.sceneCount-1)return;const t=this.currentScene+1;this.showConfirmDialog(`¿Eliminar Escena ${t}?`,"Se eliminará todo lo correspondiente a esta escena (acciones, movimientos, etc.). Esta acción no se puede deshacer.",()=>{const e=this.currentScene;this.entities.forEach(i=>{i instanceof I&&(i.actions=i.actions.filter(n=>n.sceneIndex!==e))}),this.sceneCount--,this.setScene(e-1)})}showConfirmDialog(t,e,i){var s,a,o;(s=document.getElementById("confirm-dialog-overlay"))==null||s.remove();const n=document.createElement("div");n.id="confirm-dialog-overlay",n.className="confirm-dialog-overlay",n.innerHTML=`
            <div class="confirm-dialog">
                <div class="confirm-dialog-title">${t}</div>
                <div class="confirm-dialog-message">${e}</div>
                <div class="confirm-dialog-actions">
                    <button class="confirm-dialog-btn cancel" id="confirm-cancel">Cancelar</button>
                    <button class="confirm-dialog-btn confirm" id="confirm-ok">Eliminar</button>
                </div>
            </div>
        `,document.body.appendChild(n),(a=document.getElementById("confirm-cancel"))==null||a.addEventListener("click",()=>n.remove()),(o=document.getElementById("confirm-ok"))==null||o.addEventListener("click",()=>{n.remove(),i()}),n.addEventListener("click",r=>{r.target===n&&n.remove()})}isMobileView(){return window.matchMedia("(max-width: 743px)").matches||window.matchMedia("(max-height: 743px)").matches}openPropsPanel(t){const e=document.getElementById("properties-side-panel"),i=document.getElementById("props-panel-title");e&&e.classList.remove("collapsed"),i&&(i.textContent=t)}closePropsPanel(){const t=document.getElementById("properties-side-panel");t&&t.classList.add("collapsed")}setupAccordionListeners(t){t.querySelectorAll(".accordion-header").forEach(e=>{e.addEventListener("click",()=>{const i=e.closest(".accordion-section");i==null||i.classList.toggle("open")})})}wrapInAccordion(t,e,i=!1){return`
            <div class="accordion-section${i?" open":""}">
                <button class="accordion-header">
                    <span>${t}</span>
                    <i class="fa-solid fa-chevron-down accordion-chevron"></i>
                </button>
                <div class="accordion-body">${e}</div>
            </div>
        `}updatePropertiesPanel(t){var a,o,r,p,g,S,B,T,M,C,L,R,D,F,$,_,O,X,Y,H,N,U,l,h;const e=document.getElementById("properties-panel");if(!e)return;e.innerHTML="";const i=document.getElementById("props-panel-content");if(i&&(i.innerHTML=""),this.currentMode==="play"){e.innerHTML='<span class="placeholder-text-small">Modo Reproducción</span>',this.closePropsPanel();return}if(!t){this.closePropsPanel();return}const n=this.isMobileView(),s=n?i:e;if(t==="exercise"){const d=this.tools.get("exercise"),m=d.getObjectType(),u=d.getConeShape();let y=`
             <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                 <button class="prop-btn ${m==="cone"?"active-prop":""}" id="ex-cone" title="Cono"><i class="fa-solid fa-traffic-cone"></i></button>
                 <button class="prop-btn ${m==="ball"?"active-prop":""}" id="ex-ball" title="Bocha"><i class="fa-solid fa-circle"></i></button>
                 <button class="prop-btn ${m==="goal"?"active-prop":""}" id="ex-goal" title="Arco"><i class="fa-regular fa-futbol"></i></button>
             </div>
          `;if(m==="cone"&&(y+=`
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                     <button class="prop-btn ${u==="single"?"active-prop":""}" id="ex-shape-single" title="Simple"><i class="fa-solid fa-stop"></i></button>
                     <button class="prop-btn ${u==="line"?"active-prop":""}" id="ex-shape-line" title="Línea"><i class="fa-solid fa-slash"></i></button>
                     <button class="prop-btn ${u==="freehand"?"active-prop":""}" id="ex-shape-free" title="Libre"><i class="fa-solid fa-pencil"></i></button>
                     <button class="prop-btn ${u==="rectangle"?"active-prop":""}" id="ex-shape-rect" title="Rectángulo"><i class="fa-regular fa-square"></i></button>
                     <button class="prop-btn ${u==="ellipse"?"active-prop":""}" id="ex-shape-circle" title="Círculo"><i class="fa-regular fa-circle"></i></button>
                     <button class="prop-btn ${u==="triangle"?"active-prop":""}" id="ex-shape-tri" title="Triángulo"><i class="fa-solid fa-play fa-rotate-270"></i></button>
                </div>
             `),s.innerHTML=y,n&&this.openPropsPanel("Objetos"),(a=document.getElementById("ex-cone"))==null||a.addEventListener("click",()=>{d.setObjectType("cone"),this.updatePropertiesPanel("exercise")}),(o=document.getElementById("ex-ball"))==null||o.addEventListener("click",()=>{d.setObjectType("ball"),this.updatePropertiesPanel("exercise")}),(r=document.getElementById("ex-goal"))==null||r.addEventListener("click",()=>{d.setObjectType("goal"),this.updatePropertiesPanel("exercise")}),m==="cone"){const E=x=>{d.setConeShape(x),this.updatePropertiesPanel("exercise")};(p=document.getElementById("ex-shape-single"))==null||p.addEventListener("click",()=>E("single")),(g=document.getElementById("ex-shape-line"))==null||g.addEventListener("click",()=>E("line")),(S=document.getElementById("ex-shape-free"))==null||S.addEventListener("click",()=>E("freehand")),(B=document.getElementById("ex-shape-rect"))==null||B.addEventListener("click",()=>E("rectangle")),(T=document.getElementById("ex-shape-circle"))==null||T.addEventListener("click",()=>E("ellipse")),(M=document.getElementById("ex-shape-tri"))==null||M.addEventListener("click",()=>E("triangle"))}return}if(t==="action"){this.selectedEntity instanceof I?(this.renderPlayerActionUI(s,this.selectedEntity),n&&this.openPropsPanel("Acciones")):s.innerHTML='<span class="placeholder-text-small">Dibujando Acción...</span>';return}if(t==="shape"){const d=this.tools.get("shape");s.innerHTML=`
             <div style="display: flex; gap: 5px; flex-wrap: wrap;">
               <button class="prop-btn" id="shape-line" title="Línea"><i class="fa-solid fa-slash"></i></button>
               <button class="prop-btn" id="shape-free" title="Libre"><i class="fa-solid fa-pencil"></i></button>
               <button class="prop-btn" id="shape-rect" title="Rectángulo"><i class="fa-regular fa-square"></i></button>
               <button class="prop-btn" id="shape-circle" title="Círculo/Óvalo"><i class="fa-regular fa-circle"></i></button>
               <button class="prop-btn" id="shape-tri" title="Triángulo"><i class="fa-solid fa-play fa-rotate-270"></i></button>
             </div>
          `,n&&this.openPropsPanel("Formas");const m=u=>{var y;s.querySelectorAll(".prop-btn").forEach(E=>E.classList.remove("active-prop")),(y=document.getElementById(u))==null||y.classList.add("active-prop")};m("shape-line"),(C=document.getElementById("shape-line"))==null||C.addEventListener("click",()=>{d.setShapeType("line"),m("shape-line")}),(L=document.getElementById("shape-free"))==null||L.addEventListener("click",()=>{d.setShapeType("freehand"),m("shape-free")}),(R=document.getElementById("shape-rect"))==null||R.addEventListener("click",()=>{d.setShapeType("rectangle"),m("shape-rect")}),(D=document.getElementById("shape-circle"))==null||D.addEventListener("click",()=>{d.setShapeType("circle"),m("shape-circle")}),(F=document.getElementById("shape-tri"))==null||F.addEventListener("click",()=>{d.setShapeType("triangle"),m("shape-tri")})}else if(t==="camera"){const d=this.tools.get("camera");s.innerHTML=`
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
              <button class="prop-btn" id="cam-pan-toggle" title="Activar Paneo"><i class="fa-solid fa-hand"></i> Paneo</button>
              <button class="prop-btn" id="cam-zoom-out" title="Alejar"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
              <button class="prop-btn" id="cam-zoom-in" title="Acercar"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
              <button class="prop-btn" id="cam-rotate" title="Rotar Vista"><i class="fa-solid fa-rotate"></i> Rotar</button>
              <button class="prop-btn" id="cam-reset" title="Centrar"><i class="fa-solid fa-compress"></i></button>
            </div>
          `,n&&this.openPropsPanel("Cámara");const m=document.getElementById("cam-pan-toggle");if(m){const u=()=>{d.isPanEnabled?m.classList.add("active-prop"):m.classList.remove("active-prop")};u(),m.addEventListener("click",()=>{d.setPanEnabled(!d.isPanEnabled),u()})}($=document.getElementById("cam-zoom-in"))==null||$.addEventListener("click",()=>this.camera.zoomAt(1.2,this.canvas.width/2,this.canvas.height/2,this.canvas)),(_=document.getElementById("cam-zoom-out"))==null||_.addEventListener("click",()=>this.camera.zoomAt(.8,this.canvas.width/2,this.canvas.height/2,this.canvas)),(O=document.getElementById("cam-rotate"))==null||O.addEventListener("click",()=>this.camera.toggleRotation()),(X=document.getElementById("cam-reset"))==null||X.addEventListener("click",()=>{this.camera.x=0,this.camera.y=0})}else if(t==="player"){const d=this.tools.get("player"),m=d.getTeam(),u=d.getColor(),y=d.getQuantity(),E=["#FFB3BA","#FFDFBA","#FFFFBA","#BAFFC9","#BAE1FF","#E2C9FF","#FFFFFF","#000000","#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#a855f7"];let x='<div class="color-palette">';if(E.forEach(b=>{x+=`<div class="color-swatch" style="background-color: ${b}" data-color="${b}"></div>`}),x+="</div>",n){const b=`
                    <div class="menu-control-group" style="margin-bottom: 0;">
                        <select id="create-player-team" class="menu-select">
                            <option value="A" ${m==="A"?"selected":""}>Equipo A</option>
                            <option value="B" ${m==="B"?"selected":""}>Equipo B</option>
                        </select>
                    </div>
                `,w=`
                    <div class="menu-control-group" style="margin-bottom: 0;">
                        ${x}
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 6px;">
                            <span style="font-size: 0.8rem; color: #888;">Custom:</span>
                            <input type="color" id="create-player-color" class="menu-input" value="${u}" style="flex: 1; height: 30px;">
                        </div>
                    </div>
                `,z=`
                    <div class="menu-control-group" style="margin-bottom: 0;">
                        <label class="menu-label">Cantidad: <span id="create-player-qty-val">${y}</span></label>
                        <input type="range" id="create-player-qty" class="menu-input" min="1" max="11" step="1" value="${y}">
                    </div>
                `;s.innerHTML=this.wrapInAccordion("Equipo",b,!0)+this.wrapInAccordion("Color",w,!0)+this.wrapInAccordion("Cantidad",z,!0),this.setupAccordionListeners(s),this.openPropsPanel("Crear Jugador")}else s.innerHTML=`
                 <div class="menu-control-group" style="margin-bottom: 0; width: 120px;">
                      <label class="menu-label">Equipo</label>
                      <select id="create-player-team" class="menu-select">
                          <option value="A" ${m==="A"?"selected":""}>Equipo A</option>
                          <option value="B" ${m==="B"?"selected":""}>Equipo B</option>
                      </select>
                 </div>

                 <div class="menu-control-group" style="margin-bottom: 0; min-width: 200px;">
                      <label class="menu-label">Color</label>
                      ${x}
                      <div style="display: flex; align-items: center; gap: 8px;">
                         <span style="font-size: 0.8rem; color: #888;">Personalizado:</span>
                         <input type="color" id="create-player-color" class="menu-input" value="${u}" style="flex: 1; height: 30px;">
                      </div>
                 </div>

                 <div class="menu-control-group" style="margin-bottom: 0; width: 100px;">
                      <label class="menu-label">Cantidad: <span id="create-player-qty-val">${y}</span></label>
                      <input type="range" id="create-player-qty" class="menu-input" min="1" max="11" step="1" value="${y}">
                 </div>
              `;(Y=document.getElementById("create-player-team"))==null||Y.addEventListener("change",b=>{d.setTeam(b.target.value)}),(H=document.getElementById("create-player-qty"))==null||H.addEventListener("input",b=>{const w=parseInt(b.target.value)||1;d.setQuantity(w),document.getElementById("create-player-qty-val").textContent=w.toString()}),s.querySelectorAll(".color-swatch").forEach(b=>{b.addEventListener("click",w=>{const z=w.target.dataset.color;if(z){d.setColor(z);const V=document.getElementById("create-player-color");V&&(V.value=z)}})}),(N=document.getElementById("create-player-color"))==null||N.addEventListener("input",b=>{d.setColor(b.target.value)})}else if(t==="select")if(this.selectedEntity){const d=this.selectedEntity;d instanceof I?(this.renderPlayerActionUI(s,d),n&&this.openPropsPanel("Jugador")):d instanceof Z?(s.innerHTML=`
                     <button class="prop-btn danger" id="prop-delete" title="Eliminar"><i class="fa-solid fa-trash"></i> Eliminar</button>
                  `,n&&this.openPropsPanel("Forma"),(U=document.getElementById("prop-delete"))==null||U.addEventListener("click",()=>this.deleteSelected())):d instanceof k?(s.innerHTML=`
                     <button class="prop-btn danger" id="prop-delete" title="Eliminar"><i class="fa-solid fa-trash"></i> Eliminar</button>
                  `,n&&this.openPropsPanel("Acción"),(l=document.getElementById("prop-delete"))==null||l.addEventListener("click",()=>this.deleteSelected())):(d instanceof J||d instanceof W||d instanceof q)&&(s.innerHTML=`
                     <button class="prop-btn danger" id="prop-delete" title="Eliminar"><i class="fa-solid fa-trash"></i> Eliminar</button>
                  `,n&&this.openPropsPanel("Objeto"),(h=document.getElementById("prop-delete"))==null||h.addEventListener("click",()=>this.deleteSelected()))}else s.innerHTML='<span class="placeholder-text-small">Seleccione un elemento para ver sus propiedades</span>',this.closePropsPanel()}renderPlayerActionUI(t,e){var n;t.innerHTML=`
         <div style="display: flex; flex-direction: column; gap: 8px; width: 100%;">
             <!-- Row 1: Actions -->
             <div class="action-toolbar" style="display: flex; gap: 5px; justify-content: flex-start; flex-wrap: wrap;">
                 <button class="prop-btn action-btn" data-action="run" title="Correr"><i class="fa-solid fa-person-running"></i></button>
                 <button class="prop-btn action-btn" data-action="dribble" title="Conducir"><i class="fa-solid fa-hockey-puck"></i></button>
                 <button class="prop-btn action-btn" data-action="pass" title="Pase"><i class="fa-solid fa-share"></i></button>
                 <button class="prop-btn action-btn" data-action="shoot" title="Tiro"><i class="fa-solid fa-bullseye"></i></button>
                 <button class="prop-btn action-btn" data-action="tackle" title="Quitar"><i class="fa-solid fa-shield-halved"></i></button>
                 <button class="prop-btn action-btn" data-action="turn" title="Girar"><i class="fa-solid fa-rotate"></i></button>
             </div>
             
             <!-- Row 2: Lines & Delete -->
             <div style="display: flex; gap: 10px; align-items: center; justify-content: space-between;">
                 <div style="display: flex; gap: 5px;">
                     <button class="prop-btn line-type-btn" data-type="straight" title="Recta"><i class="fa-solid fa-slash"></i></button>
                     <button class="prop-btn line-type-btn" data-type="freehand" title="Libre"><i class="fa-solid fa-pencil"></i></button>
                 </div>
                 <button class="prop-btn danger" id="prop-delete" title="Eliminar"><i class="fa-solid fa-trash"></i> Eliminar</button>
             </div>
         </div>
      `,(()=>{if(!(this.currentToolId==="action")){t.querySelectorAll(".active-prop").forEach(o=>o.classList.remove("active-prop"));return}const a=this.currentActionType==="turn"||this.currentActionType==="tackle";t.querySelectorAll(".action-btn").forEach(o=>{o.classList.toggle("active-prop",o.dataset.action===this.currentActionType)}),t.querySelectorAll(".line-type-btn").forEach(o=>{const r=o;r.classList.toggle("active-prop",r.dataset.type===this.currentActionLineType),a?(r.style.opacity="0.5",r.style.pointerEvents="none"):(r.style.opacity="1",r.style.pointerEvents="auto")})})(),t.querySelectorAll(".action-btn").forEach(s=>{s.addEventListener("click",a=>{this.currentActionType=a.currentTarget.dataset.action,this.activateActionTool(e)})}),t.querySelectorAll(".line-type-btn").forEach(s=>{s.addEventListener("click",a=>{this.currentActionLineType=a.currentTarget.dataset.type,this.activateActionTool(e)})}),(n=document.getElementById("prop-delete"))==null||n.addEventListener("click",()=>this.deleteSelected())}updateSelectionUI(){this.updatePropertiesPanel(this.currentToolId),this.updateSecondaryMenu();const t=document.getElementById("secondary-menu"),e=document.getElementById("btn-open-menu"),i=window.matchMedia("(max-width: 743px)").matches||window.matchMedia("(max-height: 743px)").matches;(this.selectedEntity||this._zoneSelected)&&!i&&(t==null||t.classList.remove("collapsed"),e==null||e.classList.add("hidden"))}parseEventConfig(t){const e=(t||"").trim().toLowerCase();if(e==="auto")return{mode:"auto"};if(e==="inmediato")return{mode:"inmediato"};if(e.startsWith("esperar:")){const i=parseFloat(e.slice(8));return{mode:"esperar",seconds:isNaN(i)||i<0?1:i}}return{mode:"auto"}}updateSecondaryMenu(){var a,o,r,p,g,S,B,T,M,C,L,R,D,F,$,_,O,X,Y,H,N,U;const t=document.querySelector(".menu-content");if(!t)return;if(!this.selectedEntity){if(this._zoneSelected&&this.zoneConfig){const l=this.zoneConfig.zone;let h=`
                  <div class="menu-control-group">
                      <h3 style="margin:0 0 8px; font-size: 1rem; color: #fb923c;">
                          <i class="fa-solid fa-vector-square" style="margin-right:6px;"></i>Zona del ejercicio
                      </h3>
                      <p style="color:#888; font-size:0.8rem; margin:0 0 12px;">
                          Define el área de trabajo del ejercicio.
                      </p>
                  </div>
                  <div class="menu-control-group checkbox-wrapper">
                      <input type="checkbox" id="zone-edit-toggle" ${this._zoneEditEnabled?"checked":""}>
                      <label class="menu-label" for="zone-edit-toggle">Habilitar edición</label>
                  </div>`;if(this._zoneEditEnabled){const u=(l.w/10).toFixed(1),y=(l.h/10).toFixed(1);h+=`
                    <div class="menu-control-group">
                        <label class="menu-label">Largo (m)</label>
                        <input type="number" id="zone-prop-w" class="menu-input" value="${u}" step="0.5" min="2">
                    </div>
                    <div class="menu-control-group">
                        <label class="menu-label">Ancho (m)</label>
                        <input type="number" id="zone-prop-h" class="menu-input" value="${y}" step="0.5" min="2">
                    </div>`}t.innerHTML=h;const d=document.getElementById("zone-edit-toggle");if(d==null||d.addEventListener("change",()=>{this._zoneEditEnabled=d.checked,this.updateSecondaryMenu()}),this._zoneEditEnabled){const u=(y,E)=>{const x=document.getElementById(y);x==null||x.addEventListener("change",()=>{const b=parseFloat(x.value);!isNaN(b)&&b>=2&&(this.zoneConfig.zone[E]=b*10)})};u("zone-prop-w","w"),u("zone-prop-h","h")}return}t.innerHTML='<p class="placeholder-text">Seleccione un elemento para ver sus propiedades.</p>';return}const e=this.selectedEntity;let i="";const n=["#FFB3BA","#FFDFBA","#FFFFBA","#BAFFC9","#BAE1FF","#E2C9FF","#FFFFFF","#000000","#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#a855f7"];let s='<div class="color-palette">';if(n.forEach(l=>{s+=`<div class="color-swatch" style="background-color: ${l}" data-color="${l}"></div>`}),s+="</div>",e instanceof J)i+=`
              <div class="menu-control-group">
                  <label class="menu-label">Color</label>
                  ${s}
                  <input type="color" id="cone-prop-color" class="menu-input" value="${e.color}">
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Altura: <span id="height-val">${e.height}</span>px</label>
                  <input type="range" id="cone-prop-height" class="menu-input" min="10" max="60" value="${e.height}">
              </div>
           `;else if(e instanceof W)i+=`
              <div class="menu-control-group checkbox-wrapper">
                  <input type="checkbox" id="ball-prop-group" ${e.isGroup?"checked":""}>
                  <label class="menu-label" for="ball-prop-group">Grupo de Bochas</label>
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Color</label>
                  ${s}
                  <input type="color" id="ball-prop-color" class="menu-input" value="${e.color}">
              </div>
           `;else if(e instanceof j)i+=`
              <div class="menu-control-group">
                  <label class="menu-label">Color del Arco</label>
                  ${s}
                  <div style="display: flex; align-items: center; gap: 8px;">
                     <span style="font-size: 0.8rem; color: #888;">Personalizado:</span>
                     <input type="color" id="goal-prop-color" class="menu-input" value="${e.color}" style="flex: 1; height: 30px;">
                  </div>
              </div>
           `;else if(e instanceof q)i+=`
               <div class="menu-control-group checkbox-wrapper">
                  <input type="checkbox" id="group-prop-lines" ${e.showLines?"checked":""}>
                  <label class="menu-label" for="group-prop-lines">Mostrar Líneas</label>
               </div>
           `,e.shapeType==="freehand"&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Suavizado: <span id="group-smooth-val">${e.smoothingFactor}</span></label>
                      <input type="range" id="group-prop-smooth" class="menu-input" min="1" max="20" step="1" value="${e.smoothingFactor}">
                  </div>
               `),i+=`
               <div class="menu-control-group">
                  <label class="menu-label">Distancia: <span id="dist-val">${e.coneDistance}</span>px</label>
                  <input type="range" id="group-prop-dist" class="menu-input" min="20" max="200" step="5" value="${e.coneDistance}">
               </div>
               <div class="menu-control-group">
                  <label class="menu-label">Color del Conjunto</label>
                  ${s}
                  <input type="color" id="group-prop-color" class="menu-input" value="${e.groupColor}">
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Altura Conos: <span id="height-val">${e.groupHeight}</span>px</label>
                  <input type="range" id="group-prop-height" class="menu-input" min="10" max="60" value="${e.groupHeight}">
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Color Cono Seleccionado (#${e.selectedConeIndex})</label>
                  <input type="color" id="group-prop-ind-color" class="menu-input" value="${e.coneColors.get(e.selectedConeIndex)||e.groupColor}">
              </div>
           `;else if(e instanceof Z){const l=e,h=l instanceof K,d=l instanceof ne,m=!h&&!d;i+=`
              <div class="menu-control-group">
                  <label class="menu-label">Color del Trazo</label>
                  ${s}
                  <div style="display: flex; align-items: center; gap: 8px;">
                     <span style="font-size: 0.8rem; color: #888;">Personalizado:</span>
                     <input type="color" id="shape-color" class="menu-input" value="${l.color}" style="flex: 1; height: 30px;">
                  </div>
              </div>

              <div class="menu-control-group">
                  <label class="menu-label">Tipo de Línea</label>
                  <select id="shape-stroke-type" class="menu-select">
                      <option value="solid" ${l.strokeType==="solid"?"selected":""}>Sólida</option>
                      <option value="dashed" ${l.strokeType==="dashed"?"selected":""}>Discontinua (Guiones)</option>
                      <option value="dotted" ${l.strokeType==="dotted"?"selected":""}>Punteada</option>
                  </select>
              </div>
          `,h&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Marcador Inicial</label>
                      <select id="line-start-marker" class="menu-select">
                          <option value="none" ${l.startMarker==="none"?"selected":""}>Ninguno</option>
                          <option value="arrow" ${l.startMarker==="arrow"?"selected":""}>Flecha</option>
                      </select>
                  </div>
                  <div class="menu-control-group">
                      <label class="menu-label">Marcador Final</label>
                      <select id="line-end-marker" class="menu-select">
                          <option value="none" ${l.endMarker==="none"?"selected":""}>Ninguno</option>
                          <option value="arrow" ${l.endMarker==="arrow"?"selected":""}>Flecha</option>
                      </select>
                  </div>
              `),d&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Suavizado: <span id="smooth-val">${l.smoothingFactor}</span></label>
                      <input type="range" id="shape-smooth" class="menu-input" min="1" max="20" step="1" value="${l.smoothingFactor}">
                  </div>
              `),m&&(i+=`
                  <div class="menu-control-group checkbox-wrapper">
                      <input type="checkbox" id="shape-has-fill" ${l.hasFill?"checked":""}>
                      <label class="menu-label" for="shape-has-fill">Relleno</label>
                  </div>

                  <div class="menu-control-group" id="container-opacity" style="${l.hasFill?"":"opacity: 0.5; pointer-events: none;"}">
                      <label class="menu-label">Opacidad de Relleno: <span id="opacity-val">${Math.round(l.fillOpacity*100)}%</span></label>
                      <input type="range" id="shape-opacity" class="menu-input" min="0" max="1" step="0.1" value="${l.fillOpacity}">
                  </div>
              `)}else if(e instanceof I){const l=e;i+=`
              <div class="menu-control-group">
                  <label class="menu-label">Equipo</label>
                  <select id="player-team" class="menu-select">
                      <option value="A" ${l.team==="A"?"selected":""}>Equipo A</option>
                      <option value="B" ${l.team==="B"?"selected":""}>Equipo B</option>
                  </select>
              </div>

              <div class="menu-control-group">
                  <label class="menu-label">Color</label>
                  ${s}
                  <div style="display: flex; align-items: center; gap: 8px;">
                     <span style="font-size: 0.8rem; color: #888;">Personalizado:</span>
                     <input type="color" id="shape-color" class="menu-input" value="${l.color}" style="flex: 1; height: 30px;">
                  </div>
              </div>

              <div class="menu-control-group">
                  <label class="menu-label">Etiqueta (Max 3)</label>
                  <input type="text" id="player-label" class="menu-input" maxlength="3" value="${l.number}">
              </div>

              <div class="menu-control-group checkbox-wrapper">
                  <input type="checkbox" id="player-ball" ${l.hasBall?"checked":""}>
                  <label class="menu-label" for="player-ball">Posee Bocha</label>
              </div>

              <div class="menu-control-group">
                  <label class="menu-label">Descripción</label>
                  <textarea id="player-desc" class="menu-input" rows="3">${l.description}</textarea>
              </div>
          `}else if(e instanceof k){const l=e,h=this.parseEventConfig(l.config.preEvent),d=this.parseEventConfig(l.config.postEvent);if(i+=`
              <div class="menu-control-group">
                  <label class="menu-label">Tipo</label>
                  <input type="text" class="menu-input" value="${l.type.toUpperCase()}" disabled>
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Pre-Evento</label>
                  <select id="action-preevent" class="menu-select">
                      <option value="auto" ${h.mode==="auto"?"selected":""}>Auto</option>
                      <option value="inmediato" ${h.mode==="inmediato"?"selected":""}>Inmediato</option>
                      <option value="esperar" ${h.mode==="esperar"?"selected":""}>Esperar</option>
                  </select>
                  <div id="container-preevent-seconds" class="menu-control-group" style="${h.mode==="esperar"?"":"display: none;"}">
                      <label class="menu-label">Segundos</label>
                      <input type="number" id="action-preevent-seconds" class="menu-input" min="0" max="60" step="0.5" value="${h.seconds??1}">
                  </div>
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Post-Evento</label>
                  <select id="action-postevent" class="menu-select">
                      <option value="auto" ${d.mode==="auto"?"selected":""}>Auto</option>
                      <option value="inmediato" ${d.mode==="inmediato"?"selected":""}>Inmediato</option>
                      <option value="esperar" ${d.mode==="esperar"?"selected":""}>Esperar</option>
                  </select>
                  <div id="container-postevent-seconds" class="menu-control-group" style="${d.mode==="esperar"?"":"display: none;"}">
                      <label class="menu-label">Segundos</label>
                      <input type="number" id="action-postevent-seconds" class="menu-input" min="0" max="60" step="0.5" value="${d.seconds??1}">
                  </div>
              </div>
          `,e.pathType==="freehand"&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Suavizado: <span id="action-smooth-val">${l.smoothingFactor}</span></label>
                      <input type="range" id="action-smooth" class="menu-input" min="1" max="20" step="1" value="${l.smoothingFactor}">
                  </div>
              `),e instanceof re||e instanceof ie||e instanceof te||e instanceof Q){const u=e.speed;i+=`
                  <div class="menu-control-group checkbox-wrapper">
                      <input type="checkbox" id="action-speed-check" ${u!==null?"checked":""}>
                      <label class="menu-label" for="action-speed-check">Velocidad</label>
                  </div>
                  <div class="menu-control-group" id="container-speed" style="${u!==null?"":"opacity: 0.5; pointer-events: none;"}">
                      <label class="menu-label">Valor: <span id="speed-val">${u||50}</span>%</label>
                      <input type="range" id="action-speed-val" class="menu-input" min="0" max="100" value="${u||50}">
                  </div>
              `}e instanceof ie&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Gesto Técnico</label>
                      <select id="action-gesture" class="menu-select">
                          <option value="push" ${e.gesture==="push"?"selected":""}>Push</option>
                          <option value="pegada" ${e.gesture==="pegada"?"selected":""}>Pegada</option>
                          <option value="barrida" ${e.gesture==="barrida"?"selected":""}>Barrida</option>
                          <option value="flick" ${e.gesture==="flick"?"selected":""}>Flick</option>
                      </select>
                  </div>
              `),e instanceof te&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Gesto Técnico</label>
                      <select id="action-gesture" class="menu-select">
                          <option value="push" ${e.gesture==="push"?"selected":""}>Push</option>
                          <option value="pegada" ${e.gesture==="pegada"?"selected":""}>Pegada</option>
                          <option value="barrida" ${e.gesture==="barrida"?"selected":""}>Barrida</option>
                          <option value="flick" ${e.gesture==="flick"?"selected":""}>Flick</option>
                      </select>
                  </div>
              `),e instanceof Q&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Tipo Conducción</label>
                      <select id="action-dribble-type" class="menu-select">
                          <option value="derecho" ${e.dribbleType==="derecho"?"selected":""}>Derecho</option>
                          <option value="reves" ${e.dribbleType==="reves"?"selected":""}>Revés</option>
                          <option value="aerea" ${e.dribbleType==="aerea"?"selected":""}>Aérea</option>
                      </select>
                  </div>
                  <div class="menu-control-group">
                      <label class="menu-label">Visualización</label>
                      <select id="action-dribble-style" class="menu-select">
                          <option value="straight" ${e.style==="straight"?"selected":""}>Flecha Recta</option>
                          <option value="zigzag" ${e.style==="zigzag"?"selected":""}>ZigZag (Onda)</option>
                      </select>
                  </div>
              `),e instanceof ce&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Radio: <span id="radius-val">${e.radius}</span>px</label>
                      <input type="range" id="action-radius" class="menu-input" min="10" max="100" step="1" value="${e.radius}">
                  </div>
              `),e instanceof le&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Ángulo: <span id="angle-val">${e.angle}</span>°</label>
                      <input type="range" id="action-angle" class="menu-input" min="-360" max="360" step="5" value="${e.angle}">
                  </div>
              `)}if(t.innerHTML=i,document.querySelectorAll(".color-swatch").forEach(l=>{l.addEventListener("click",h=>{const d=h.target.dataset.color;if(d){this.selectedEntity instanceof Z&&(this.selectedEntity.color=d),this.selectedEntity instanceof I&&(this.selectedEntity.color=d),this.selectedEntity instanceof J&&(this.selectedEntity.color=d),this.selectedEntity instanceof W&&(this.selectedEntity.color=d),this.selectedEntity instanceof q&&(this.selectedEntity.groupColor=d),this.selectedEntity instanceof j&&(this.selectedEntity.color=d);const m=document.getElementById("shape-color")||document.getElementById("cone-prop-color")||document.getElementById("ball-prop-color")||document.getElementById("group-prop-color")||document.getElementById("goal-prop-color");m&&(m.value=d)}})}),(a=document.getElementById("shape-color"))==null||a.addEventListener("input",l=>{const h=l.target.value;this.selectedEntity instanceof Z&&(this.selectedEntity.color=h),this.selectedEntity instanceof I&&(this.selectedEntity.color=h)}),e instanceof J)(o=document.getElementById("cone-prop-color"))==null||o.addEventListener("input",l=>{e.color=l.target.value}),(r=document.getElementById("cone-prop-height"))==null||r.addEventListener("input",l=>{e.height=parseInt(l.target.value,10);const h=document.getElementById("height-val");h&&(h.textContent=e.height.toString())});else if(e instanceof W)(p=document.getElementById("ball-prop-group"))==null||p.addEventListener("change",l=>{e.isGroup=l.target.checked}),(g=document.getElementById("ball-prop-color"))==null||g.addEventListener("input",l=>{e.color=l.target.value});else if(e instanceof j)(S=document.getElementById("goal-prop-color"))==null||S.addEventListener("input",l=>{e.color=l.target.value});else if(e instanceof q)(B=document.getElementById("group-prop-lines"))==null||B.addEventListener("change",l=>{e.showLines=l.target.checked}),e.shapeType==="freehand"&&((T=document.getElementById("group-prop-smooth"))==null||T.addEventListener("input",l=>{e.smoothingFactor=parseInt(l.target.value,10);const h=document.getElementById("group-smooth-val");h&&(h.textContent=e.smoothingFactor.toString())})),(M=document.getElementById("group-prop-dist"))==null||M.addEventListener("input",l=>{e.coneDistance=parseInt(l.target.value,10);const h=document.getElementById("dist-val");h&&(h.textContent=e.coneDistance.toString())}),(C=document.getElementById("group-prop-color"))==null||C.addEventListener("input",l=>{e.groupColor=l.target.value}),(L=document.getElementById("group-prop-height"))==null||L.addEventListener("input",l=>{e.groupHeight=parseInt(l.target.value,10);const h=document.getElementById("height-val");h&&(h.textContent=e.groupHeight.toString())}),(R=document.getElementById("group-prop-ind-color"))==null||R.addEventListener("input",l=>{const h=l.target.value;e.coneColors.set(e.selectedConeIndex,h)});else if(e instanceof Z){const l=e,h=l instanceof K,d=l instanceof ne,m=!h&&!d;if((D=document.getElementById("shape-stroke-type"))==null||D.addEventListener("change",u=>{l.strokeType=u.target.value}),h&&((F=document.getElementById("line-start-marker"))==null||F.addEventListener("change",u=>{l.startMarker=u.target.value}),($=document.getElementById("line-end-marker"))==null||$.addEventListener("change",u=>{l.endMarker=u.target.value})),d){const u=document.getElementById("shape-smooth"),y=document.getElementById("smooth-val");u==null||u.addEventListener("input",E=>{const x=parseInt(E.target.value);l.smoothingFactor=x,y&&(y.textContent=x.toString())})}if(m){const u=document.getElementById("shape-has-fill"),y=document.getElementById("container-opacity");u==null||u.addEventListener("change",b=>{l.hasFill=b.target.checked,y&&(y.style.opacity=l.hasFill?"1":"0.5",y.style.pointerEvents=l.hasFill?"auto":"none")});const E=document.getElementById("shape-opacity"),x=document.getElementById("opacity-val");E==null||E.addEventListener("input",b=>{const w=parseFloat(b.target.value);l.fillOpacity=w,x&&(x.textContent=Math.round(w*100)+"%")})}}else if(e instanceof I){const l=e;(_=document.getElementById("player-team"))==null||_.addEventListener("change",h=>{l.team=h.target.value}),(O=document.getElementById("player-label"))==null||O.addEventListener("input",h=>{l.number=h.target.value}),(X=document.getElementById("player-ball"))==null||X.addEventListener("change",h=>{l.hasBall=h.target.checked}),(Y=document.getElementById("player-desc"))==null||Y.addEventListener("input",h=>{l.description=h.target.value})}else if(e instanceof k){const l=this.parseEventConfig(e.config.preEvent);l.mode==="esperar"&&l.seconds!=null&&(e.waitBefore=l.seconds);const h=document.getElementById("action-preevent"),d=document.getElementById("container-preevent-seconds"),m=document.getElementById("action-preevent-seconds");h==null||h.addEventListener("change",()=>{const f=h.value;if(f==="esperar"){const A=m&&parseFloat(m.value)||1;e.config.preEvent=`esperar:${A}`,e.waitBefore=A,d&&(d.style.display="")}else e.config.preEvent=f,e.waitBefore=0,d&&(d.style.display="none")}),m==null||m.addEventListener("input",()=>{const f=parseFloat(m.value);!isNaN(f)&&f>=0&&(e.config.preEvent=`esperar:${f}`,e.waitBefore=f)});const u=document.getElementById("action-postevent"),y=document.getElementById("container-postevent-seconds"),E=document.getElementById("action-postevent-seconds");if(u==null||u.addEventListener("change",()=>{const f=u.value;if(f==="esperar"){const A=E&&parseFloat(E.value)||1;e.config.postEvent=`esperar:${A}`,y&&(y.style.display="")}else e.config.postEvent=f,y&&(y.style.display="none")}),E==null||E.addEventListener("input",()=>{const f=parseFloat(E.value);!isNaN(f)&&f>=0&&(e.config.postEvent=`esperar:${f}`)}),e.pathType==="freehand"){const f=document.getElementById("action-smooth"),A=document.getElementById("action-smooth-val");f==null||f.addEventListener("input",fe=>{const pe=parseInt(fe.target.value);e.smoothingFactor=pe,A&&(A.textContent=pe.toString())})}const x=e,b=document.getElementById("action-speed-check"),w=document.getElementById("container-speed"),z=document.getElementById("action-speed-val"),V=document.getElementById("speed-val");b&&b.addEventListener("change",f=>{f.target.checked?(x.speed=parseInt(z.value),w&&(w.style.opacity="1",w.style.pointerEvents="auto")):(x.speed=null,w&&(w.style.opacity="0.5",w.style.pointerEvents="none"))}),z&&z.addEventListener("input",f=>{const A=parseInt(f.target.value);x.speed=A,V&&(V.textContent=A.toString())}),(H=document.getElementById("action-gesture"))==null||H.addEventListener("change",f=>{(e instanceof ie||e instanceof te)&&(e.gesture=f.target.value)}),(N=document.getElementById("action-dribble-type"))==null||N.addEventListener("change",f=>{e instanceof Q&&(e.dribbleType=f.target.value)}),(U=document.getElementById("action-dribble-style"))==null||U.addEventListener("change",f=>{e instanceof Q&&(e.style=f.target.value)});const de=document.getElementById("action-radius");de&&de.addEventListener("input",f=>{e instanceof ce&&(e.radius=parseInt(f.target.value),document.getElementById("radius-val").textContent=e.radius.toString())});const he=document.getElementById("action-angle");he&&he.addEventListener("input",f=>{e instanceof le&&(e.angle=parseInt(f.target.value),document.getElementById("angle-val").textContent=e.angle.toString())})}}deleteSelected(){if(this.selectedEntity)if(this.selectedEntity instanceof k){const t=this.selectedEntity,e=t.owner;e instanceof I&&(this.commandManager.execute(new Be(e,t)),this.selectedEntity=null,this.updateSelectionUI())}else this.commandManager.execute(new Pe(this,this.selectedEntity)),this.selectedEntity=null,this.updateSelectionUI()}resize(){const t=this.canvas.parentElement;t?(this.canvas.width=t.clientWidth,this.canvas.height=t.clientHeight):(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight)}start(){this.zoneConfig&&this.applyZoneView(this.zoneConfig),requestAnimationFrame(t=>{this.lastTime=t,this.loop(t)})}applyZoneView(t){const e=t.zone;t.rotate&&(this.camera.rotation=-Math.PI/2),this.camera.x=e.x+e.w/2,this.camera.y=e.y+e.h/2;const i=t.rotate?this.canvas.height:this.canvas.width,n=t.rotate?this.canvas.width:this.canvas.height,s=i/e.w,a=n/e.h;this.camera.zoom=Math.min(s,a)*.85}loop(t){const e=(t-this.lastTime)/1e3;this.lastTime=t,this.update(e),this.render(),requestAnimationFrame(i=>this.loop(i))}update(t){if(this.currentMode==="play"&&(this.animationManager.update(t),this.animationManager.isPaused)){const e=document.getElementById("anim-play"),i=e==null?void 0:e.querySelector("i");i==null||i.classList.replace("fa-pause","fa-play")}}render(){var t;if(this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.camera.applyTransform(this.ctx,this.canvas),this.field.draw(this.ctx),this.zoneConfig&&this.zoneConfig.preset!=="full"){const e=this.zoneConfig.zone,i=1/this.camera.zoom;if(this.ctx.save(),this._zoneSelected){if(this.ctx.strokeStyle="rgba(251, 146, 60, 1)",this.ctx.lineWidth=(this._zoneEditEnabled?3:2.5)*i,this.ctx.setLineDash([]),this.ctx.strokeRect(e.x,e.y,e.w,e.h),this.ctx.fillStyle="rgba(251, 146, 60, 0.12)",this.ctx.fillRect(e.x,e.y,e.w,e.h),this._zoneEditEnabled){const n=8*i,s=[{x:e.x,y:e.y},{x:e.x+e.w,y:e.y},{x:e.x,y:e.y+e.h},{x:e.x+e.w,y:e.y+e.h}];for(const a of s)this.ctx.fillStyle="#fb923c",this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=1.5*i,this.ctx.fillRect(a.x-n/2,a.y-n/2,n,n),this.ctx.strokeRect(a.x-n/2,a.y-n/2,n,n)}}else this.ctx.strokeStyle="rgba(251, 146, 60, 0.8)",this.ctx.lineWidth=2*i,this.ctx.setLineDash([8*i,5*i]),this.ctx.strokeRect(e.x,e.y,e.w,e.h),this.ctx.fillStyle="rgba(251, 146, 60, 0.08)",this.ctx.fillRect(e.x,e.y,e.w,e.h),this.ctx.setLineDash([]);this.ctx.restore()}this.entities.forEach(e=>e.draw(this.ctx,this.currentScene)),this.currentMode==="play"&&this.animationManager.render(this.ctx),(t=this.tools.get(this.currentToolId))==null||t.render(this.ctx),this.ctx.restore()}async optimizeDrill(){const t=document.getElementById("anim-play"),e=t==null?void 0:t.innerHTML;t&&(t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',t.style.pointerEvents="none");try{const i=this.serializeDrillState(),n=await fetch("/api/optimize-drill",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(n.ok){const s=await n.json();this.applyOptimizedState(s),this.showOptimizationFeedback(!0)}else this.showOptimizationFeedback(!1),console.error("Optimization failed:",n.statusText)}catch(i){this.showOptimizationFeedback(!1),console.error("Error optimizing drill:",i)}finally{t&&e&&(t.innerHTML=e,t.style.pointerEvents="auto")}}getGameSnapshot(){return{entities:this.entities,currentScene:this.currentScene,sceneCount:this.sceneCount,camera:{x:this.camera.x,y:this.camera.y,zoom:this.camera.zoom,rotation:this.camera.rotation},canvas:this.canvas,zoneConfig:this.zoneConfig??null}}async loadExercise(t){var n;const e=await this.exerciseStorage.load(t);if(!e)return;this.exerciseMetadata=e.metadata||{title:"Sin título"},e.zoneConfig&&(this.zoneConfig={...e.zoneConfig}),this.entities.length=0;const{deserializeEntity:i}=await Ee(()=>import("./ExerciseStorage-321cadc6.js").then(s=>s.j),["assets/ExerciseStorage-321cadc6.js","assets/user-58edc8be.js","assets/client-c375c8af.js"]);for(const s of e.entities.items){const a=i(s);a&&this.entities.push(a)}for(const s of this.entities)s instanceof I&&s.updateActionChain();this.sceneCount=e.scenes.count||1,this.currentScene=e.scenes.current||0,this.updateSceneState(),(n=e.editorState)!=null&&n.camera&&(this.camera.x=e.editorState.camera.x,this.camera.y=e.editorState.camera.y,this.camera.zoom=e.editorState.camera.zoom,this.camera.rotation=e.editorState.camera.rotation||0),this.selectEntity(null)}async saveAndNavigate(){await this.exerciseStorage.save(this.exerciseId,this.getGameSnapshot(),this.exerciseMetadata,"complete"),window.location.href=`ejercicio.html?id=${this.exerciseId}`}serializeDrillState(){return{players:this.entities.filter(e=>e instanceof I).map(e=>{const i=e;return{id:i.id,x:i.x,y:i.y,initialX:i.initialX,initialY:i.initialY,number:i.number,hasBall:i.hasBall,team:i.team,actions:i.actions.map(n=>({id:n.id,type:n.type,startX:n.startX,startY:n.startY,endX:n.endX,endY:n.endY,config:n.config,pathType:n.pathType,points:n.points,sceneIndex:n.sceneIndex,speed:n.speed||null,waitBefore:n.waitBefore||0,gesture:n.gesture,dribbleType:n.dribbleType,style:n.style,radius:n.radius,angle:n.angle}))}})}}showOptimizationFeedback(t){const e=document.querySelector('label[for="ai-opt-toggle"]');if(!e)return;const i=e.innerHTML;e.innerHTML=t?'<i class="fa-solid fa-check" style="color: #22c55e;"></i> Optimizado':'<i class="fa-solid fa-exclamation-triangle" style="color: #eab308;"></i> Error',e.classList.toggle("optimization-feedback",!0),setTimeout(()=>{e.innerHTML=i,e.classList.remove("optimization-feedback")},2500)}applyOptimizedState(t){t.players&&t.players.forEach(e=>{const i=this.entities.find(n=>String(n.id)===String(e.id));i&&i.actions.forEach(n=>{var a,o,r;const s=(a=e.actions)==null?void 0:a.find(p=>String(p.id)===String(n.id));s&&(s.speed!==void 0&&(n.speed=s.speed),s.waitBefore!==void 0&&(n.waitBefore=s.waitBefore),((o=s.config)==null?void 0:o.preEvent)!==void 0&&(n.config.preEvent=s.config.preEvent),((r=s.config)==null?void 0:r.postEvent)!==void 0&&(n.config.postEvent=s.config.postEvent))})})}}const De={idle:"",syncing:'<i class="fa-solid fa-arrows-rotate fa-spin"></i>',synced:'<i class="fa-solid fa-cloud-check" style="color:var(--marker-green,#16a34a)"></i>',error:'<i class="fa-solid fa-triangle-exclamation" style="color:var(--marker-orange,#ea580c)"></i>',"local-only":'<i class="fa-solid fa-hard-drive" style="color:var(--home-muted,#5c5c56)"></i>'},Fe={idle:"",syncing:"Sincronizando...",synced:"Sincronizado",error:"Error de sincronización","local-only":"Solo guardado localmente"};function Ye(v="sync-indicator"){const t=document.getElementById(v);t&&be((e,i)=>{if(e==="idle"){t.classList.add("hidden");return}t.classList.remove("hidden"),t.innerHTML=De[e]||"",t.title=i||Fe[e]||"",e==="synced"&&setTimeout(()=>{t.classList.add("hidden")},3e3)})}export{Se as F,Xe as G,Ye as i};
