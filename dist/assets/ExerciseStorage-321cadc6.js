var rt=Object.defineProperty;var ht=(s,e,t)=>e in s?rt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var c=(s,e,t)=>(ht(s,typeof e!="symbol"?e+"":e,t),t);import{isLoggedIn as Y,fetchWithAuth as b}from"./user-58edc8be.js";const at="#ffffff",S={color:"#ffffff",strokeType:"solid",hasFill:!0,fillOpacity:.2,startMarker:"none",endMarker:"none",smoothingFactor:5};class D{constructor(e,t,i="1",o="#ef4444"){c(this,"id");c(this,"x");c(this,"y");c(this,"color");c(this,"number");c(this,"isSelected",!1);c(this,"team","A");c(this,"hasBall",!1);c(this,"ballColor");c(this,"description","");c(this,"actions",[]);c(this,"initialX");c(this,"initialY");c(this,"rotation",0);c(this,"sceneDeltaX",0);c(this,"sceneDeltaY",0);c(this,"radius",15);this.id=crypto.randomUUID(),this.x=e,this.y=t,this.initialX=e,this.initialY=t,this.number=i,this.color=o}setPosition(e,t){this.initialX=e-this.sceneDeltaX,this.initialY=t-this.sceneDeltaY,this.x=e,this.y=t,this.updateActionChain()}updateForScene(e){let t=this.initialX,i=this.initialY,o=0;for(const h of this.actions)if(h.sceneIndex<e){h.setStartPosition(t,i);const a=h.getFinalPosition();t=a.x,i=a.y,h.movesPlayer&&(o=h.getHeadingAt(1))}this.sceneDeltaX=t-this.initialX,this.sceneDeltaY=i-this.initialY,this.x=t,this.y=i,this.rotation=o;let n=t,r=i;for(const h of this.actions)if(h.sceneIndex>=e){h.setStartPosition(n,r);const a=h.getFinalPosition();n=a.x,r=a.y}}updateActionChain(){let e=this.initialX,t=this.initialY;for(const i of this.actions){i.setStartPosition(e,t);const o=i.getFinalPosition();e=o.x,t=o.y}}containsPoint(e,t){const i=this.x-e,o=this.y-t;return i*i+o*o<=this.radius*this.radius}draw(e,t=0){if(this.actions.forEach(i=>{i.sceneIndex===t&&i.draw(e)}),this.isSelected&&(e.beginPath(),e.arc(this.x,this.y,this.radius+4,0,Math.PI*2),e.fillStyle="rgba(255, 255, 0, 0.5)",e.fill(),e.strokeStyle="yellow",e.lineWidth=2,e.stroke()),e.beginPath(),e.arc(this.x,this.y,this.radius,0,Math.PI*2),e.fillStyle=this.color,e.fill(),e.strokeStyle="white",e.lineWidth=2,e.stroke(),e.fillStyle="white",e.font="bold 14px Arial",e.textAlign="center",e.textBaseline="middle",e.fillText(this.number,this.x,this.y),this.hasBall){const o=this.rotation+Math.PI/4,n=this.x+Math.cos(o)*17,r=this.y+Math.sin(o)*17;e.beginPath(),e.arc(n,r,5,0,Math.PI*2),e.fillStyle=this.ballColor??at,e.fill(),e.strokeStyle="#fff",e.lineWidth=1,e.stroke()}}}class M{constructor(e,t,i=S.color){c(this,"id");c(this,"x");c(this,"y");c(this,"rotation",0);c(this,"color",S.color);c(this,"isSelected",!1);c(this,"lineWidth",3);c(this,"strokeType",S.strokeType);c(this,"hasFill",S.hasFill);c(this,"fillOpacity",S.fillOpacity);this.id=crypto.randomUUID(),this.x=e,this.y=t,this.color=i}setPosition(e,t){this.x=e,this.y=t}draw(e,t){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation),this.isSelected?(e.shadowColor="yellow",e.shadowBlur=10,e.strokeStyle="yellow"):e.strokeStyle=this.color,this.strokeType==="dashed"?e.setLineDash([10,5]):this.strokeType==="dotted"?e.setLineDash([2,5]):e.setLineDash([]),e.lineWidth=this.lineWidth,this.drawShape(e),e.restore()}getFillColor(){let e=this.color.startsWith("#")?this.color.slice(1):this.color;e.length===3&&(e=e.split("").map(n=>n+n).join(""));const t=parseInt(e.substring(0,2),16)||0,i=parseInt(e.substring(2,4),16)||0,o=parseInt(e.substring(4,6),16)||0;return`rgba(${t},${i},${o},${this.fillOpacity})`}containsPoint(e,t){const i=e-this.x,o=t-this.y,n=Math.cos(-this.rotation),r=Math.sin(-this.rotation),h=i*n-o*r,a=i*r+o*n;return this.containsPointLocal(h,a)}rotatePoint(e,t,i){const o=Math.cos(i),n=Math.sin(i);return{x:e*o-t*n,y:e*n+t*o}}}class x extends M{constructor(){super(...arguments);c(this,"width",0);c(this,"height",0)}drawShape(t){t.beginPath(),t.rect(-this.width/2,-this.height/2,this.width,this.height),this.hasFill&&(t.fillStyle=this.getFillColor(),t.fill()),t.stroke()}containsPointLocal(t,i){const o=this.width/2,n=this.height/2,r=10,h=Math.abs(t- -o)<r&&i>=-n-r&&i<=n+r,a=Math.abs(t-o)<r&&i>=-n-r&&i<=n+r,l=Math.abs(i- -n)<r&&t>=-o-r&&t<=o+r,f=Math.abs(i-n)<r&&t>=-o-r&&t<=o+r,p=Math.abs(t)<=o&&Math.abs(i)<=n;return h||a||l||f||p}getHandles(){const t=this.width/2,i=this.height/2;return[{id:"tl",x:-t,y:-i,cursor:"nw-resize"},{id:"tr",x:t,y:-i,cursor:"ne-resize"},{id:"br",x:t,y:i,cursor:"se-resize"},{id:"bl",x:-t,y:i,cursor:"sw-resize"},{id:"rotate",x:0,y:-i-25,cursor:"grab"}]}resize(t,i,o){const n=this.width/2,r=this.height/2;let h=0,a=0;t==="tl"?(h=n,a=r):t==="tr"?(h=-n,a=r):t==="br"?(h=-n,a=-r):t==="bl"&&(h=n,a=-r);const l=Math.abs(i-h),f=Math.abs(o-a),p=(i+h)/2,d=(o+a)/2;this.width=Math.max(1,l),this.height=Math.max(1,f);const y=this.rotatePoint(p,d,this.rotation);this.x+=y.x,this.y+=y.y}}class E extends M{constructor(){super(...arguments);c(this,"radiusX",0);c(this,"radiusY",0)}drawShape(t){t.beginPath(),t.ellipse(0,0,Math.max(0,this.radiusX),Math.max(0,this.radiusY),0,0,2*Math.PI),this.hasFill&&(t.fillStyle=this.getFillColor(),t.fill()),t.stroke(),this.isSelected&&(t.save(),t.strokeStyle="#888",t.setLineDash([5,5]),t.lineWidth=1,t.strokeRect(-this.radiusX,-this.radiusY,this.radiusX*2,this.radiusY*2),t.restore())}containsPointLocal(t,i){const o=Math.max(1,this.radiusX),n=Math.max(1,this.radiusY),r=t*t/(o*o)+i*i/(n*n);return Math.abs(r-1)<.2||r<=1}getHandles(){const t=this.radiusX,i=this.radiusY;return[{id:"tl",x:-t,y:-i,cursor:"nw-resize"},{id:"tr",x:t,y:-i,cursor:"ne-resize"},{id:"br",x:t,y:i,cursor:"se-resize"},{id:"bl",x:-t,y:i,cursor:"sw-resize"},{id:"rotate",x:0,y:-i-25,cursor:"grab"}]}resize(t,i,o){const n=this.radiusX,r=this.radiusY;let h=0,a=0;t==="tl"?(h=n,a=r):t==="tr"?(h=-n,a=r):t==="br"?(h=-n,a=-r):t==="bl"&&(h=n,a=-r);const l=Math.abs(i-h),f=Math.abs(o-a),p=(i+h)/2,d=(o+a)/2;this.radiusX=Math.max(1,l/2),this.radiusY=Math.max(1,f/2);const y=this.rotatePoint(p,d,this.rotation);this.x+=y.x,this.y+=y.y}}class O extends M{constructor(t,i,o=S.color){super(t,i,o);c(this,"points",[]);this.points=[{x:0,y:-50},{x:50,y:50},{x:-50,y:50}]}drawShape(t){this.points.length===3&&(t.beginPath(),t.moveTo(this.points[0].x,this.points[0].y),t.lineTo(this.points[1].x,this.points[1].y),t.lineTo(this.points[2].x,this.points[2].y),t.closePath(),this.hasFill&&(t.fillStyle=this.getFillColor(),t.fill()),t.stroke())}containsPointLocal(t,i){const o=Math.min(...this.points.map(a=>a.x)),n=Math.max(...this.points.map(a=>a.x)),r=Math.min(...this.points.map(a=>a.y)),h=Math.max(...this.points.map(a=>a.y));return t>=o-10&&t<=n+10&&i>=r-10&&i<=h+10}getHandles(){const t=Math.min(...this.points.map(o=>o.y)),i=this.points.map((o,n)=>({id:`p${n}`,x:o.x,y:o.y,cursor:"move"}));return i.push({id:"rotate",x:0,y:t-25,cursor:"grab"}),i}resize(t,i,o){const n=parseInt(t.charAt(1));!isNaN(n)&&this.points[n]&&(this.points[n].x=i,this.points[n].y=o)}}class W extends M{constructor(){super(...arguments);c(this,"endX",0);c(this,"endY",0);c(this,"startMarker",S.startMarker);c(this,"endMarker",S.endMarker)}drawShape(t){t.beginPath(),t.moveTo(0,0),t.lineTo(this.endX,this.endY),t.stroke();const i=Math.atan2(this.endY,this.endX);this.startMarker==="arrow"&&this.drawArrow(t,0,0,i+Math.PI),this.endMarker==="arrow"&&this.drawArrow(t,this.endX,this.endY,i)}drawArrow(t,i,o,n){t.save(),t.translate(i,o),t.rotate(n),t.beginPath(),t.moveTo(0,0),t.lineTo(-15,5),t.lineTo(-15,-5),t.closePath(),t.fillStyle=this.color,t.setLineDash([]),t.fill(),t.restore()}containsPointLocal(t,i){const o=this.endX*this.endX+this.endY*this.endY;if(o===0)return!1;let n=(t*this.endX+i*this.endY)/o;n=Math.max(0,Math.min(1,n));const r=n*this.endX,h=n*this.endY;return Math.sqrt(Math.pow(t-r,2)+Math.pow(i-h,2))<10}getHandles(){return[{id:"start",x:0,y:0,cursor:"move"},{id:"end",x:this.endX,y:this.endY,cursor:"move"}]}resize(t,i,o){if(t==="end")this.endX=i,this.endY=o;else if(t==="start"){const n=this.rotatePoint(i,o,this.rotation);this.x+=n.x,this.y+=n.y,this.endX-=i,this.endY-=o}}}class H extends M{constructor(){super(...arguments);c(this,"points",[]);c(this,"smoothingFactor",S.smoothingFactor)}drawShape(t){if(!(this.points.length<2)){if(t.beginPath(),this.smoothingFactor<=1){t.moveTo(this.points[0].x,this.points[0].y);for(let i=1;i<this.points.length;i++)t.lineTo(this.points[i].x,this.points[i].y)}else{const i=[];for(let n=0;n<this.points.length;n+=Math.ceil(this.smoothingFactor))i.push(this.points[n]);if(i[i.length-1]!==this.points[this.points.length-1]&&i.push(this.points[this.points.length-1]),i.length<2){t.moveTo(this.points[0].x,this.points[0].y);return}t.moveTo(i[0].x,i[0].y);for(let n=1;n<i.length-1;n++){const r=i[n],h=i[n+1],a={x:(r.x+h.x)/2,y:(r.y+h.y)/2};t.quadraticCurveTo(r.x,r.y,a.x,a.y)}const o=i[i.length-1];t.lineTo(o.x,o.y)}t.stroke()}}containsPointLocal(t,i){for(const o of this.points){const n=t-o.x,r=i-o.y;if(n*n+r*r<100)return!0}return!1}getHandles(){return[]}resize(t,i,o){}}function R(s,e,t){const i=(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y);if(i===0)return Math.hypot(s.x-e.x,s.y-e.y);let o=((s.x-e.x)*(t.x-e.x)+(s.y-e.y)*(t.y-e.y))/i;return o=Math.max(0,Math.min(1,o)),Math.hypot(s.x-(e.x+o*(t.x-e.x)),s.y-(e.y+o*(t.y-e.y)))}class X{constructor(e,t,i,o,n){c(this,"id");c(this,"isSelected",!1);c(this,"config",{preEvent:"auto",postEvent:"auto"});c(this,"sceneIndex",0);c(this,"pathType","straight");c(this,"points",[]);c(this,"smoothingFactor",5);c(this,"waitBefore",0);c(this,"speed",null);c(this,"owner",null);this.type=e,this.startX=t,this.startY=i,this.endX=o,this.endY=n,this.id=crypto.randomUUID()}get x(){return this.startX}set x(e){e-this.startX,this.setPosition(e,this.startY)}get y(){return this.startY}set y(e){e-this.startY,this.setPosition(this.startX,e)}containsPoint(e,t){if(this.type==="turn"||this.type==="tackle"){const i=this.startX-e,o=this.startY-t;let n=20;return this.type==="tackle"&&(n=this.radius||25),i*i+o*o<n*n}if(this.pathType==="straight")return R({x:e,y:t},{x:this.startX,y:this.startY},{x:this.endX,y:this.endY})<10;if(this.points.length<2)return!1;for(let i=0;i<this.points.length-1;i++)if(R({x:e,y:t},this.points[i],this.points[i+1])<10)return!0;return!1}setStartPosition(e,t){this.startX=e,this.startY=t,this.pathType==="freehand"&&this.points.length>0&&(this.points[0].x=e,this.points[0].y=t)}setPosition(e,t){const i=e-this.startX,o=t-this.startY;this.startX=e,this.startY=t,this.endX+=i,this.endY+=o,this.points.forEach(n=>{n.x+=i,n.y+=o})}getHandles(){return this.pathType==="straight"?[{id:"end",x:this.endX,y:this.endY,cursor:"move"}]:[]}resize(e,t,i){e==="end"&&(this.endX=t,this.endY=i,this.owner&&this.owner.updateActionChain())}getPathLength(){if(this.pathType==="straight")return Math.hypot(this.endX-this.startX,this.endY-this.startY);{const e=this.getSmoothedPolyline();let t=0;for(let i=0;i<e.length-1;i++)t+=Math.hypot(e[i+1].x-e[i].x,e[i+1].y-e[i].y);return t}}getPositionAt(e){if(e=Math.max(0,Math.min(1,e)),this.pathType==="straight")return{x:this.startX+(this.endX-this.startX)*e,y:this.startY+(this.endY-this.startY)*e};{const t=this.getSmoothedPolyline();if(t.length<2)return{x:this.startX,y:this.startY};const o=this.getPathLength()*e;let n=0;for(let r=0;r<t.length-1;r++){const h=Math.hypot(t[r+1].x-t[r].x,t[r+1].y-t[r].y);if(n+h>=o){const a=(o-n)/h;return{x:t[r].x+(t[r+1].x-t[r].x)*a,y:t[r].y+(t[r+1].y-t[r].y)*a}}n+=h}return t[t.length-1]}}getHeadingAt(e){const i=e,o=Math.min(1,e+.01);let n,r;return i>=.99?(n=this.getPositionAt(i-.01),r=this.getPositionAt(i)):(n=this.getPositionAt(i),r=this.getPositionAt(o)),Math.atan2(r.y-n.y,r.x-n.x)}getSmoothedPolyline(){const e=this.points,t=Math.max(1,this.smoothingFactor);if(e.length<3||t<=1)return e;const i=[];for(let r=0;r<e.length;r+=Math.ceil(t))i.push(e[r]);if(i[i.length-1]!==e[e.length-1]&&i.push(e[e.length-1]),i.length<2)return e;const o=[];o.push(i[0]);let n=i[0];for(let r=1;r<i.length-1;r++){const h=i[r],a=i[r+1],l={x:(h.x+a.x)/2,y:(h.y+a.y)/2},f=10;for(let p=1;p<=f;p++){const d=p/f,y=1-d,u=y*y*n.x+2*y*d*h.x+d*d*l.x,g=y*y*n.y+2*y*d*h.y+d*d*l.y;o.push({x:u,y:g})}n=l}return o.push(i[i.length-1]),o}drawArrowPath(e,t,i){e.beginPath();let o=this.endX,n=this.endY,r=0;if(this.pathType==="straight")e.moveTo(this.startX,this.startY),e.lineTo(this.endX,this.endY),r=Math.atan2(this.endY-this.startY,this.endX-this.startX);else if(this.points.length>0){const h=this.points,a=Math.max(1,this.smoothingFactor);let l=h;if(h.length>=3&&a>1){const f=[];for(let p=0;p<h.length;p+=Math.ceil(a))f.push(h[p]);if(f[f.length-1]!==h[h.length-1]&&f.push(h[h.length-1]),f.length>=2){l=f,e.moveTo(f[0].x,f[0].y);for(let d=1;d<f.length-1;d++){const y=f[d],u=f[d+1],g={x:(y.x+u.x)/2,y:(y.y+u.y)/2};e.quadraticCurveTo(y.x,y.y,g.x,g.y)}const p=f[f.length-1];e.lineTo(p.x,p.y)}else{e.moveTo(h[0].x,h[0].y);for(let p=1;p<h.length;p++)e.lineTo(h[p].x,h[p].y)}}else{e.moveTo(h[0].x,h[0].y);for(let f=1;f<h.length;f++)e.lineTo(h[f].x,h[f].y)}if(l.length>1){const f=l[l.length-1],p=2,d=l===h?10:3,y=l[Math.max(0,l.length-p)],u=Math.atan2(f.y-y.y,f.x-y.x),g=l[Math.max(0,l.length-d)],T=Math.atan2(f.y-g.y,f.x-g.x);let m=u-T;for(;m<=-Math.PI;)m+=2*Math.PI;for(;m>Math.PI;)m-=2*Math.PI;r=Math.abs(m)<30*Math.PI/180?T:u,o=f.x,n=f.y}}e.strokeStyle=this.isSelected?"#fff":t,e.lineWidth=2,i?e.setLineDash([10,5]):e.setLineDash([]),e.stroke(),e.setLineDash([]),e.save(),e.translate(o,n),e.rotate(r),e.beginPath(),e.moveTo(0,0),e.lineTo(-10,5),e.lineTo(-10,-5),e.closePath(),e.fillStyle=this.isSelected?"#fff":t,e.fill(),e.restore()}}class j extends X{constructor(t,i,o,n){super("run",t,i,o,n);c(this,"speed",null);c(this,"movesPlayer",!0);c(this,"ballInteraction","none")}draw(t){this.drawArrowPath(t,"#ef4444",!0)}getFinalPosition(){return this.pathType==="straight"?{x:this.endX,y:this.endY}:this.points.length>0?this.points[this.points.length-1]:{x:this.startX,y:this.startY}}}class _ extends X{constructor(t,i,o,n){super("pass",t,i,o,n);c(this,"speed",null);c(this,"gesture","push");c(this,"movesPlayer",!1);c(this,"ballInteraction","propel")}draw(t){this.drawArrowPath(t,"#eab308",!1)}getFinalPosition(){return{x:this.startX,y:this.startY}}}class $ extends X{constructor(t,i,o,n){super("dribble",t,i,o,n);c(this,"speed",null);c(this,"dribbleType","derecho");c(this,"style","straight");c(this,"movesPlayer",!0);c(this,"ballInteraction","carry")}draw(t){this.style==="zigzag"?this.drawZigZag(t,"#ef4444"):this.drawArrowPath(t,"#ef4444",!1)}drawZigZag(t,i){t.beginPath();const o=5,n=.2;let r=this.endX,h=this.endY,a=0;if(this.pathType==="straight"){const l=this.endX-this.startX,f=this.endY-this.startY,p=Math.hypot(l,f),d=Math.atan2(f,l);a=d,t.save(),t.translate(this.startX,this.startY),t.rotate(d),t.beginPath(),t.moveTo(0,0);const u=Math.max(0,p-15),g=Math.max(Math.ceil(u/2),2);for(let T=0;T<=g;T++){const m=T/g*u,F=o*Math.sin(m*n);t.lineTo(m,F)}t.lineTo(p,0),t.strokeStyle=this.isSelected?"#fff":i,t.lineWidth=2,t.setLineDash([]),t.stroke(),t.restore()}else{if(this.points.length<2)return;const l=this.getSmoothedPolyline();let f=0;for(let d=0;d<l.length-1;d++)f+=Math.hypot(l[d+1].x-l[d].x,l[d+1].y-l[d].y);t.beginPath();let p=0;if(t.moveTo(l[0].x,l[0].y),l.length>1){const d=l[l.length-1],y=l[Math.max(0,l.length-5)];r=d.x,h=d.y,a=Math.atan2(d.y-y.y,d.x-y.x)}for(let d=1;d<l.length;d++){const y=l[d-1],u=l[d],g=u.x-y.x,T=u.y-y.y,m=Math.hypot(g,T);if(m===0)continue;const F=-T/m,st=g/m,B=Math.max(1,Math.ceil(m/2));for(let z=1;z<=B;z++){const I=z/B,U=p+I*m,it=y.x+I*g,nt=y.y+I*T,N=f-U,ot=N<30?N/30:1,G=o*Math.sin(U*n)*ot;t.lineTo(it+F*G,nt+st*G)}p+=m}t.strokeStyle=this.isSelected?"#fff":i,t.lineWidth=2,t.setLineDash([]),t.stroke()}t.save(),t.translate(r,h),t.rotate(a),t.beginPath(),t.moveTo(0,0),t.lineTo(-10,5),t.lineTo(-10,-5),t.closePath(),t.fillStyle=this.isSelected?"#fff":i,t.fill(),t.restore()}getFinalPosition(){return this.pathType==="straight"?{x:this.endX,y:this.endY}:this.points.length>0?this.points[this.points.length-1]:{x:this.startX,y:this.startY}}}class J extends X{constructor(t,i,o,n){super("shoot",t,i,o,n);c(this,"speed",null);c(this,"gesture","pegada");c(this,"movesPlayer",!1);c(this,"ballInteraction","propel")}draw(t){this.drawArrowPath(t,"#22c55e",!1)}getFinalPosition(){return{x:this.startX,y:this.startY}}}class q extends X{constructor(t,i,o,n){super("tackle",t,i,o,n);c(this,"radius",25);c(this,"movesPlayer",!1);c(this,"ballInteraction","none")}draw(t){t.beginPath(),t.arc(this.startX,this.startY,this.radius,0,Math.PI*2),t.strokeStyle=this.isSelected?"#fff":"#eab308",t.lineWidth=2,t.setLineDash([5,5]),t.stroke(),t.setLineDash([])}getFinalPosition(){return{x:this.startX,y:this.startY}}}class Z extends X{constructor(t,i,o,n){super("turn",t,i,o,n);c(this,"angle",0);c(this,"movesPlayer",!1);c(this,"ballInteraction","none")}draw(t){t.beginPath(),t.arc(this.startX,this.startY,19,0,Math.PI*2),t.strokeStyle=this.isSelected?"#fff":"#eab308",t.lineWidth=4,t.setLineDash([]),t.stroke()}getFinalPosition(){return{x:this.startX,y:this.startY}}}class v{constructor(e,t,i="#f97316",o=10){c(this,"id");c(this,"isSelected",!1);this.x=e,this.y=t,this.color=i,this.height=o,this.id=crypto.randomUUID()}setPosition(e,t){this.x=e,this.y=t}containsPoint(e,t){const o=this.x-e,n=this.y-t;return o*o+n*n<15*15}draw(e,t){v.drawCone(e,this.x,this.y,this.color,this.height,this.isSelected)}static drawCone(e,t,i,o,n,r){e.fillStyle=o,e.beginPath(),e.moveTo(t,i-n),e.lineTo(t-20/2,i),e.lineTo(t+20/2,i),e.fill(),e.beginPath(),e.ellipse(t,i,20/2,8/2,0,0,Math.PI*2),e.fill(),r&&(e.strokeStyle="#fff",e.lineWidth=2,e.stroke(),e.beginPath(),e.moveTo(t,i-n),e.lineTo(t-20/2,i),e.lineTo(t+20/2,i),e.closePath(),e.stroke())}}class V{constructor(e,t,i="#ffffff"){c(this,"id");c(this,"isSelected",!1);c(this,"isGroup",!1);c(this,"visible",!0);this.x=e,this.y=t,this.color=i,this.id=crypto.randomUUID()}setPosition(e,t){this.x=e,this.y=t}containsPoint(e,t){const i=this.isGroup?15:5,o=this.x-e,n=this.y-t;return o*o+n*n<(i+5)*(i+5)}draw(e,t){if(!this.visible)return;const i=5,o=(n,r)=>{e.beginPath(),e.arc(n,r,i,0,Math.PI*2),e.fillStyle=this.color,e.fill(),this.isGroup?e.strokeStyle="#000":e.strokeStyle=this.color,e.lineWidth=1,e.stroke()};if(this.isGroup){o(this.x,this.y);const n=2*i*Math.cos(Math.PI/4);o(this.x-n,this.y-n),o(this.x+n,this.y-n),o(this.x-n,this.y+n),o(this.x+n,this.y+n)}else o(this.x,this.y);if(this.isSelected){const n=this.isGroup?18:9;e.strokeStyle="#22c55e",e.lineWidth=2,e.beginPath(),e.arc(this.x,this.y,n,0,Math.PI*2),e.stroke()}}}class K extends M{constructor(t,i,o){super(i,o,"rgba(255,255,255,0.5)");c(this,"shapeType");c(this,"coneDistance",50);c(this,"showLines",!0);c(this,"groupColor","#f97316");c(this,"groupHeight",10);c(this,"smoothingFactor",5);c(this,"width",0);c(this,"height",0);c(this,"radiusX",0);c(this,"radiusY",0);c(this,"endX",0);c(this,"endY",0);c(this,"points",[]);c(this,"selectedConeIndex",0);c(this,"coneColors",new Map);this.shapeType=t,(t==="triangle"||t==="freehand")&&(this.points=[{x:0,y:0}])}drawShape(t){if(this.showLines){if(t.beginPath(),this.shapeType==="line")t.moveTo(0,0),t.lineTo(this.endX,this.endY);else if(this.shapeType==="rectangle")t.rect(-this.width/2,-this.height/2,this.width,this.height);else if(this.shapeType==="ellipse")t.ellipse(0,0,Math.max(0,this.radiusX),Math.max(0,this.radiusY),0,0,2*Math.PI);else if(this.shapeType==="triangle"){if(this.points.length>0){t.moveTo(this.points[0].x,this.points[0].y);for(let o=1;o<this.points.length;o++)t.lineTo(this.points[o].x,this.points[o].y);t.closePath()}}else if(this.shapeType==="freehand"){const o=this.getSmoothedPolyline();if(o.length>0){t.moveTo(o[0].x,o[0].y);for(let n=1;n<o.length;n++)t.lineTo(o[n].x,o[n].y)}}t.strokeStyle=this.isSelected?"rgba(255,255,255,0.8)":"rgba(255,255,255,0.4)",t.lineWidth=1,t.setLineDash([5,5]),t.stroke(),t.setLineDash([])}this.generateConePositionsLocal().forEach((o,n)=>{let r=this.coneColors.get(n)||this.groupColor,h=this.isSelected&&n===this.selectedConeIndex;t.save(),t.translate(o.x,o.y),t.rotate(-this.rotation),v.drawCone(t,0,0,r,this.groupHeight,h),t.restore()})}containsPointLocal(t,i){const o=this.generateConePositionsLocal();for(let h=0;h<o.length;h++){const a=o[h],l=t-a.x,f=i-a.y;if(l*l+f*f<225)return this.selectedConeIndex=h,!0}let n=!1;const r=10;if(this.shapeType==="rectangle"){const h=this.width/2,a=this.height/2,l=h+r,f=a+r,p=Math.max(0,h-r),d=Math.max(0,a-r),y=Math.abs(t)<=l&&Math.abs(i)<=f,u=Math.abs(t)<=p&&Math.abs(i)<=d;y&&!u&&(n=!0)}else if(this.shapeType==="ellipse"){const h=this.radiusX,a=this.radiusY;if(h>0&&a>0){const l=t*t/(h*h)+i*i/(a*a);l>=.8&&l<=1.2&&(n=!0)}}else if(this.shapeType==="line"){const h=this.endX*this.endX+this.endY*this.endY;if(h===0)return!1;let a=(t*this.endX+i*this.endY)/h;a=Math.max(0,Math.min(1,a));const l=a*this.endX,f=a*this.endY;Math.hypot(t-l,i-f)<r&&(n=!0)}else{let h=this.points;if(this.shapeType==="freehand"&&(h=this.getSmoothedPolyline()),h.length>1){for(let a=0;a<h.length-1;a++){const l=h[a],f=h[a+1],p=(f.x-l.x)**2+(f.y-l.y)**2;if(p===0)continue;let d=((t-l.x)*(f.x-l.x)+(i-l.y)*(f.y-l.y))/p;d=Math.max(0,Math.min(1,d));const y=l.x+d*(f.x-l.x),u=l.y+d*(f.y-l.y);if(Math.hypot(t-y,i-u)<r){n=!0;break}}if(!n&&this.shapeType==="triangle"){const a=h[h.length-1],l=h[0],f=(l.x-a.x)**2+(l.y-a.y)**2;let p=((t-a.x)*(l.x-a.x)+(i-a.y)*(l.y-a.y))/f;p=Math.max(0,Math.min(1,p));const d=a.x+p*(l.x-a.x),y=a.y+p*(l.y-a.y);Math.hypot(t-d,i-y)<r&&(n=!0)}}}return n?(this.selectedConeIndex=0,!0):!1}getHandles(){if(this.shapeType==="rectangle"){const t=this.width/2,i=this.height/2;return[{id:"tl",x:-t,y:-i,cursor:"nw-resize"},{id:"br",x:t,y:i,cursor:"se-resize"},{id:"rotate",x:0,y:-i-25,cursor:"grab"}]}else if(this.shapeType==="ellipse"){const t=this.radiusX,i=this.radiusY;return[{id:"br",x:t,y:i,cursor:"se-resize"},{id:"rotate",x:0,y:-i-25,cursor:"grab"}]}else{if(this.shapeType==="line")return[{id:"start",x:0,y:0,cursor:"move"},{id:"end",x:this.endX,y:this.endY,cursor:"move"}];if(this.shapeType==="triangle")return this.points.map((t,i)=>({id:`p${i}`,x:t.x,y:t.y,cursor:"move"})).concat([{id:"rotate",x:0,y:-50,cursor:"grab"}])}return[]}resize(t,i,o){if(this.shapeType==="rectangle"){const n=this.width/2,r=this.height/2;let h=0,a=0;t==="tl"?(h=n,a=r):t==="br"&&(h=-n,a=-r);const l=Math.abs(i-h),f=Math.abs(o-a),p=(i+h)/2,d=(o+a)/2;this.width=Math.max(10,l),this.height=Math.max(10,f);const y=this.rotatePoint(p,d,this.rotation);this.x+=y.x,this.y+=y.y}else if(this.shapeType==="ellipse")this.radiusX=Math.max(5,Math.abs(i)),this.radiusY=Math.max(5,Math.abs(o));else if(this.shapeType==="line"){if(t==="end")this.endX=i,this.endY=o;else if(t==="start"){const n=this.rotatePoint(i,o,this.rotation);this.x+=n.x,this.y+=n.y,this.endX-=i,this.endY-=o}}else if(this.shapeType==="triangle"){const n=parseInt(t.charAt(1));!isNaN(n)&&this.points[n]&&(this.points[n].x=i,this.points[n].y=o)}}getSmoothedPolyline(){if(this.shapeType!=="freehand"||this.points.length<3||this.smoothingFactor<=1)return this.points;const t=[];for(let r=0;r<this.points.length;r+=Math.ceil(this.smoothingFactor))t.push(this.points[r]);t[t.length-1]!==this.points[this.points.length-1]&&t.push(this.points[this.points.length-1]);const i=[];if(t.length<2)return t;i.push(t[0]);let o=t[0];for(let r=1;r<t.length-1;r++){const h=t[r],a=t[r+1],l={x:(h.x+a.x)/2,y:(h.y+a.y)/2},f=10;for(let p=1;p<=f;p++){const d=p/f,y=1-d,u=y*y*o.x+2*y*d*h.x+d*d*l.x,g=y*y*o.y+2*y*d*h.y+d*d*l.y;i.push({x:u,y:g})}o=l}const n=t[t.length-1];return i.push(n),i}generateConePositionsLocal(){const t=[],i=Math.max(20,this.coneDistance),o=(n,r)=>{const h=Math.hypot(r.x-n.x,r.y-n.y),a=Math.max(1,Math.round(h/i));for(let l=0;l<a;l++){const f=l/a;t.push({x:n.x+(r.x-n.x)*f,y:n.y+(r.y-n.y)*f})}};if(this.shapeType==="line"){const n={x:0,y:0},r={x:this.endX,y:this.endY};o(n,r),t.push(r)}else if(this.shapeType==="rectangle"){const n=this.width/2,r=this.height/2,h={x:-n,y:-r},a={x:n,y:-r},l={x:n,y:r},f={x:-n,y:r};o(h,a),o(a,l),o(l,f),o(f,h)}else if(this.shapeType==="triangle")this.points.length===3&&(o(this.points[0],this.points[1]),o(this.points[1],this.points[2]),o(this.points[2],this.points[0]));else if(this.shapeType==="ellipse"){const n=Math.max(8,Math.round(Math.PI*2*Math.max(this.radiusX,this.radiusY)/i));for(let r=0;r<n;r++){const h=r/n*Math.PI*2;t.push({x:this.radiusX*Math.cos(h),y:this.radiusY*Math.sin(h)})}}else if(this.shapeType==="freehand"){const n=this.getSmoothedPolyline();if(n.length>0){t.push(n[0]);let r=n[0],h=0;for(let l=1;l<n.length;l++){const f=Math.hypot(n[l].x-r.x,n[l].y-r.y);f+h>=i?(t.push(n[l]),h=0):h+=f,r=n[l]}const a=n[n.length-1];if(t.length>0){const l=t[t.length-1];Math.hypot(a.x-l.x,a.y-l.y)>5&&t.push(a)}else t.push(a)}}return t}}class Q extends x{constructor(e,t){super(e,t,"#ffffff"),this.width=100,this.height=40,this.hasFill=!1}drawShape(e){const t=this.width,i=this.height,o=t/2,n=i/2;e.save(),e.beginPath(),e.rect(-o,-n,t,i),e.clip(),e.beginPath(),e.strokeStyle="#cccccc",e.lineWidth=1;const r=8,h=t+i;for(let l=-h;l<=h;l+=r)e.moveTo(-n-l,-n),e.lineTo(n-l,n);for(let l=-h;l<=h;l+=r)e.moveTo(l+n,-n),e.lineTo(l-n,n);e.stroke(),e.restore(),e.beginPath(),e.rect(-o,-n,t,i),e.strokeStyle=this.color==="#ffffff"?"#000000":this.color,e.lineWidth=2,e.stroke(),e.beginPath();const a=1;e.moveTo(-o-a,n),e.lineTo(o+a,n),e.lineWidth=6,e.strokeStyle=this.color==="#ffffff"?"#000000":this.color,e.lineCap="butt",e.stroke()}}function tt(s){return s instanceof D?lt(s):s instanceof K?gt(s):s instanceof Q?St(s):s instanceof x?P(s,"rectangle"):s instanceof E?P(s,"ellipse"):s instanceof O?P(s,"triangle"):s instanceof W?P(s,"line"):s instanceof H?P(s,"freehand"):s instanceof v?yt(s):s instanceof V?wt(s):(console.warn("EntitySerializer: unknown entity type, skipping",s),null)}function et(s){switch(s.type){case"player":return ct(s);case"shape":return pt(s);case"cone":return ut(s);case"coneGroup":return mt(s);case"ball":return Tt(s);case"goal":return bt(s);default:return console.warn("EntitySerializer: unknown serialized type, skipping",s),null}}function lt(s){return{type:"player",id:s.id,x:s.x,y:s.y,initialX:s.initialX,initialY:s.initialY,number:s.number,color:s.color,team:s.team,hasBall:s.hasBall,ballColor:s.ballColor,description:s.description,rotation:s.rotation,actions:s.actions.map(ft)}}function ct(s){const e=new D(s.initialX,s.initialY,s.number,s.color);return e.id=s.id,e.x=s.x,e.y=s.y,e.initialX=s.initialX,e.initialY=s.initialY,e.team=s.team,e.hasBall=s.hasBall,s.ballColor!==void 0&&(e.ballColor=s.ballColor),e.description=s.description||"",e.rotation=s.rotation||0,e.actions=s.actions.map(t=>dt(t,e)),e}function ft(s){const e={id:s.id,type:s.type,startX:s.startX,startY:s.startY,endX:s.endX,endY:s.endY,sceneIndex:s.sceneIndex,pathType:s.pathType,points:s.points.map(t=>({x:t.x,y:t.y})),config:{...s.config},speed:s.speed,waitBefore:s.waitBefore};return(s instanceof _||s instanceof J)&&(e.gesture=s.gesture),s instanceof $&&(e.dribbleType=s.dribbleType,e.style=s.style),s instanceof q&&(e.radius=s.radius),s instanceof Z&&(e.angle=s.angle),e}function dt(s,e){let t;switch(s.type){case"run":t=new j(s.startX,s.startY,s.endX,s.endY);break;case"pass":{const i=new _(s.startX,s.startY,s.endX,s.endY);s.gesture!==void 0&&(i.gesture=s.gesture),t=i;break}case"dribble":{const i=new $(s.startX,s.startY,s.endX,s.endY);s.dribbleType!==void 0&&(i.dribbleType=s.dribbleType),s.style!==void 0&&(i.style=s.style),t=i;break}case"shoot":{const i=new J(s.startX,s.startY,s.endX,s.endY);s.gesture!==void 0&&(i.gesture=s.gesture),t=i;break}case"tackle":{const i=new q(s.startX,s.startY,s.endX,s.endY);s.radius!==void 0&&(i.radius=s.radius),t=i;break}case"turn":{const i=new Z(s.startX,s.startY,s.endX,s.endY);s.angle!==void 0&&(i.angle=s.angle),t=i;break}default:t=new j(s.startX,s.startY,s.endX,s.endY)}return t.id=s.id,t.sceneIndex=s.sceneIndex||0,t.pathType=s.pathType||"straight",t.points=(s.points||[]).map(i=>({x:i.x,y:i.y})),t.config=s.config||{preEvent:"auto",postEvent:"auto"},s.speed!==void 0&&(t.speed=s.speed),s.waitBefore!==void 0&&(t.waitBefore=s.waitBefore),t.owner=e,t}function P(s,e){const t={type:"shape",shapeKind:e,id:s.id,x:s.x,y:s.y,rotation:s.rotation,color:s.color,lineWidth:s.lineWidth,strokeType:s.strokeType,hasFill:s.hasFill,fillOpacity:s.fillOpacity};return s instanceof x?(t.width=s.width,t.height=s.height):s instanceof E?(t.radiusX=s.radiusX,t.radiusY=s.radiusY):s instanceof O?t.points=s.points.map(i=>({x:i.x,y:i.y})):s instanceof W?(t.endX=s.endX,t.endY=s.endY,t.startMarker=s.startMarker,t.endMarker=s.endMarker):s instanceof H&&(t.points=s.points.map(i=>({x:i.x,y:i.y})),t.smoothingFactor=s.smoothingFactor),t}function pt(s){let e;switch(s.shapeKind){case"rectangle":{const t=new x(s.x,s.y,s.color);t.width=s.width||0,t.height=s.height||0,e=t;break}case"ellipse":{const t=new E(s.x,s.y,s.color);t.radiusX=s.radiusX||0,t.radiusY=s.radiusY||0,e=t;break}case"triangle":{const t=new O(s.x,s.y,s.color);s.points&&(t.points=s.points.map(i=>({x:i.x,y:i.y}))),e=t;break}case"line":{const t=new W(s.x,s.y,s.color);t.endX=s.endX||0,t.endY=s.endY||0,t.startMarker=s.startMarker||"none",t.endMarker=s.endMarker||"none",e=t;break}case"freehand":{const t=new H(s.x,s.y,s.color);s.points&&(t.points=s.points.map(i=>({x:i.x,y:i.y}))),s.smoothingFactor!==void 0&&(t.smoothingFactor=s.smoothingFactor),e=t;break}default:e=new x(s.x,s.y,s.color)}return e.id=s.id,e.rotation=s.rotation||0,e.lineWidth=s.lineWidth??3,e.strokeType=s.strokeType||"solid",e.hasFill=s.hasFill??!0,e.fillOpacity=s.fillOpacity??.2,e}function yt(s){return{type:"cone",id:s.id,x:s.x,y:s.y,color:s.color,height:s.height}}function ut(s){const e=new v(s.x,s.y,s.color,s.height);return e.id=s.id,e}function gt(s){const e={type:"coneGroup",id:s.id,x:s.x,y:s.y,rotation:s.rotation,shapeType:s.shapeType,coneDistance:s.coneDistance,showLines:s.showLines,groupColor:s.groupColor,groupHeight:s.groupHeight,smoothingFactor:s.smoothingFactor,color:s.color,lineWidth:s.lineWidth,strokeType:s.strokeType,hasFill:s.hasFill,fillOpacity:s.fillOpacity};if(s.shapeType==="rectangle"?(e.width=s.width,e.height=s.height):s.shapeType==="ellipse"?(e.radiusX=s.radiusX,e.radiusY=s.radiusY):s.shapeType==="line"?(e.endX=s.endX,e.endY=s.endY):(s.shapeType==="triangle"||s.shapeType==="freehand")&&(e.points=s.points.map(t=>({x:t.x,y:t.y}))),s.coneColors.size>0){const t={};s.coneColors.forEach((i,o)=>{t[o]=i}),e.coneColors=t}return e}function mt(s){const e=new K(s.shapeType,s.x,s.y);if(e.id=s.id,e.rotation=s.rotation||0,e.coneDistance=s.coneDistance??50,e.showLines=s.showLines??!0,e.groupColor=s.groupColor||"#f97316",e.groupHeight=s.groupHeight??10,e.smoothingFactor=s.smoothingFactor??5,e.color=s.color||"rgba(255,255,255,0.5)",e.lineWidth=s.lineWidth??3,e.strokeType=s.strokeType||"solid",e.hasFill=s.hasFill??!0,e.fillOpacity=s.fillOpacity??.2,s.shapeType==="rectangle"?(e.width=s.width||0,e.height=s.height||0):s.shapeType==="ellipse"?(e.radiusX=s.radiusX||0,e.radiusY=s.radiusY||0):s.shapeType==="line"?(e.endX=s.endX||0,e.endY=s.endY||0):(s.shapeType==="triangle"||s.shapeType==="freehand")&&s.points&&(e.points=s.points.map(t=>({x:t.x,y:t.y}))),s.coneColors)for(const[t,i]of Object.entries(s.coneColors))e.coneColors.set(Number(t),i);return e}function wt(s){return{type:"ball",id:s.id,x:s.x,y:s.y,color:s.color,isGroup:s.isGroup}}function Tt(s){const e=new V(s.x,s.y,s.color);return e.id=s.id,e.isGroup=s.isGroup||!1,e}function St(s){return{type:"goal",id:s.id,x:s.x,y:s.y,rotation:s.rotation,color:s.color,width:s.width,height:s.height}}function bt(s){const e=new Q(s.x,s.y);return e.id=s.id,e.rotation=s.rotation||0,e.color=s.color||"#ffffff",e.width=s.width||100,e.height=s.height||40,e}const kt=Object.freeze(Object.defineProperty({__proto__:null,deserializeEntity:et,serializeEntity:tt},Symbol.toStringTag,{value:"Module"})),Mt=1,L="easydrill-exercise-list",k="easydrill-exercise-",Xt=2e3,C=[];function xt(s){return C.push(s),()=>{const e=C.indexOf(s);e>=0&&C.splice(e,1)}}function w(s,e){for(const t of C)try{t(s,e)}catch{}}class A{constructor(){c(this,"autoSaveTimer",null)}static serialize(e,t,i,o="draft",n){const r=new Date().toISOString(),h=[];for(const a of e.entities){const l=tt(a);l&&h.push(l)}return{id:t,version:Mt,metadata:i,editorState:{camera:{x:e.camera.x,y:e.camera.y,zoom:e.camera.zoom,rotation:e.camera.rotation}},zoneConfig:e.zoneConfig??null,entities:{items:h},scenes:{count:e.sceneCount,current:e.currentScene},createdAt:n||r,updatedAt:r,status:o}}static deserialize(e,t){var i;t.zoneConfig&&(e.zoneConfig={...t.zoneConfig}),e.entities.length=0;for(const o of t.entities.items){const n=et(o);n&&e.entities.push(n)}for(const o of e.entities)o instanceof D&&o.updateActionChain();if(e.sceneCount=t.scenes.count||1,e.currentScene=t.scenes.current||0,e.updateSceneState(),(i=t.editorState)!=null&&i.camera){const o=t.editorState.camera;e.camera.x=o.x,e.camera.y=o.y,e.camera.zoom=o.zoom,e.camera.rotation=o.rotation}e.selectEntity(null)}static generateThumbnail(e){try{const t=document.createElement("canvas"),i=.25;return t.width=e.width*i,t.height=e.height*i,t.getContext("2d").drawImage(e,0,0,t.width,t.height),t.toDataURL("image/webp",.6)}catch{return""}}scheduleAutoSave(e,t,i){this.autoSaveTimer!==null&&clearTimeout(this.autoSaveTimer),this.autoSaveTimer=window.setTimeout(()=>{this.autoSaveTimer=null,this.saveToLocalStorage(e,t,i,"draft")},Xt)}cancelAutoSave(){this.autoSaveTimer!==null&&(clearTimeout(this.autoSaveTimer),this.autoSaveTimer=null)}saveToLocalStorage(e,t,i,o="draft"){const n=this.loadFromLocalStorage(e),r=A.serialize(t,e,i,o,n==null?void 0:n.createdAt);r.metadata.title=i.title||"Sin título";const h=A.generateThumbnail(t.canvas);localStorage.setItem(k+e,JSON.stringify(r)),this.updateExerciseList(e,{id:e,title:r.metadata.title,status:r.status,updatedAt:r.updatedAt,createdAt:r.createdAt,thumbnail:h,tags:r.metadata.tags})}loadFromLocalStorage(e){const t=localStorage.getItem(k+e);if(!t)return null;try{return JSON.parse(t)}catch{return null}}deleteFromLocalStorage(e){localStorage.removeItem(k+e);const i=this.getExerciseList().filter(o=>o.id!==e);localStorage.setItem(L,JSON.stringify(i))}getExerciseList(){const e=localStorage.getItem(L);if(!e)return[];try{return JSON.parse(e)}catch{return[]}}updateExerciseList(e,t){const i=this.getExerciseList(),o=i.findIndex(n=>n.id===e);o>=0?i[o]=t:i.push(t),i.sort((n,r)=>new Date(r.updatedAt).getTime()-new Date(n.updatedAt).getTime()),localStorage.setItem(L,JSON.stringify(i))}async save(e,t,i,o="complete"){if(this.saveToLocalStorage(e,t,i,o),Y()){const n=this.loadFromLocalStorage(e);if(n){const r=A.generateThumbnail(t.canvas);this.syncToServer(e,n,r)}}}async load(e){if(Y())try{const t=await b(`/api/exercises/${encodeURIComponent(e)}`);if(t.ok){const i=await t.json();return localStorage.setItem(k+e,JSON.stringify(i)),i}}catch{}return this.loadFromLocalStorage(e)}updateMetadata(e,t){const i=this.loadFromLocalStorage(e);if(!i)return!1;i.metadata={...t,title:t.title||"Sin título"},i.updatedAt=new Date().toISOString(),localStorage.setItem(k+e,JSON.stringify(i));const n=this.getExerciseList().find(r=>r.id===e);return this.updateExerciseList(e,{id:e,title:i.metadata.title,status:i.status,updatedAt:i.updatedAt,createdAt:i.createdAt,thumbnail:n==null?void 0:n.thumbnail,tags:i.metadata.tags}),Y()&&this.syncMetadataToServer(e,i.metadata,i.version),!0}async list(){if(Y())try{const e=await b("/api/exercises");if(e.ok){const t=await e.json();return this.mergeServerListToLocal(t),this.getExerciseList()}}catch{}return this.getExerciseList()}async delete(e){if(this.deleteFromLocalStorage(e),Y())try{await b(`/api/exercises/${encodeURIComponent(e)}`,{method:"DELETE"})}catch{}}async syncToServer(e,t,i){w("syncing");const o={id:t.id,version:t.version,status:t.status,metadata:t.metadata,editorState:t.editorState,zoneConfig:t.zoneConfig,entities:t.entities,scenes:t.scenes,thumbnail:i||void 0,createdAt:t.createdAt,updatedAt:t.updatedAt};try{let n=await b(`/api/exercises/${encodeURIComponent(e)}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(n.status===404&&(n=await b("/api/exercises",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})),n.status===403){const r=await n.json();w("error",r.message||"Límite de plan alcanzado");return}if(n.status===409){const r=await n.json();w("error",r.message||"Conflicto de versión");return}n.ok?w("synced"):w("error",`Error del servidor (${n.status})`)}catch{w("local-only")}}async syncMetadataToServer(e,t,i){w("syncing");try{let o=await b(`/api/exercises/${encodeURIComponent(e)}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({metadata:t,version:i})});if(o.status===404){w("local-only");return}if(o.ok)w("synced");else if(o.status===409){const n=await o.json();w("error",n.message||"Conflicto de versión")}else w("error",`Error del servidor (${o.status})`)}catch{w("local-only")}}async mergeServerListToLocal(e){const t=this.getExerciseList(),i=new Set(e.map(n=>n.id)),o=new Set(t.map(n=>n.id));for(const n of e)if(!o.has(n.id))t.push(n);else{const r=t.findIndex(h=>h.id===n.id);r>=0&&(t[r]=n)}t.sort((n,r)=>new Date(r.updatedAt).getTime()-new Date(n.updatedAt).getTime()),localStorage.setItem(L,JSON.stringify(t));for(const n of t)if(!i.has(n.id)){const r=this.loadFromLocalStorage(n.id);r&&this.syncToServer(n.id,r,n.thumbnail??"")}}static generateId(){return crypto.randomUUID()}}export{V as B,v as C,at as D,A as E,H as F,Q as G,W as L,D as P,x as R,J as S,O as T,X as a,M as b,E as c,Z as d,q as e,j as f,$ as g,_ as h,K as i,kt as j,xt as o};
