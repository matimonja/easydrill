import"./modulepreload-polyfill-B5Qt9EMX.js";class K{x=0;y=0;zoom=1;rotation=0;minZoom=.1;maxZoom=5;constructor(t=0,e=0){this.x=t,this.y=e}applyTransform(t,e){t.translate(e.width/2,e.height/2),t.scale(this.zoom,this.zoom),t.rotate(this.rotation),t.translate(-this.x,-this.y)}screenToWorld(t,e,i){const s=t-i.width/2,a=e-i.height/2,n=Math.cos(-this.rotation),o=Math.sin(-this.rotation),l=s*n-a*o,r=s*o+a*n,h=l/this.zoom+this.x,c=r/this.zoom+this.y;return{x:h,y:c}}zoomAt(t,e,i,s){const a=this.screenToWorld(e,i,s);this.zoom*=t,this.zoom=Math.max(this.minZoom,Math.min(this.zoom,this.maxZoom));const n=this.screenToWorld(e,i,s);this.x+=a.x-n.x,this.y+=a.y-n.y}pan(t,e){const i=Math.cos(-this.rotation),s=Math.sin(-this.rotation),a=t*i-e*s,n=t*s+e*i;this.x-=a/this.zoom,this.y-=n/this.zoom}toggleRotation(){this.rotation===0?this.rotation=-Math.PI/2:this.rotation=0}}class tt{width;height;color="#3b82f6";runoffColor="#f472b6";lineColor="#ffffff";constructor(t=914,e=550){this.width=t,this.height=e}draw(t){const e=this.width/2,i=this.height/2,s=50;t.fillStyle=this.runoffColor,t.fillRect(-(e+s),-(i+s),this.width+s*2,this.height+s*2),t.fillStyle=this.color,t.fillRect(-e,-i,this.width,this.height),t.strokeStyle=this.lineColor,t.lineWidth=2,t.strokeRect(-e,-i,this.width,this.height),t.beginPath(),t.moveTo(0,-i),t.lineTo(0,i),t.stroke();const a=229;t.beginPath(),t.moveTo(-e+a,-i),t.lineTo(-e+a,i),t.stroke(),t.beginPath(),t.moveTo(e-a,-i),t.lineTo(e-a,i),t.stroke(),this.drawStrikingCircle(t,-e,1),this.drawStrikingCircle(t,e,-1),this.drawSpot(t,-e+64,0),this.drawSpot(t,e-64,0),this.drawMarks(t,-e,1),this.drawMarks(t,e,-1),this.drawGoal(t,-e,1),this.drawGoal(t,e,-1)}drawMarks(t,e,i){const s=this.height/2,a=3;t.strokeStyle=this.lineColor,t.lineWidth=2,t.beginPath(),[-18.3,18.3].forEach(l=>{const r=l<0?-1:1,h=l+50*r;t.moveTo(e,h),t.lineTo(e+a*i,h);const c=l+100*r;t.moveTo(e,c),t.lineTo(e+a*i,c)});const o=e+50*i;t.moveTo(o,-s),t.lineTo(o,-s+a),t.moveTo(o,s),t.lineTo(o,s-a),t.stroke()}drawStrikingCircle(t,e,i){t.strokeStyle=this.lineColor,t.lineWidth=2,t.beginPath();const o=e,l=-18.3,r=e,h=18.3;i===1?(t.arc(o,l,146.3,-Math.PI/2,0),t.lineTo(o+146.3,h),t.arc(r,h,146.3,0,Math.PI/2)):(t.moveTo(e,l-146.3),t.arc(o,l,146.3,-Math.PI/2,Math.PI,!0),t.lineTo(e-146.3,h),t.arc(r,h,146.3,Math.PI,Math.PI/2,!0)),t.stroke(),t.save(),t.setLineDash([10,10]),t.beginPath(),i===1?(t.arc(o,l,196.3,-Math.PI/2,0),t.lineTo(o+196.3,h),t.arc(r,h,196.3,0,Math.PI/2)):(t.arc(o,l,196.3,-Math.PI/2,Math.PI,!0),t.lineTo(e-196.3,h),t.arc(r,h,196.3,Math.PI,Math.PI/2,!0)),t.stroke(),t.restore()}drawSpot(t,e,i){t.beginPath(),t.fillStyle=this.lineColor,t.arc(e,i,2,0,Math.PI*2),t.fill()}drawGoal(t,e,i){t.strokeStyle=this.lineColor,t.lineWidth=2;const n=i===1?e-12:e,o=-36.6/2;t.strokeRect(n,o,12,36.6)}}const O="#ffffff",S={color:"#ffffff",strokeType:"solid",hasFill:!0,fillOpacity:.2,startMarker:"none",endMarker:"none",smoothingFactor:5};class v{id;x;y;color;number;isSelected=!1;team="A";hasBall=!1;ballColor;description="";actions=[];initialX;initialY;rotation=0;sceneDeltaX=0;sceneDeltaY=0;radius=15;constructor(t,e,i="1",s="#ef4444"){this.id=crypto.randomUUID(),this.x=t,this.y=e,this.initialX=t,this.initialY=e,this.number=i,this.color=s}setPosition(t,e){this.initialX=t-this.sceneDeltaX,this.initialY=e-this.sceneDeltaY,this.x=t,this.y=e,this.updateActionChain()}updateForScene(t){let e=this.initialX,i=this.initialY,s=0;for(const o of this.actions)if(o.sceneIndex<t){o.setStartPosition(e,i);const l=o.getFinalPosition();e=l.x,i=l.y,o.movesPlayer&&(s=o.getHeadingAt(1))}this.sceneDeltaX=e-this.initialX,this.sceneDeltaY=i-this.initialY,this.x=e,this.y=i,this.rotation=s;let a=e,n=i;for(const o of this.actions)if(o.sceneIndex>=t){o.setStartPosition(a,n);const l=o.getFinalPosition();a=l.x,n=l.y}}updateActionChain(){let t=this.initialX,e=this.initialY;for(const i of this.actions){i.setStartPosition(t,e);const s=i.getFinalPosition();t=s.x,e=s.y}}containsPoint(t,e){const i=this.x-t,s=this.y-e;return i*i+s*s<=this.radius*this.radius}draw(t,e=0){if(this.actions.forEach(i=>{i.sceneIndex===e&&i.draw(t)}),this.isSelected&&(t.beginPath(),t.arc(this.x,this.y,this.radius+4,0,Math.PI*2),t.fillStyle="rgba(255, 255, 0, 0.5)",t.fill(),t.strokeStyle="yellow",t.lineWidth=2,t.stroke()),t.beginPath(),t.arc(this.x,this.y,this.radius,0,Math.PI*2),t.fillStyle=this.color,t.fill(),t.strokeStyle="white",t.lineWidth=2,t.stroke(),t.fillStyle="white",t.font="bold 14px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.number,this.x,this.y),this.hasBall){const s=this.rotation+Math.PI/4,a=this.x+Math.cos(s)*17,n=this.y+Math.sin(s)*17;t.beginPath(),t.arc(a,n,5,0,Math.PI*2),t.fillStyle=this.ballColor??O,t.fill(),t.strokeStyle="#fff",t.lineWidth=1,t.stroke()}}}class E{id;x;y;rotation=0;color=S.color;isSelected=!1;lineWidth=3;strokeType=S.strokeType;hasFill=S.hasFill;fillOpacity=S.fillOpacity;constructor(t,e,i=S.color){this.id=crypto.randomUUID(),this.x=t,this.y=e,this.color=i}setPosition(t,e){this.x=t,this.y=e}draw(t,e){t.save(),t.translate(this.x,this.y),t.rotate(this.rotation),this.isSelected?(t.shadowColor="yellow",t.shadowBlur=10,t.strokeStyle="yellow"):t.strokeStyle=this.color,this.strokeType==="dashed"?t.setLineDash([10,5]):this.strokeType==="dotted"?t.setLineDash([2,5]):t.setLineDash([]),t.lineWidth=this.lineWidth,this.drawShape(t),t.restore()}getFillColor(){let t=this.color.startsWith("#")?this.color.slice(1):this.color;t.length===3&&(t=t.split("").map(a=>a+a).join(""));const e=parseInt(t.substring(0,2),16)||0,i=parseInt(t.substring(2,4),16)||0,s=parseInt(t.substring(4,6),16)||0;return`rgba(${e},${i},${s},${this.fillOpacity})`}containsPoint(t,e){const i=t-this.x,s=e-this.y,a=Math.cos(-this.rotation),n=Math.sin(-this.rotation),o=i*a-s*n,l=i*n+s*a;return this.containsPointLocal(o,l)}rotatePoint(t,e,i){const s=Math.cos(i),a=Math.sin(i);return{x:t*s-e*a,y:t*a+e*s}}}class B extends E{width=0;height=0;drawShape(t){t.beginPath(),t.rect(-this.width/2,-this.height/2,this.width,this.height),this.hasFill&&(t.fillStyle=this.getFillColor(),t.fill()),t.stroke()}containsPointLocal(t,e){const i=this.width/2,s=this.height/2,a=10,n=Math.abs(t- -i)<a&&e>=-s-a&&e<=s+a,o=Math.abs(t-i)<a&&e>=-s-a&&e<=s+a,l=Math.abs(e- -s)<a&&t>=-i-a&&t<=i+a,r=Math.abs(e-s)<a&&t>=-i-a&&t<=i+a,h=Math.abs(t)<=i&&Math.abs(e)<=s;return n||o||l||r||h}getHandles(){const t=this.width/2,e=this.height/2;return[{id:"tl",x:-t,y:-e,cursor:"nw-resize"},{id:"tr",x:t,y:-e,cursor:"ne-resize"},{id:"br",x:t,y:e,cursor:"se-resize"},{id:"bl",x:-t,y:e,cursor:"sw-resize"},{id:"rotate",x:0,y:-e-25,cursor:"grab"}]}resize(t,e,i){const s=this.width/2,a=this.height/2;let n=0,o=0;t==="tl"?(n=s,o=a):t==="tr"?(n=-s,o=a):t==="br"?(n=-s,o=-a):t==="bl"&&(n=s,o=-a);const l=Math.abs(e-n),r=Math.abs(i-o),h=(e+n)/2,c=(i+o)/2;this.width=Math.max(1,l),this.height=Math.max(1,r);const d=this.rotatePoint(h,c,this.rotation);this.x+=d.x,this.y+=d.y}}class $ extends E{radiusX=0;radiusY=0;drawShape(t){t.beginPath(),t.ellipse(0,0,Math.max(0,this.radiusX),Math.max(0,this.radiusY),0,0,2*Math.PI),this.hasFill&&(t.fillStyle=this.getFillColor(),t.fill()),t.stroke(),this.isSelected&&(t.save(),t.strokeStyle="#888",t.setLineDash([5,5]),t.lineWidth=1,t.strokeRect(-this.radiusX,-this.radiusY,this.radiusX*2,this.radiusY*2),t.restore())}containsPointLocal(t,e){const i=Math.max(1,this.radiusX),s=Math.max(1,this.radiusY),a=t*t/(i*i)+e*e/(s*s);return Math.abs(a-1)<.2||a<=1}getHandles(){const t=this.radiusX,e=this.radiusY;return[{id:"tl",x:-t,y:-e,cursor:"nw-resize"},{id:"tr",x:t,y:-e,cursor:"ne-resize"},{id:"br",x:t,y:e,cursor:"se-resize"},{id:"bl",x:-t,y:e,cursor:"sw-resize"},{id:"rotate",x:0,y:-e-25,cursor:"grab"}]}resize(t,e,i){const s=this.radiusX,a=this.radiusY;let n=0,o=0;t==="tl"?(n=s,o=a):t==="tr"?(n=-s,o=a):t==="br"?(n=-s,o=-a):t==="bl"&&(n=s,o=-a);const l=Math.abs(e-n),r=Math.abs(i-o),h=(e+n)/2,c=(i+o)/2;this.radiusX=Math.max(1,l/2),this.radiusY=Math.max(1,r/2);const d=this.rotatePoint(h,c,this.rotation);this.x+=d.x,this.y+=d.y}}class R extends E{points=[];constructor(t,e,i=S.color){super(t,e,i),this.points=[{x:0,y:-50},{x:50,y:50},{x:-50,y:50}]}drawShape(t){this.points.length===3&&(t.beginPath(),t.moveTo(this.points[0].x,this.points[0].y),t.lineTo(this.points[1].x,this.points[1].y),t.lineTo(this.points[2].x,this.points[2].y),t.closePath(),this.hasFill&&(t.fillStyle=this.getFillColor(),t.fill()),t.stroke())}containsPointLocal(t,e){const i=Math.min(...this.points.map(o=>o.x)),s=Math.max(...this.points.map(o=>o.x)),a=Math.min(...this.points.map(o=>o.y)),n=Math.max(...this.points.map(o=>o.y));return t>=i-10&&t<=s+10&&e>=a-10&&e<=n+10}getHandles(){const t=Math.min(...this.points.map(i=>i.y)),e=this.points.map((i,s)=>({id:`p${s}`,x:i.x,y:i.y,cursor:"move"}));return e.push({id:"rotate",x:0,y:t-25,cursor:"grab"}),e}resize(t,e,i){const s=parseInt(t.charAt(1));!isNaN(s)&&this.points[s]&&(this.points[s].x=e,this.points[s].y=i)}}class L extends E{endX=0;endY=0;startMarker=S.startMarker;endMarker=S.endMarker;drawShape(t){t.beginPath(),t.moveTo(0,0),t.lineTo(this.endX,this.endY),t.stroke();const e=Math.atan2(this.endY,this.endX);this.startMarker==="arrow"&&this.drawArrow(t,0,0,e+Math.PI),this.endMarker==="arrow"&&this.drawArrow(t,this.endX,this.endY,e)}drawArrow(t,e,i,s){t.save(),t.translate(e,i),t.rotate(s),t.beginPath(),t.moveTo(0,0),t.lineTo(-15,5),t.lineTo(-15,-5),t.closePath(),t.fillStyle=this.color,t.setLineDash([]),t.fill(),t.restore()}containsPointLocal(t,e){const i=this.endX*this.endX+this.endY*this.endY;if(i===0)return!1;let s=(t*this.endX+e*this.endY)/i;s=Math.max(0,Math.min(1,s));const a=s*this.endX,n=s*this.endY;return Math.sqrt(Math.pow(t-a,2)+Math.pow(e-n,2))<10}getHandles(){return[{id:"start",x:0,y:0,cursor:"move"},{id:"end",x:this.endX,y:this.endY,cursor:"move"}]}resize(t,e,i){if(t==="end")this.endX=e,this.endY=i;else if(t==="start"){const s=this.rotatePoint(e,i,this.rotation);this.x+=s.x,this.y+=s.y,this.endX-=e,this.endY-=i}}}class Y extends E{points=[];smoothingFactor=S.smoothingFactor;drawShape(t){if(!(this.points.length<2)){if(t.beginPath(),this.smoothingFactor<=1){t.moveTo(this.points[0].x,this.points[0].y);for(let e=1;e<this.points.length;e++)t.lineTo(this.points[e].x,this.points[e].y)}else{const e=[];for(let s=0;s<this.points.length;s+=Math.ceil(this.smoothingFactor))e.push(this.points[s]);if(e[e.length-1]!==this.points[this.points.length-1]&&e.push(this.points[this.points.length-1]),e.length<2){t.moveTo(this.points[0].x,this.points[0].y);return}t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length-1;s++){const a=e[s],n=e[s+1],o={x:(a.x+n.x)/2,y:(a.y+n.y)/2};t.quadraticCurveTo(a.x,a.y,o.x,o.y)}const i=e[e.length-1];t.lineTo(i.x,i.y)}t.stroke()}}containsPointLocal(t,e){for(const i of this.points){const s=t-i.x,a=e-i.y;if(s*s+a*a<100)return!0}return!1}getHandles(){return[]}resize(t,e,i){}}function G(u,t,e){const i=(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y);if(i===0)return Math.hypot(u.x-t.x,u.y-t.y);let s=((u.x-t.x)*(e.x-t.x)+(u.y-t.y)*(e.y-t.y))/i;return s=Math.max(0,Math.min(1,s)),Math.hypot(u.x-(t.x+s*(e.x-t.x)),u.y-(t.y+s*(e.y-t.y)))}class b{constructor(t,e,i,s,a){this.type=t,this.startX=e,this.startY=i,this.endX=s,this.endY=a,this.id=crypto.randomUUID()}id;isSelected=!1;config={preEvent:"inmediato",postEvent:"inmediato"};sceneIndex=0;pathType="straight";points=[];smoothingFactor=5;waitBefore=0;speed=null;owner=null;get x(){return this.startX}set x(t){t-this.startX,this.setPosition(t,this.startY)}get y(){return this.startY}set y(t){t-this.startY,this.setPosition(this.startX,t)}containsPoint(t,e){if(this.type==="turn"||this.type==="tackle"){const i=this.startX-t,s=this.startY-e;let a=20;return this.type==="tackle"&&(a=this.radius||25),i*i+s*s<a*a}if(this.pathType==="straight")return G({x:t,y:e},{x:this.startX,y:this.startY},{x:this.endX,y:this.endY})<10;if(this.points.length<2)return!1;for(let i=0;i<this.points.length-1;i++)if(G({x:t,y:e},this.points[i],this.points[i+1])<10)return!0;return!1}setStartPosition(t,e){this.startX=t,this.startY=e,this.pathType==="freehand"&&this.points.length>0&&(this.points[0].x=t,this.points[0].y=e)}setPosition(t,e){const i=t-this.startX,s=e-this.startY;this.startX=t,this.startY=e,this.endX+=i,this.endY+=s,this.points.forEach(a=>{a.x+=i,a.y+=s})}getHandles(){return this.pathType==="straight"?[{id:"end",x:this.endX,y:this.endY,cursor:"move"}]:[]}resize(t,e,i){t==="end"&&(this.endX=e,this.endY=i,this.owner&&this.owner.updateActionChain())}getPathLength(){if(this.pathType==="straight")return Math.hypot(this.endX-this.startX,this.endY-this.startY);{const t=this.getSmoothedPolyline();let e=0;for(let i=0;i<t.length-1;i++)e+=Math.hypot(t[i+1].x-t[i].x,t[i+1].y-t[i].y);return e}}getPositionAt(t){if(t=Math.max(0,Math.min(1,t)),this.pathType==="straight")return{x:this.startX+(this.endX-this.startX)*t,y:this.startY+(this.endY-this.startY)*t};{const e=this.getSmoothedPolyline();if(e.length<2)return{x:this.startX,y:this.startY};const s=this.getPathLength()*t;let a=0;for(let n=0;n<e.length-1;n++){const o=Math.hypot(e[n+1].x-e[n].x,e[n+1].y-e[n].y);if(a+o>=s){const l=(s-a)/o;return{x:e[n].x+(e[n+1].x-e[n].x)*l,y:e[n].y+(e[n+1].y-e[n].y)*l}}a+=o}return e[e.length-1]}}getHeadingAt(t){const i=t,s=Math.min(1,t+.01);let a,n;return i>=.99?(a=this.getPositionAt(i-.01),n=this.getPositionAt(i)):(a=this.getPositionAt(i),n=this.getPositionAt(s)),Math.atan2(n.y-a.y,n.x-a.x)}getSmoothedPolyline(){const t=this.points,e=Math.max(1,this.smoothingFactor);if(t.length<3||e<=1)return t;const i=[];for(let n=0;n<t.length;n+=Math.ceil(e))i.push(t[n]);if(i[i.length-1]!==t[t.length-1]&&i.push(t[t.length-1]),i.length<2)return t;const s=[];s.push(i[0]);let a=i[0];for(let n=1;n<i.length-1;n++){const o=i[n],l=i[n+1],r={x:(o.x+l.x)/2,y:(o.y+l.y)/2},h=10;for(let c=1;c<=h;c++){const d=c/h,p=1-d,m=p*p*a.x+2*p*d*o.x+d*d*r.x,f=p*p*a.y+2*p*d*o.y+d*d*r.y;s.push({x:m,y:f})}a=r}return s.push(i[i.length-1]),s}drawArrowPath(t,e,i){t.beginPath();let s=this.endX,a=this.endY,n=0;if(this.pathType==="straight")t.moveTo(this.startX,this.startY),t.lineTo(this.endX,this.endY),n=Math.atan2(this.endY-this.startY,this.endX-this.startX);else if(this.points.length>0){const o=this.points,l=Math.max(1,this.smoothingFactor);let r=o;if(o.length>=3&&l>1){const h=[];for(let c=0;c<o.length;c+=Math.ceil(l))h.push(o[c]);if(h[h.length-1]!==o[o.length-1]&&h.push(o[o.length-1]),h.length>=2){r=h,t.moveTo(h[0].x,h[0].y);for(let d=1;d<h.length-1;d++){const p=h[d],m=h[d+1],f={x:(p.x+m.x)/2,y:(p.y+m.y)/2};t.quadraticCurveTo(p.x,p.y,f.x,f.y)}const c=h[h.length-1];t.lineTo(c.x,c.y)}else{t.moveTo(o[0].x,o[0].y);for(let c=1;c<o.length;c++)t.lineTo(o[c].x,o[c].y)}}else{t.moveTo(o[0].x,o[0].y);for(let h=1;h<o.length;h++)t.lineTo(o[h].x,o[h].y)}if(r.length>1){const h=r[r.length-1],c=2,d=r===o?10:3,p=r[Math.max(0,r.length-c)],m=Math.atan2(h.y-p.y,h.x-p.x),f=r[Math.max(0,r.length-d)],y=Math.atan2(h.y-f.y,h.x-f.x);let g=m-y;for(;g<=-Math.PI;)g+=2*Math.PI;for(;g>Math.PI;)g-=2*Math.PI;n=Math.abs(g)<30*Math.PI/180?y:m,s=h.x,a=h.y}}t.strokeStyle=this.isSelected?"#fff":e,t.lineWidth=2,i?t.setLineDash([10,5]):t.setLineDash([]),t.stroke(),t.setLineDash([]),t.save(),t.translate(s,a),t.rotate(n),t.beginPath(),t.moveTo(0,0),t.lineTo(-10,5),t.lineTo(-10,-5),t.closePath(),t.fillStyle=this.isSelected?"#fff":e,t.fill(),t.restore()}}class H extends b{speed=null;movesPlayer=!0;ballInteraction="none";constructor(t,e,i,s){super("run",t,e,i,s)}draw(t){this.drawArrowPath(t,"#ef4444",!0)}getFinalPosition(){return this.pathType==="straight"?{x:this.endX,y:this.endY}:this.points.length>0?this.points[this.points.length-1]:{x:this.startX,y:this.startY}}}class C extends b{speed=null;gesture="push";movesPlayer=!1;ballInteraction="propel";constructor(t,e,i,s){super("pass",t,e,i,s)}draw(t){this.drawArrowPath(t,"#eab308",!1)}getFinalPosition(){return{x:this.startX,y:this.startY}}}class k extends b{speed=null;dribbleType="derecho";style="straight";movesPlayer=!0;ballInteraction="carry";constructor(t,e,i,s){super("dribble",t,e,i,s)}draw(t){this.style==="zigzag"?this.drawZigZag(t,"#ef4444"):this.drawArrowPath(t,"#ef4444",!1)}drawZigZag(t,e){t.beginPath();const i=5,s=.2;let a=this.endX,n=this.endY,o=0;if(this.pathType==="straight"){const l=this.endX-this.startX,r=this.endY-this.startY,h=Math.hypot(l,r),c=Math.atan2(r,l);o=c,t.save(),t.translate(this.startX,this.startY),t.rotate(c),t.beginPath(),t.moveTo(0,0);const p=Math.max(0,h-15),m=Math.max(Math.ceil(p/2),2);for(let f=0;f<=m;f++){const y=f/m*p,g=i*Math.sin(y*s);t.lineTo(y,g)}t.lineTo(h,0),t.strokeStyle=this.isSelected?"#fff":e,t.lineWidth=2,t.setLineDash([]),t.stroke(),t.restore()}else{if(this.points.length<2)return;const l=this.getSmoothedPolyline();let r=0;for(let c=0;c<l.length-1;c++)r+=Math.hypot(l[c+1].x-l[c].x,l[c+1].y-l[c].y);t.beginPath();let h=0;if(t.moveTo(l[0].x,l[0].y),l.length>1){const c=l[l.length-1],d=l[Math.max(0,l.length-5)];a=c.x,n=c.y,o=Math.atan2(c.y-d.y,c.x-d.x)}for(let c=1;c<l.length;c++){const d=l[c-1],p=l[c],m=p.x-d.x,f=p.y-d.y,y=Math.hypot(m,f);if(y===0)continue;const g=-f/y,D=m/y,_=Math.max(1,Math.ceil(y/2));for(let F=1;F<=_;F++){const z=F/_,N=h+z*y,Z=d.x+z*m,Q=d.y+z*f,q=r-N,J=q<30?q/30:1,j=i*Math.sin(N*s)*J;t.lineTo(Z+g*j,Q+D*j)}h+=y}t.strokeStyle=this.isSelected?"#fff":e,t.lineWidth=2,t.setLineDash([]),t.stroke()}t.save(),t.translate(a,n),t.rotate(o),t.beginPath(),t.moveTo(0,0),t.lineTo(-10,5),t.lineTo(-10,-5),t.closePath(),t.fillStyle=this.isSelected?"#fff":e,t.fill(),t.restore()}getFinalPosition(){return this.pathType==="straight"?{x:this.endX,y:this.endY}:this.points.length>0?this.points[this.points.length-1]:{x:this.startX,y:this.startY}}}class X extends b{speed=null;gesture="pegada";movesPlayer=!1;ballInteraction="propel";constructor(t,e,i,s){super("shoot",t,e,i,s)}draw(t){this.drawArrowPath(t,"#22c55e",!1)}getFinalPosition(){return{x:this.startX,y:this.startY}}}class W extends b{radius=25;movesPlayer=!1;ballInteraction="none";constructor(t,e,i,s){super("tackle",t,e,i,s)}draw(t){t.beginPath(),t.arc(this.startX,this.startY,this.radius,0,Math.PI*2),t.strokeStyle=this.isSelected?"#fff":"#eab308",t.lineWidth=2,t.setLineDash([5,5]),t.stroke(),t.setLineDash([])}getFinalPosition(){return{x:this.startX,y:this.startY}}}class U extends b{angle=0;movesPlayer=!1;ballInteraction="none";constructor(t,e,i,s){super("turn",t,e,i,s)}draw(t){t.beginPath(),t.arc(this.startX,this.startY,19,0,Math.PI*2),t.strokeStyle=this.isSelected?"#fff":"#eab308",t.lineWidth=4,t.setLineDash([]),t.stroke()}getFinalPosition(){return{x:this.startX,y:this.startY}}}class w{constructor(t,e,i="#f97316",s=10){this.x=t,this.y=e,this.color=i,this.height=s,this.id=crypto.randomUUID()}id;isSelected=!1;setPosition(t,e){this.x=t,this.y=e}containsPoint(t,e){const s=this.x-t,a=this.y-e;return s*s+a*a<225}draw(t,e){w.drawCone(t,this.x,this.y,this.color,this.height,this.isSelected)}static drawCone(t,e,i,s,a,n){t.fillStyle=s,t.beginPath(),t.moveTo(e,i-a),t.lineTo(e-20/2,i),t.lineTo(e+20/2,i),t.fill(),t.beginPath(),t.ellipse(e,i,20/2,8/2,0,0,Math.PI*2),t.fill(),n&&(t.strokeStyle="#fff",t.lineWidth=2,t.stroke(),t.beginPath(),t.moveTo(e,i-a),t.lineTo(e-20/2,i),t.lineTo(e+20/2,i),t.closePath(),t.stroke())}}class M{constructor(t,e,i="#ffffff"){this.x=t,this.y=e,this.color=i,this.id=crypto.randomUUID()}id;isSelected=!1;isGroup=!1;visible=!0;setPosition(t,e){this.x=t,this.y=e}containsPoint(t,e){const i=this.isGroup?15:5,s=this.x-t,a=this.y-e;return s*s+a*a<(i+5)*(i+5)}draw(t,e){if(!this.visible)return;const i=5,s=(a,n)=>{t.beginPath(),t.arc(a,n,i,0,Math.PI*2),t.fillStyle=this.color,t.fill(),this.isGroup?t.strokeStyle="#000":t.strokeStyle=this.color,t.lineWidth=1,t.stroke()};if(this.isGroup){s(this.x,this.y);const a=2*i*Math.cos(Math.PI/4);s(this.x-a,this.y-a),s(this.x+a,this.y-a),s(this.x-a,this.y+a),s(this.x+a,this.y+a)}else s(this.x,this.y);if(this.isSelected){const a=this.isGroup?18:9;t.strokeStyle="#22c55e",t.lineWidth=2,t.beginPath(),t.arc(this.x,this.y,a,0,Math.PI*2),t.stroke()}}}class T extends E{shapeType;coneDistance=50;showLines=!0;groupColor="#f97316";groupHeight=10;smoothingFactor=5;width=0;height=0;radiusX=0;radiusY=0;endX=0;endY=0;points=[];selectedConeIndex=0;coneColors=new Map;constructor(t,e,i){super(e,i,"rgba(255,255,255,0.5)"),this.shapeType=t,(t==="triangle"||t==="freehand")&&(this.points=[{x:0,y:0}])}drawShape(t){if(this.showLines){if(t.beginPath(),this.shapeType==="line")t.moveTo(0,0),t.lineTo(this.endX,this.endY);else if(this.shapeType==="rectangle")t.rect(-this.width/2,-this.height/2,this.width,this.height);else if(this.shapeType==="ellipse")t.ellipse(0,0,Math.max(0,this.radiusX),Math.max(0,this.radiusY),0,0,2*Math.PI);else if(this.shapeType==="triangle"){if(this.points.length>0){t.moveTo(this.points[0].x,this.points[0].y);for(let i=1;i<this.points.length;i++)t.lineTo(this.points[i].x,this.points[i].y);t.closePath()}}else if(this.shapeType==="freehand"){const i=this.getSmoothedPolyline();if(i.length>0){t.moveTo(i[0].x,i[0].y);for(let s=1;s<i.length;s++)t.lineTo(i[s].x,i[s].y)}}t.strokeStyle=this.isSelected?"rgba(255,255,255,0.8)":"rgba(255,255,255,0.4)",t.lineWidth=1,t.setLineDash([5,5]),t.stroke(),t.setLineDash([])}this.generateConePositionsLocal().forEach((i,s)=>{let a=this.coneColors.get(s)||this.groupColor,n=this.isSelected&&s===this.selectedConeIndex;t.save(),t.translate(i.x,i.y),t.rotate(-this.rotation),w.drawCone(t,0,0,a,this.groupHeight,n),t.restore()})}containsPointLocal(t,e){const i=this.generateConePositionsLocal();for(let n=0;n<i.length;n++){const o=i[n],l=t-o.x,r=e-o.y;if(l*l+r*r<225)return this.selectedConeIndex=n,!0}let s=!1;const a=10;if(this.shapeType==="rectangle"){const n=this.width/2,o=this.height/2,l=n+a,r=o+a,h=Math.max(0,n-a),c=Math.max(0,o-a),d=Math.abs(t)<=l&&Math.abs(e)<=r,p=Math.abs(t)<=h&&Math.abs(e)<=c;d&&!p&&(s=!0)}else if(this.shapeType==="ellipse"){const n=this.radiusX,o=this.radiusY;if(n>0&&o>0){const l=t*t/(n*n)+e*e/(o*o);l>=.8&&l<=1.2&&(s=!0)}}else if(this.shapeType==="line"){const n=this.endX*this.endX+this.endY*this.endY;if(n===0)return!1;let o=(t*this.endX+e*this.endY)/n;o=Math.max(0,Math.min(1,o));const l=o*this.endX,r=o*this.endY;Math.hypot(t-l,e-r)<a&&(s=!0)}else{let n=this.points;if(this.shapeType==="freehand"&&(n=this.getSmoothedPolyline()),n.length>1){for(let o=0;o<n.length-1;o++){const l=n[o],r=n[o+1],h=(r.x-l.x)**2+(r.y-l.y)**2;if(h===0)continue;let c=((t-l.x)*(r.x-l.x)+(e-l.y)*(r.y-l.y))/h;c=Math.max(0,Math.min(1,c));const d=l.x+c*(r.x-l.x),p=l.y+c*(r.y-l.y);if(Math.hypot(t-d,e-p)<a){s=!0;break}}if(!s&&this.shapeType==="triangle"){const o=n[n.length-1],l=n[0],r=(l.x-o.x)**2+(l.y-o.y)**2;let h=((t-o.x)*(l.x-o.x)+(e-o.y)*(l.y-o.y))/r;h=Math.max(0,Math.min(1,h));const c=o.x+h*(l.x-o.x),d=o.y+h*(l.y-o.y);Math.hypot(t-c,e-d)<a&&(s=!0)}}}return s?(this.selectedConeIndex=0,!0):!1}getHandles(){if(this.shapeType==="rectangle"){const t=this.width/2,e=this.height/2;return[{id:"tl",x:-t,y:-e,cursor:"nw-resize"},{id:"br",x:t,y:e,cursor:"se-resize"},{id:"rotate",x:0,y:-e-25,cursor:"grab"}]}else if(this.shapeType==="ellipse"){const t=this.radiusX,e=this.radiusY;return[{id:"br",x:t,y:e,cursor:"se-resize"},{id:"rotate",x:0,y:-e-25,cursor:"grab"}]}else{if(this.shapeType==="line")return[{id:"start",x:0,y:0,cursor:"move"},{id:"end",x:this.endX,y:this.endY,cursor:"move"}];if(this.shapeType==="triangle")return this.points.map((t,e)=>({id:`p${e}`,x:t.x,y:t.y,cursor:"move"})).concat([{id:"rotate",x:0,y:-50,cursor:"grab"}])}return[]}resize(t,e,i){if(this.shapeType==="rectangle"){const s=this.width/2,a=this.height/2;let n=0,o=0;t==="tl"?(n=s,o=a):t==="br"&&(n=-s,o=-a);const l=Math.abs(e-n),r=Math.abs(i-o),h=(e+n)/2,c=(i+o)/2;this.width=Math.max(10,l),this.height=Math.max(10,r);const d=this.rotatePoint(h,c,this.rotation);this.x+=d.x,this.y+=d.y}else if(this.shapeType==="ellipse")this.radiusX=Math.max(5,Math.abs(e)),this.radiusY=Math.max(5,Math.abs(i));else if(this.shapeType==="line"){if(t==="end")this.endX=e,this.endY=i;else if(t==="start"){const s=this.rotatePoint(e,i,this.rotation);this.x+=s.x,this.y+=s.y,this.endX-=e,this.endY-=i}}else if(this.shapeType==="triangle"){const s=parseInt(t.charAt(1));!isNaN(s)&&this.points[s]&&(this.points[s].x=e,this.points[s].y=i)}}getSmoothedPolyline(){if(this.shapeType!=="freehand"||this.points.length<3||this.smoothingFactor<=1)return this.points;const t=[];for(let a=0;a<this.points.length;a+=Math.ceil(this.smoothingFactor))t.push(this.points[a]);t[t.length-1]!==this.points[this.points.length-1]&&t.push(this.points[this.points.length-1]);const e=[];if(t.length<2)return t;e.push(t[0]);let i=t[0];for(let a=1;a<t.length-1;a++){const n=t[a],o=t[a+1],l={x:(n.x+o.x)/2,y:(n.y+o.y)/2},r=10;for(let h=1;h<=r;h++){const c=h/r,d=1-c,p=d*d*i.x+2*d*c*n.x+c*c*l.x,m=d*d*i.y+2*d*c*n.y+c*c*l.y;e.push({x:p,y:m})}i=l}const s=t[t.length-1];return e.push(s),e}generateConePositionsLocal(){const t=[],e=Math.max(20,this.coneDistance),i=(s,a)=>{const n=Math.hypot(a.x-s.x,a.y-s.y),o=Math.max(1,Math.round(n/e));for(let l=0;l<o;l++){const r=l/o;t.push({x:s.x+(a.x-s.x)*r,y:s.y+(a.y-s.y)*r})}};if(this.shapeType==="line"){const s={x:0,y:0},a={x:this.endX,y:this.endY};i(s,a),t.push(a)}else if(this.shapeType==="rectangle"){const s=this.width/2,a=this.height/2,n={x:-s,y:-a},o={x:s,y:-a},l={x:s,y:a},r={x:-s,y:a};i(n,o),i(o,l),i(l,r),i(r,n)}else if(this.shapeType==="triangle")this.points.length===3&&(i(this.points[0],this.points[1]),i(this.points[1],this.points[2]),i(this.points[2],this.points[0]));else if(this.shapeType==="ellipse"){const s=Math.max(8,Math.round(Math.PI*2*Math.max(this.radiusX,this.radiusY)/e));for(let a=0;a<s;a++){const n=a/s*Math.PI*2;t.push({x:this.radiusX*Math.cos(n),y:this.radiusY*Math.sin(n)})}}else if(this.shapeType==="freehand"){const s=this.getSmoothedPolyline();if(s.length>0){t.push(s[0]);let a=s[0],n=0;for(let l=1;l<s.length;l++){const r=Math.hypot(s[l].x-a.x,s[l].y-a.y);r+n>=e?(t.push(s[l]),n=0):n+=r,a=s[l]}const o=s[s.length-1];if(t.length>0){const l=t[t.length-1];Math.hypot(o.x-l.x,o.y-l.y)>5&&t.push(o)}else t.push(o)}}return t}}class x extends B{constructor(t,e){super(t,e,"#ffffff"),this.width=100,this.height=40,this.hasFill=!1}drawShape(t){const e=this.width,i=this.height,s=e/2,a=i/2;t.save(),t.beginPath(),t.rect(-s,-a,e,i),t.clip(),t.beginPath(),t.strokeStyle="#cccccc",t.lineWidth=1;const n=8,o=e+i;for(let r=-o;r<=o;r+=n)t.moveTo(-a-r,-a),t.lineTo(a-r,a);for(let r=-o;r<=o;r+=n)t.moveTo(r+a,-a),t.lineTo(r-a,a);t.stroke(),t.restore(),t.beginPath(),t.rect(-s,-a,e,i),t.strokeStyle=this.color==="#ffffff"?"#000000":this.color,t.lineWidth=2,t.stroke(),t.beginPath();const l=1;t.moveTo(-s-l,a),t.lineTo(s+l,a),t.lineWidth=6,t.strokeStyle=this.color==="#ffffff"?"#000000":this.color,t.lineCap="butt",t.stroke()}}class et{history=[];redoStack=[];maxHistory=50;execute(t){t.execute(),this.history.push(t),this.redoStack=[],this.history.length>this.maxHistory&&this.history.shift()}undo(){const t=this.history.pop();t&&(t.undo(),this.redoStack.push(t))}redo(){const t=this.redoStack.pop();t&&(t.execute(),this.history.push(t))}}const P={PICKUP_RADIUS:20,BASE_SPEED_PX_PER_SEC:50,MAX_ADDITIONAL_SPEED_PX_PER_SEC:350,DEFAULT_SPEED_PERCENT:50,INSTANT_ACTION_DURATION:1,ZERO_LENGTH_DURATION:1,BALL_RADIUS:6,BALL_STROKE_COLOR:"#fff"};class it{isPlaying=!1;isPaused=!1;speedMultiplier=1;entities=[];playerStates=new Map;balls=[];initialMemento=new Map;ballEntityMementos=[];constructor(){}play(t,e){this.entities=e,this.isPlaying=!0,this.isPaused=!1,this.resetState(),this.initializeState(t)}stop(){this.isPlaying&&(this.isPlaying=!1,this.isPaused=!1,this.restoreState(),this.balls=[])}pause(){this.isPlaying&&(this.isPaused=!this.isPaused)}setSpeed(t){this.speedMultiplier=t}update(t){if(!this.isPlaying||this.isPaused)return;const e=t*this.speedMultiplier;this.entities.forEach(i=>{i instanceof v&&this.updatePlayer(i,e)}),this.balls.forEach(i=>this.updateBall(i))}render(t){this.isPlaying&&(this.balls.forEach(e=>{e.status!=="held"&&(t.beginPath(),t.arc(e.x,e.y,P.BALL_RADIUS,0,Math.PI*2),t.fillStyle=e.color,t.fill(),t.strokeStyle=P.BALL_STROKE_COLOR,t.lineWidth=1,t.stroke())}),this.playerStates.forEach((e,i)=>{if(e.isWaitingForBall){const s=this.entities.find(a=>a.id===i);s&&(t.fillStyle="rgba(255, 255, 255, 0.7)",t.font="10px Arial",t.fillText("Esperando...",s.x-20,s.y-15))}}))}resetState(){this.playerStates.clear(),this.balls=[],this.initialMemento.clear(),this.ballEntityMementos=[]}initializeState(t){this.entities.forEach(e=>{e instanceof v?this.initializePlayer(e,t):e instanceof M&&this.initializeBallEntity(e)})}initializePlayer(t,e){this.initialMemento.set(t.id,{originalX:t.x,originalY:t.y,originalRotation:t.rotation,hasBall:t.hasBall});const i=t.actions.filter(s=>s.sceneIndex===e);this.playerStates.set(t.id,{currentAction:null,actionQueue:[...i],timeInAction:0,duration:0,isWaitingForBall:!1,isWaitingDelay:!1,delayTimer:0,hasBall:t.hasBall}),t.hasBall&&(this.balls.push({id:crypto.randomUUID(),status:"held",ownerId:t.id,x:t.x+12,y:t.y+12,color:O}),t.ballColor=O)}initializeBallEntity(t){t.isGroup||(this.ballEntityMementos.push({id:t.id,visible:t.visible}),t.visible=!1,this.balls.push({id:crypto.randomUUID(),status:"loose",ownerId:null,x:t.x,y:t.y,color:t.color}))}restoreState(){this.entities.forEach(t=>{if(t instanceof v){const e=this.initialMemento.get(t.id);e&&(t.x=e.originalX,t.y=e.originalY,t.rotation=e.originalRotation,t.hasBall=e.hasBall),t.ballColor=void 0}}),this.ballEntityMementos.forEach(t=>{const e=this.entities.find(i=>i.id===t.id);e&&e instanceof M&&(e.visible=t.visible)})}updatePlayer(t,e){const i=this.playerStates.get(t.id);if(i){if(i.isWaitingDelay){i.delayTimer-=e,i.delayTimer<=0&&(i.isWaitingDelay=!1,this.startAction(t,i));return}i.hasBall||this.tryPickupBall(t,i),i.currentAction?this.processCurrentAction(t,i,e):this.processNextAction(t,i)}}tryPickupBall(t,e){for(const s of this.balls){if(s.status==="held"||s.status==="moving"&&s.lastOwnerId===t.id)continue;if(Math.hypot(t.x-s.x,t.y-s.y)<=P.PICKUP_RADIUS){this.assignBallToPlayer(t,e,s);return}}const i=this.entities.filter(s=>s instanceof M&&s.isGroup&&s.visible);for(const s of i)if(s.containsPoint(t.x,t.y)){const a={id:crypto.randomUUID(),status:"held",ownerId:t.id,x:t.x+12,y:t.y+12,color:s.color};this.balls.push(a),this.assignBallToPlayer(t,e,a,!1);return}}assignBallToPlayer(t,e,i,s=!0){e.hasBall=!0,t.hasBall=!0,t.ballColor=i.color,e.isWaitingForBall=!1,s&&(i.status="held",i.ownerId=t.id,i.lastOwnerId=null)}processCurrentAction(t,e,i){e.timeInAction+=i;const s=Math.min(1,e.timeInAction/e.duration);this.applyActionPhysics(t,e.currentAction,s),e.timeInAction>=e.duration&&this.finishAction(t,e)}processNextAction(t,e){const i=e.actionQueue[0];if(i){if(i.waitBefore>0&&!e.isWaitingDelay){e.actionQueue.shift(),e.currentAction=i,e.isWaitingDelay=!0,e.delayTimer=i.waitBefore;return}this.canStartAction(i,e.hasBall)?(e.actionQueue.shift(),e.currentAction=i,this.startAction(t,e)):e.isWaitingForBall=!0}}startAction(t,e){const i=e.currentAction;e.timeInAction=0,e.duration=this.calculateDuration(i),e.isWaitingForBall=!1,i.ballInteraction==="propel"&&this.releaseBall(t,e)}releaseBall(t,e){const i=this.balls.find(s=>s.ownerId===t.id);i&&(i.status="moving",i.ownerId=null,i.lastOwnerId=t.id),e.hasBall=!1,t.hasBall=!1,t.ballColor=void 0}canStartAction(t,e){return t.ballInteraction!=="none"?e:!0}applyActionPhysics(t,e,i){if(e.movesPlayer){const s=e.getPositionAt(i),a=e.getHeadingAt(i);if(t.rotation=this.lerpAngle(t.rotation,a,.2),t.x=s.x,t.y=s.y,e.ballInteraction==="carry"){const n=this.balls.find(o=>o.ownerId===t.id);n&&this.updateBallPositionRelative(n,t)}}if(e.ballInteraction==="propel"){const s=this.balls.find(a=>a.status==="moving"&&a.lastOwnerId===t.id);if(s){const a=e.getPositionAt(i);s.x=a.x,s.y=a.y}}}finishAction(t,e){const i=e.currentAction;if(e.currentAction=null,i.ballInteraction==="propel"){const s=this.balls.find(a=>a.status==="moving"&&a.lastOwnerId===t.id);if(s){s.status="loose";const a=i.getPositionAt(1);s.x=a.x,s.y=a.y}}}updateBall(t){if(t.status==="held"&&t.ownerId){const e=this.entities.find(i=>i.id===t.ownerId);e&&e instanceof v&&this.updateBallPositionRelative(t,e)}}calculateDuration(t){let e=P.DEFAULT_SPEED_PERCENT;t.speed!==void 0&&t.speed!==null&&(e=t.speed);const i=P.BASE_SPEED_PX_PER_SEC+e/100*P.MAX_ADDITIONAL_SPEED_PX_PER_SEC;return t.getPathLength()===0?P.ZERO_LENGTH_DURATION:!t.movesPlayer&&!t.movesBall&&t.ballInteraction==="none"?P.INSTANT_ACTION_DURATION:t.getPathLength()/i}updateBallPositionRelative(t,e){const s=e.rotation+Math.PI/4;t.x=e.x+Math.cos(s)*17,t.y=e.y+Math.sin(s)*17}lerpAngle(t,e,i){const s=e-t,a=Math.atan2(Math.sin(s),Math.cos(s));return t+a*i}}class A{constructor(t,e){this.game=t,this.entity=e}execute(){this.game.addEntity(this.entity)}undo(){this.game.removeEntity(this.entity)}}class st{constructor(t,e){this.game=t,this.entity=e}execute(){this.game.removeEntity(this.entity)}undo(){this.game.addEntity(this.entity)}}class nt{constructor(t,e,i,s,a){this.entity=t,this.oldX=e,this.oldY=i,this.newX=s,this.newY=a}execute(){this.entity.setPosition(this.newX,this.newY)}undo(){this.entity.setPosition(this.oldX,this.oldY)}}class at{constructor(t,e,i){this.entity=t,this.oldState=e,this.newState=i}execute(){this.applyState(this.newState)}undo(){this.applyState(this.oldState)}applyState(t){t.x!==void 0&&(this.entity.x=t.x),t.y!==void 0&&(this.entity.y=t.y),t.rotation!==void 0&&(this.entity.rotation=t.rotation),t.width!==void 0&&(this.entity.width=t.width),t.height!==void 0&&(this.entity.height=t.height),t.radiusX!==void 0&&(this.entity.radiusX=t.radiusX),t.radiusY!==void 0&&(this.entity.radiusY=t.radiusY),t.endX!==void 0&&(this.entity.endX=t.endX),t.endY!==void 0&&(this.entity.endY=t.endY),t.points!==void 0&&(this.entity.points=JSON.parse(JSON.stringify(t.points))),this.entity instanceof b&&this.entity.owner&&this.entity.owner.updateActionChain()}}class V{constructor(t,e){this.player=t,this.action=e}execute(){this.action.owner=this.player,this.player.actions.push(this.action)}undo(){const t=this.player.actions.indexOf(this.action);t>-1&&this.player.actions.splice(t,1),this.action.owner=null}}class ot{constructor(t,e){this.player=t,this.action=e}removedActions=[];startIndex=-1;execute(){this.startIndex=this.player.actions.indexOf(this.action),this.startIndex>-1&&(this.removedActions=this.player.actions.splice(this.startIndex),this.removedActions.forEach(t=>t.owner=null))}undo(){this.startIndex>-1&&this.removedActions.length>0&&(this.removedActions.forEach(t=>t.owner=this.player),this.player.actions.splice(this.startIndex,0,...this.removedActions))}}class I{constructor(t){this.game=t}render(t){}activate(){}deactivate(){}getWorldPoint(t){const e=this.game.canvas.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top;return this.game.camera.screenToWorld(i,s,this.game.canvas)}}class lt extends I{isDraggingEntity=!1;dragStartPos=null;initialEntityPos=null;dragOffset=null;isResizing=!1;activeHandleId=null;initialResizeState=null;onMouseDown(t){const e=this.getWorldPoint(t),i=this.game.getSelectedEntity();if(i){const o=10*(1/this.game.camera.zoom);if(i instanceof E){const l=i.getHandles(),r=e.x-i.x,h=e.y-i.y,c=Math.cos(-i.rotation),d=Math.sin(-i.rotation),p=r*c-h*d,m=r*d+h*c;for(const f of l)if(Math.abs(p-f.x)<o&&Math.abs(m-f.y)<o){this.isResizing=!0,this.activeHandleId=f.id,this.initialResizeState=this.captureState(i);return}}else if(i instanceof b){const l=i.getHandles();for(const r of l)if(Math.hypot(e.x-r.x,e.y-r.y)<o){this.isResizing=!0,this.activeHandleId=r.id,this.initialResizeState=this.captureState(i);return}}}let s;const a=this.game.entities.slice().reverse();for(const n of a)if(n instanceof v){if(n.containsPoint(e.x,e.y)){s=n;break}const o=n.actions.slice().reverse();for(const l of o)if(l.containsPoint(e.x,e.y)){s=l;break}if(s)break}else if(n.containsPoint(e.x,e.y)){s=n;break}s?(this.game.selectEntity(s),s instanceof b||(this.isDraggingEntity=!0,this.dragStartPos={x:e.x,y:e.y},this.initialEntityPos={x:s.x,y:s.y},this.dragOffset={x:s.x-e.x,y:s.y-e.y})):this.game.selectEntity(null)}onMouseMove(t){const e=this.getWorldPoint(t),i=this.game.getSelectedEntity();if(this.isResizing&&this.activeHandleId&&i){if(i instanceof E)if(this.activeHandleId==="rotate"){const s=e.x-i.x,a=e.y-i.y;i.rotation=Math.atan2(a,s)+Math.PI/2}else{const s=e.x-i.x,a=e.y-i.y,n=Math.cos(-i.rotation),o=Math.sin(-i.rotation),l=s*n-a*o,r=s*o+a*n;i.resize(this.activeHandleId,l,r)}else i instanceof b&&i.resize(this.activeHandleId,e.x,e.y);return}this.isDraggingEntity&&i&&!this.isResizing&&this.dragOffset&&i.setPosition(e.x+this.dragOffset.x,e.y+this.dragOffset.y)}onMouseUp(t){const e=this.game.getSelectedEntity();if(this.isResizing&&e&&this.initialResizeState){const i=this.captureState(e);JSON.stringify(this.initialResizeState)!==JSON.stringify(i)&&this.game.commandManager.execute(new at(e,this.initialResizeState,i)),this.isResizing=!1,this.activeHandleId=null,this.initialResizeState=null}if(this.isDraggingEntity&&e&&this.initialEntityPos&&!this.isResizing){const i=e.x-this.initialEntityPos.x,s=e.y-this.initialEntityPos.y;(Math.abs(i)>1||Math.abs(s)>1)&&this.game.commandManager.execute(new nt(e,this.initialEntityPos.x,this.initialEntityPos.y,e.x,e.y))}this.isDraggingEntity=!1,this.dragStartPos=null,this.initialEntityPos=null,this.dragOffset=null}render(t){const e=this.game.getSelectedEntity();if(e){const i=1/this.game.camera.zoom,s=8*i;if(t.lineWidth=1*i,e instanceof E){const a=e.getHandles();t.save(),t.translate(e.x,e.y),t.rotate(e.rotation);for(const n of a)n.id==="rotate"?(t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(n.x,n.y+25),t.strokeStyle="#ffffff",t.stroke(),t.beginPath(),t.arc(n.x,n.y,s,0,2*Math.PI),t.fillStyle="#22c55e",t.strokeStyle="#ffffff",t.fill(),t.stroke()):(t.fillStyle="#ffffff",t.strokeStyle="#000000",t.fillRect(n.x-s/2,n.y-s/2,s,s),t.strokeRect(n.x-s/2,n.y-s/2,s,s));t.restore()}else if(e instanceof b){const a=e.getHandles();t.save();for(const n of a)t.fillStyle="#ffffff",t.strokeStyle="#000000",t.fillRect(n.x-s/2,n.y-s/2,s,s),t.strokeRect(n.x-s/2,n.y-s/2,s,s);t.restore()}}}captureState(t){const e={x:t.x,y:t.y,rotation:t.rotation};return t.width!==void 0&&(e.width=t.width),t.height!==void 0&&(e.height=t.height),t.radiusX!==void 0&&(e.radiusX=t.radiusX),t.radiusY!==void 0&&(e.radiusY=t.radiusY),t.endX!==void 0&&(e.endX=t.endX),t.endY!==void 0&&(e.endY=t.endY),t.points!==void 0&&(e.points=JSON.parse(JSON.stringify(t.points))),e}}class rt extends I{team="A";color="#ef4444";quantity=1;setTeam(t){this.team=t}setColor(t){this.color=t}setQuantity(t){this.quantity=Math.max(1,t)}getTeam(){return this.team}getColor(){return this.color}getQuantity(){return this.quantity}onMouseDown(t){const e=this.getWorldPoint(t);for(let i=0;i<this.quantity;i++){const s=i*15,a=(this.game.entities.filter(o=>o instanceof v).length+1).toString(),n=new v(e.x+s,e.y+s,a,this.color);n.team=this.team,this.game.commandManager.execute(new A(this.game,n))}}onMouseMove(t){}onMouseUp(t){}}class ht extends I{isPanning=!1;lastMouseX=0;lastMouseY=0;_isPanEnabled=!1;get isPanEnabled(){return this._isPanEnabled}setPanEnabled(t){this._isPanEnabled=t,t||(this.isPanning=!1)}onMouseDown(t){this._isPanEnabled&&(this.isPanning=!0,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY)}onMouseMove(t){if(this.isPanning){const e=t.clientX-this.lastMouseX,i=t.clientY-this.lastMouseY;this.game.camera.pan(e,i),this.lastMouseX=t.clientX,this.lastMouseY=t.clientY}}onMouseUp(t){this.isPanning=!1}deactivate(){this.isPanning=!1}}class ct extends I{isDrawing=!1;drawStartPos=null;tempShape=null;currentShapeType="line";setShapeType(t){this.currentShapeType=t}onMouseDown(t){const e=this.getWorldPoint(t);switch(this.isDrawing=!0,this.drawStartPos={x:e.x,y:e.y},this.currentShapeType){case"rectangle":this.tempShape=new B(e.x,e.y);break;case"circle":this.tempShape=new $(e.x,e.y);break;case"triangle":this.tempShape=new R(e.x,e.y),this.tempShape.points=[{x:0,y:0},{x:0,y:0},{x:0,y:0}];break;case"line":this.tempShape=new L(e.x,e.y);break;case"freehand":this.tempShape=new Y(e.x,e.y),this.tempShape.points.push({x:0,y:0});break}}onMouseMove(t){if(!this.isDrawing||!this.tempShape||!this.drawStartPos)return;const e=this.getWorldPoint(t),i=e.x-this.drawStartPos.x,s=e.y-this.drawStartPos.y;if(this.tempShape instanceof B)this.tempShape.width=Math.abs(i),this.tempShape.height=Math.abs(s),this.tempShape.x=this.drawStartPos.x+i/2,this.tempShape.y=this.drawStartPos.y+s/2;else if(this.tempShape instanceof $){const a=i/2,n=s/2;this.tempShape.x=this.drawStartPos.x+a,this.tempShape.y=this.drawStartPos.y+n,this.tempShape.radiusX=Math.abs(a),this.tempShape.radiusY=Math.abs(n)}else if(this.tempShape instanceof R){const a=i/2,n=s/2;this.tempShape.x=this.drawStartPos.x+a,this.tempShape.y=this.drawStartPos.y+n,this.tempShape.points=[{x:0,y:-n},{x:a,y:n},{x:-a,y:n}]}else this.tempShape instanceof L?(this.tempShape.endX=i,this.tempShape.endY=s):this.tempShape instanceof Y&&this.tempShape.points.push({x:i,y:s})}onMouseUp(t){if(this.isDrawing&&this.tempShape){let e=!0;if(this.tempShape instanceof B&&(this.tempShape.width<1||this.tempShape.height<1)&&(e=!1),this.tempShape instanceof $&&(this.tempShape.radiusX<1||this.tempShape.radiusY<1)&&(e=!1),this.tempShape instanceof L&&this.tempShape.endX===0&&this.tempShape.endY===0&&(e=!1),this.tempShape instanceof R){const i=this.tempShape.points,s=Math.min(...i.map(n=>n.x));Math.max(...i.map(n=>n.x))-s<1&&(e=!1)}e&&(this.game.commandManager.execute(new A(this.game,this.tempShape)),this.game.selectEntity(this.tempShape)),this.tempShape=null,this.isDrawing=!1,this.game.setTool("select")}}render(t){this.isDrawing&&this.tempShape&&this.tempShape.draw(t)}}class dt extends I{currentPlayer=null;actionType="run";lineType="straight";isDrawing=!1;tempAction=null;setContext(t,e,i){this.currentPlayer=t,this.actionType=e,this.lineType=i}onMouseDown(t){if(!this.currentPlayer)return;const e=this.getWorldPoint(t);let i=this.currentPlayer.x,s=this.currentPlayer.y;if(this.currentPlayer.actions.length>0){const l=this.currentPlayer.actions[this.currentPlayer.actions.length-1].getFinalPosition();i=l.x,s=l.y}if(this.actionType==="turn"||this.actionType==="tackle"){let o;this.actionType==="turn"?o=new U(i,s,i,s):o=new W(i,s,i,s),o.sceneIndex=this.game.currentScene,this.game.commandManager.execute(new V(this.currentPlayer,o)),this.game.selectEntity(this.currentPlayer),this.game.setTool("select");return}const a=this.lineType==="straight"?e.x:i,n=this.lineType==="straight"?e.y:s;switch(this.actionType){case"run":this.tempAction=new H(i,s,a,n);break;case"pass":this.tempAction=new C(i,s,a,n);break;case"dribble":this.tempAction=new k(i,s,a,n);break;case"shoot":this.tempAction=new X(i,s,a,n);break;default:this.tempAction=new H(i,s,a,n)}this.tempAction.pathType=this.lineType,this.tempAction.owner=this.currentPlayer,this.tempAction.sceneIndex=this.game.currentScene,this.lineType==="freehand"&&(this.tempAction.points=[{x:i,y:s}]),this.isDrawing=!0}onMouseMove(t){if(this.isDrawing&&this.tempAction){const e=this.getWorldPoint(t);this.lineType==="straight"?(this.tempAction.endX=e.x,this.tempAction.endY=e.y):(this.tempAction.points.push(e),this.tempAction.endX=e.x,this.tempAction.endY=e.y)}}onMouseUp(t){this.isDrawing&&this.tempAction&&this.currentPlayer&&(this.game.commandManager.execute(new V(this.currentPlayer,this.tempAction)),this.game.selectEntity(this.currentPlayer),this.game.setTool("select")),this.isDrawing=!1,this.tempAction=null}render(t){this.isDrawing&&this.tempAction&&this.tempAction.draw(t)}}class pt extends I{objectType="cone";coneShape="single";isDragging=!1;tempEntity=null;dragStart={x:0,y:0};setObjectType(t){this.objectType=t,t==="cone"&&(this.coneShape="single")}setConeShape(t){this.coneShape=t}getObjectType(){return this.objectType}getConeShape(){return this.coneShape}onMouseDown(t){const e=this.getWorldPoint(t);if(this.dragStart={x:e.x,y:e.y},this.objectType==="ball"){const i=new M(e.x,e.y);this.game.commandManager.execute(new A(this.game,i)),this.game.selectEntity(i),this.game.setTool("select");return}if(this.objectType==="goal"){this.isDragging=!0,this.tempEntity=new x(e.x,e.y),this.tempEntity.width=0,this.tempEntity.height=0;return}if(this.objectType==="cone"){if(this.coneShape==="single"){const i=new w(e.x,e.y);this.game.commandManager.execute(new A(this.game,i)),this.game.selectEntity(i),this.game.setTool("select");return}this.isDragging=!0,this.tempEntity=new T(this.coneShape,e.x,e.y),this.coneShape==="freehand"?this.tempEntity.points=[{x:0,y:0}]:this.coneShape==="triangle"&&(this.tempEntity.points=[{x:0,y:0},{x:0,y:0},{x:0,y:0}])}}onMouseMove(t){if(!this.isDragging||!this.tempEntity)return;const e=this.getWorldPoint(t),i=this.dragStart.x,s=this.dragStart.y;if(this.tempEntity instanceof x)this.tempEntity.width=Math.abs(e.x-i),this.tempEntity.height=Math.abs(e.y-s),this.tempEntity.x=(i+e.x)/2,this.tempEntity.y=(s+e.y)/2;else if(this.tempEntity instanceof T){if(this.tempEntity.shapeType==="line")this.tempEntity.endX=e.x-i,this.tempEntity.endY=e.y-s;else if(this.tempEntity.shapeType==="rectangle")this.tempEntity.width=Math.abs(e.x-i),this.tempEntity.height=Math.abs(e.y-s),this.tempEntity.x=(i+e.x)/2,this.tempEntity.y=(s+e.y)/2;else if(this.tempEntity.shapeType==="ellipse")this.tempEntity.radiusX=Math.abs(e.x-i)/2,this.tempEntity.radiusY=Math.abs(e.y-s)/2,this.tempEntity.x=(i+e.x)/2,this.tempEntity.y=(s+e.y)/2;else if(this.tempEntity.shapeType==="triangle"){const a=e.x-i,n=e.y-s;this.tempEntity.x=i+a/2,this.tempEntity.y=s+n/2,this.tempEntity.points=[{x:0,y:-n/2},{x:a/2,y:n/2},{x:-a/2,y:n/2}]}else if(this.tempEntity.shapeType==="freehand"){const a=e.x-this.tempEntity.x,n=e.y-this.tempEntity.y;this.tempEntity.points.push({x:a,y:n})}}}onMouseUp(t){if(this.isDragging&&this.tempEntity){let e=0,i=0,s=!1;this.tempEntity instanceof x?(e=this.tempEntity.width,i=this.tempEntity.height,s=e>5||i>5):this.tempEntity instanceof T&&(e=this.tempEntity.width||Math.abs(this.tempEntity.endX)||10,i=this.tempEntity.height||Math.abs(this.tempEntity.endY)||10,s=e>5||i>5||this.tempEntity.points.length>2),s&&(this.game.commandManager.execute(new A(this.game,this.tempEntity)),this.game.selectEntity(this.tempEntity)),this.game.setTool("select")}this.isDragging=!1,this.tempEntity=null}render(t){this.isDragging&&this.tempEntity&&this.tempEntity.draw(t)}}class ut{canvas;ctx;camera;field;commandManager;animationManager;entities=[];selectedEntity=null;currentScene=0;sceneCount=1;currentMode="edit";currentToolId="select";tools=new Map;currentActionType="run";currentActionLineType="straight";useAIOptimization=!1;constructor(t){const e=document.getElementById(t);if(!e)throw new Error("Canvas not found");this.canvas=e,this.ctx=e.getContext("2d"),this.camera=new K(0,0),this.field=new tt,this.commandManager=new et,this.animationManager=new it,this.tools.set("select",new lt(this)),this.tools.set("player",new rt(this)),this.tools.set("camera",new ht(this)),this.tools.set("shape",new ct(this)),this.tools.set("action",new dt(this)),this.tools.set("exercise",new pt(this)),this.setupUI(),this.setupEvents(),this.resize(),this.setTool("select"),window.addEventListener("resize",()=>this.resize())}addEntity(t){this.entities.push(t)}removeEntity(t){const e=this.entities.indexOf(t);e>-1&&this.entities.splice(e,1),this.selectedEntity===t&&this.selectEntity(null)}selectEntity(t){this.selectedEntity&&(this.selectedEntity.isSelected=!1),this.selectedEntity=t,this.selectedEntity&&(this.selectedEntity.isSelected=!0),this.currentMode==="edit"&&this.updateSelectionUI()}getSelectedEntity(){return this.selectedEntity}setTool(t){this.currentToolId&&this.tools.get(this.currentToolId)?.deactivate(),this.currentToolId=t,this.tools.get(t)?.activate(),document.querySelectorAll(".tool-btn").forEach(i=>i.classList.remove("active"));let e="";t==="select"&&(e="tool-select"),t==="player"&&(e="tool-player"),t==="camera"&&(e="tool-camera"),t==="shape"&&(e="tool-shape"),t==="exercise"&&(e="tool-exercise"),e&&document.getElementById(e)?.classList.add("active"),(t==="camera"||t==="shape"||t==="exercise")&&this.selectEntity(null),this.updatePropertiesPanel(t)}activateActionTool(t){this.setTool("action");const e=this.tools.get("action");e&&e.setContext(t,this.currentActionType,this.currentActionLineType),this.updatePropertiesPanel("action")}setupEvents(){this.canvas.addEventListener("wheel",t=>{t.preventDefault();const e=t.deltaY>0?.9:1.1;this.camera.zoomAt(e,t.clientX,t.clientY,this.canvas)}),this.canvas.addEventListener("mousedown",t=>{t.preventDefault(),this.tools.get(this.currentToolId)?.onMouseDown(t)}),window.addEventListener("mousemove",t=>{this.tools.get(this.currentToolId)?.onMouseMove(t)}),window.addEventListener("mouseup",t=>{this.tools.get(this.currentToolId)?.onMouseUp(t)}),window.addEventListener("keydown",t=>{const e=t.target;if(!(e.tagName==="INPUT"||e.tagName==="TEXTAREA")){if(this.currentMode==="play"){t.key.toLowerCase()==="r"&&this.camera.toggleRotation();return}(t.key==="Delete"||t.key==="Backspace")&&this.deleteSelected(),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="z"&&this.commandManager.undo(),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="y"&&this.commandManager.redo(),t.key.toLowerCase()==="v"&&this.setTool("select"),t.key.toLowerCase()==="p"&&this.setTool("player"),t.key.toLowerCase()==="c"&&this.setTool("camera"),t.key.toLowerCase()==="s"&&this.setTool("shape"),t.key.toLowerCase()==="o"&&this.setTool("exercise"),t.key.toLowerCase()==="r"&&this.camera.toggleRotation()}})}setupUI(){const t=document.getElementById("btn-mode-edit"),e=document.getElementById("btn-mode-play"),i=document.getElementById("edit-tools-panel"),s=document.getElementById("play-tools-panel"),a=y=>{if(this.currentMode=y,y==="edit"){this.animationManager.stop(),this.updateSceneState(),t?.classList.add("active"),e?.classList.remove("active"),i?.classList.remove("hidden"),s?.classList.add("hidden");const g=document.getElementById("section-scenes");g&&(g.style.display="flex"),this.setTool("select"),this.updateSelectionUI()}else{t?.classList.remove("active"),e?.classList.add("active"),i?.classList.add("hidden"),s?.classList.remove("hidden");const g=document.getElementById("section-scenes");g&&(g.style.display="none"),this.selectEntity(null),this.updatePropertiesPanel(null),this.setTool("camera"),this.tools.get("camera").setPanEnabled(!0)}};t?.addEventListener("click",()=>a("edit")),e?.addEventListener("click",()=>a("play"));const n=document.querySelector(".section-modes");if(n){const y=document.createElement("div");y.className="separator-vertical",n.after(y);const g=document.createElement("div");g.id="section-scenes",g.className="toolbar-section section-modes",g.style.flexDirection="column",g.style.gap="5px",g.style.minWidth="100px",g.innerHTML=`
            <div style="font-size: 0.7rem; color: #888; text-transform: uppercase;">Escena</div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <button class="mode-btn" id="scene-prev" style="width: 24px; height: 24px; font-size: 12px;"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="scene-display" style="font-weight: bold; min-width: 20px; text-align: center; font-size: 1.1rem;">1</span>
                <button class="mode-btn" id="scene-next" style="width: 24px; height: 24px; font-size: 12px;"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <button class="prop-btn" id="scene-add" style="padding: 2px 8px; font-size: 0.75rem; width: 100%; justify-content: center; height: 24px;"><i class="fa-solid fa-plus"></i> Nueva</button>
        `,y.after(g),document.getElementById("scene-prev")?.addEventListener("click",()=>this.setScene(this.currentScene-1)),document.getElementById("scene-next")?.addEventListener("click",()=>this.setScene(this.currentScene+1)),document.getElementById("scene-add")?.addEventListener("click",()=>{this.sceneCount++,this.setScene(this.sceneCount-1)})}document.getElementById("tool-select")?.addEventListener("click",()=>this.setTool("select")),document.getElementById("tool-player")?.addEventListener("click",()=>this.setTool("player")),document.getElementById("tool-camera")?.addEventListener("click",()=>this.setTool("camera")),document.getElementById("tool-shape")?.addEventListener("click",()=>this.setTool("shape")),document.getElementById("tool-exercise")?.addEventListener("click",()=>this.setTool("exercise")),document.getElementById("action-undo")?.addEventListener("click",()=>this.commandManager.undo()),document.getElementById("action-redo")?.addEventListener("click",()=>this.commandManager.redo());const o=document.getElementById("secondary-menu"),l=document.getElementById("btn-collapse-menu"),r=document.getElementById("btn-open-menu"),h=(y=!1)=>{y?(o?.classList.remove("collapsed"),r?.classList.add("hidden")):(o?.classList.toggle("collapsed"),o?.classList.contains("collapsed")?r?.classList.remove("hidden"):r?.classList.add("hidden"))};l?.addEventListener("click",()=>h()),r?.addEventListener("click",()=>h());const c=document.getElementById("anim-play"),d=document.getElementById("anim-stop"),p=document.getElementById("anim-speed"),m=document.getElementById("anim-speed-val"),f=document.getElementById("play-tools-panel");if(f){const y=document.createElement("div");y.className="menu-control-group checkbox-wrapper",y.style.margin="0 10px",y.style.background="rgba(0,0,0,0.2)",y.style.padding="4px 8px",y.style.borderRadius="4px",y.innerHTML=`
            <input type="checkbox" id="ai-opt-toggle">
            <label class="menu-label" for="ai-opt-toggle" style="cursor:pointer; color: #a855f7; font-weight: bold;">
                <i class="fa-solid fa-wand-magic-sparkles"></i> AI Opt
            </label>
        `,f.insertBefore(y,f.firstChild),y.querySelector("#ai-opt-toggle").addEventListener("change",D=>{this.useAIOptimization=D.target.checked})}c?.addEventListener("click",async()=>{this.animationManager.isPlaying?this.animationManager.pause():(this.useAIOptimization&&await this.optimizeDrill(),this.animationManager.play(this.currentScene,this.entities));const y=c.querySelector("i");this.animationManager.isPlaying&&!this.animationManager.isPaused?y?.classList.replace("fa-play","fa-pause"):y?.classList.replace("fa-pause","fa-play")}),d?.addEventListener("click",()=>{this.animationManager.stop(),c?.querySelector("i")?.classList.replace("fa-pause","fa-play")}),p?.addEventListener("input",y=>{const g=parseFloat(y.target.value);this.animationManager.setSpeed(g),m&&(m.textContent=g.toFixed(1)+"x")})}setScene(t){t<0||t>=this.sceneCount||(this.currentScene=t,this.updateSceneState())}updateSceneState(){const t=document.getElementById("scene-display");t&&(t.textContent=(this.currentScene+1).toString()),this.entities.forEach(e=>{e instanceof v&&e.updateForScene(this.currentScene)}),this.selectEntity(null)}updatePropertiesPanel(t){const e=document.getElementById("properties-panel");if(e){if(e.innerHTML="",this.currentMode==="play"){e.innerHTML='<span class="placeholder-text-small">Modo Reproduccin</span>';return}if(t){if(t==="exercise"){const i=this.tools.get("exercise"),s=i.getObjectType(),a=i.getConeShape();let n=`
             <div class="prop-info"><span class="prop-label">Objetos</span></div>
             <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                 <button class="prop-btn ${s==="cone"?"active-prop":""}" id="ex-cone" title="Cono"><i class="fa-solid fa-traffic-cone"></i></button>
                 <button class="prop-btn ${s==="ball"?"active-prop":""}" id="ex-ball" title="Bocha"><i class="fa-solid fa-circle"></i></button>
                 <button class="prop-btn ${s==="goal"?"active-prop":""}" id="ex-goal" title="Arco"><i class="fa-regular fa-futbol"></i></button>
             </div>
          `;if(s==="cone"&&(n+=`
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                     <button class="prop-btn ${a==="single"?"active-prop":""}" id="ex-shape-single" title="Simple"><i class="fa-solid fa-stop"></i></button>
                     <button class="prop-btn ${a==="line"?"active-prop":""}" id="ex-shape-line" title="Lnea"><i class="fa-solid fa-slash"></i></button>
                     <button class="prop-btn ${a==="freehand"?"active-prop":""}" id="ex-shape-free" title="Libre"><i class="fa-solid fa-pencil"></i></button>
                     <button class="prop-btn ${a==="rectangle"?"active-prop":""}" id="ex-shape-rect" title="Rectngulo"><i class="fa-regular fa-square"></i></button>
                     <button class="prop-btn ${a==="ellipse"?"active-prop":""}" id="ex-shape-circle" title="Crculo"><i class="fa-regular fa-circle"></i></button>
                     <button class="prop-btn ${a==="triangle"?"active-prop":""}" id="ex-shape-tri" title="Tringulo"><i class="fa-solid fa-play fa-rotate-270"></i></button>
                </div>
             `),e.innerHTML=n,document.getElementById("ex-cone")?.addEventListener("click",()=>{i.setObjectType("cone"),this.updatePropertiesPanel("exercise")}),document.getElementById("ex-ball")?.addEventListener("click",()=>{i.setObjectType("ball"),this.updatePropertiesPanel("exercise")}),document.getElementById("ex-goal")?.addEventListener("click",()=>{i.setObjectType("goal"),this.updatePropertiesPanel("exercise")}),s==="cone"){const o=l=>{i.setConeShape(l),this.updatePropertiesPanel("exercise")};document.getElementById("ex-shape-single")?.addEventListener("click",()=>o("single")),document.getElementById("ex-shape-line")?.addEventListener("click",()=>o("line")),document.getElementById("ex-shape-free")?.addEventListener("click",()=>o("freehand")),document.getElementById("ex-shape-rect")?.addEventListener("click",()=>o("rectangle")),document.getElementById("ex-shape-circle")?.addEventListener("click",()=>o("ellipse")),document.getElementById("ex-shape-tri")?.addEventListener("click",()=>o("triangle"))}return}if(t==="action"){this.selectedEntity instanceof v?this.renderPlayerActionUI(e,this.selectedEntity):e.innerHTML='<span class="placeholder-text-small">Dibujando Accin...</span>';return}if(t==="shape"){const i=this.tools.get("shape");e.innerHTML=`
             <div class="prop-info">
                <span class="prop-label">Dibujar</span>
                <span class="prop-value">Forma</span>
             </div>
             <button class="prop-btn" id="shape-line" title="Lnea"><i class="fa-solid fa-slash"></i></button>
             <button class="prop-btn" id="shape-free" title="Libre"><i class="fa-solid fa-pencil"></i></button>
             <button class="prop-btn" id="shape-rect" title="Rectngulo"><i class="fa-regular fa-square"></i></button>
             <button class="prop-btn" id="shape-circle" title="Crculo/valo"><i class="fa-regular fa-circle"></i></button>
             <button class="prop-btn" id="shape-tri" title="Tringulo"><i class="fa-solid fa-play fa-rotate-270"></i></button>
          `;const s=a=>{e.querySelectorAll(".prop-btn").forEach(n=>n.classList.remove("active-prop")),document.getElementById(a)?.classList.add("active-prop")};s("shape-line"),document.getElementById("shape-line")?.addEventListener("click",()=>{i.setShapeType("line"),s("shape-line")}),document.getElementById("shape-free")?.addEventListener("click",()=>{i.setShapeType("freehand"),s("shape-free")}),document.getElementById("shape-rect")?.addEventListener("click",()=>{i.setShapeType("rectangle"),s("shape-rect")}),document.getElementById("shape-circle")?.addEventListener("click",()=>{i.setShapeType("circle"),s("shape-circle")}),document.getElementById("shape-tri")?.addEventListener("click",()=>{i.setShapeType("triangle"),s("shape-tri")})}else if(t==="camera"){const i=this.tools.get("camera");e.innerHTML=`
            <div class="prop-info">
                <span class="prop-label">Controles de Cmara</span>
                <span class="prop-value">Ajustes</span>
            </div>
            <button class="prop-btn" id="cam-pan-toggle" title="Activar Paneo"><i class="fa-solid fa-hand"></i> Paneo</button>
            <button class="prop-btn" id="cam-zoom-out" title="Alejar"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
            <button class="prop-btn" id="cam-zoom-in" title="Acercar"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
            <button class="prop-btn" id="cam-rotate" title="Rotar Vista"><i class="fa-solid fa-rotate"></i> Rotar</button>
            <button class="prop-btn" id="cam-reset" title="Centrar"><i class="fa-solid fa-compress"></i></button>
          `;const s=document.getElementById("cam-pan-toggle");if(s){const a=()=>{i.isPanEnabled?s.classList.add("active-prop"):s.classList.remove("active-prop")};a(),s.addEventListener("click",()=>{i.setPanEnabled(!i.isPanEnabled),a()})}document.getElementById("cam-zoom-in")?.addEventListener("click",()=>this.camera.zoomAt(1.2,this.canvas.width/2,this.canvas.height/2,this.canvas)),document.getElementById("cam-zoom-out")?.addEventListener("click",()=>this.camera.zoomAt(.8,this.canvas.width/2,this.canvas.height/2,this.canvas)),document.getElementById("cam-rotate")?.addEventListener("click",()=>this.camera.toggleRotation()),document.getElementById("cam-reset")?.addEventListener("click",()=>{this.camera.x=0,this.camera.y=0})}else if(t==="player"){const i=this.tools.get("player"),s=i.getTeam(),a=i.getColor(),n=i.getQuantity(),o=["#FFB3BA","#FFDFBA","#FFFFBA","#BAFFC9","#BAE1FF","#E2C9FF","#FFFFFF","#000000","#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#a855f7"];let l='<div class="color-palette">';o.forEach(r=>{l+=`<div class="color-swatch" style="background-color: ${r}" data-color="${r}"></div>`}),l+="</div>",e.innerHTML=`
             <div class="prop-info">
                <span class="prop-label">Crear Jugador</span>
                <span class="prop-value">Configuracin</span>
             </div>
             <div class="separator-vertical" style="height: 20px; margin: 0 10px;"></div>
             
             <div class="menu-control-group" style="margin-bottom: 0; width: 120px;">
                  <label class="menu-label">Equipo</label>
                  <select id="create-player-team" class="menu-select">
                      <option value="A" ${s==="A"?"selected":""}>Equipo A</option>
                      <option value="B" ${s==="B"?"selected":""}>Equipo B</option>
                  </select>
             </div>

             <div class="menu-control-group" style="margin-bottom: 0; min-width: 200px;">
                  <label class="menu-label">Color</label>
                  ${l}
                  <div style="display: flex; align-items: center; gap: 8px;">
                     <span style="font-size: 0.8rem; color: #888;">Personalizado:</span>
                     <input type="color" id="create-player-color" class="menu-input" value="${a}" style="flex: 1; height: 30px;">
                  </div>
             </div>

             <div class="menu-control-group" style="margin-bottom: 0; width: 100px;">
                  <label class="menu-label">Cantidad: <span id="create-player-qty-val">${n}</span></label>
                  <input type="range" id="create-player-qty" class="menu-input" min="1" max="11" step="1" value="${n}">
             </div>
          `,document.getElementById("create-player-team")?.addEventListener("change",r=>{i.setTeam(r.target.value)}),document.getElementById("create-player-qty")?.addEventListener("input",r=>{const h=parseInt(r.target.value)||1;i.setQuantity(h),document.getElementById("create-player-qty-val").textContent=h.toString()}),e.querySelectorAll(".color-swatch").forEach(r=>{r.addEventListener("click",h=>{const c=h.target.dataset.color;if(c){i.setColor(c);const d=document.getElementById("create-player-color");d&&(d.value=c)}})}),document.getElementById("create-player-color")?.addEventListener("input",r=>{i.setColor(r.target.value)})}else if(t==="select")if(this.selectedEntity){const i=this.selectedEntity;i instanceof v?this.renderPlayerActionUI(e,i):i instanceof E?(e.innerHTML=`
                     <div class="prop-info">
                        <span class="prop-label">Seleccin</span>
                        <span class="prop-value">Forma</span>
                     </div>
                     <div class="separator-vertical" style="height: 20px; margin: 0 10px;"></div>
                     <button class="prop-btn danger" id="prop-delete" title="Eliminar"><i class="fa-solid fa-trash"></i> Eliminar</button>
                  `,document.getElementById("prop-delete")?.addEventListener("click",()=>this.deleteSelected())):i instanceof b?(e.innerHTML=`
                     <div class="prop-info">
                        <span class="prop-label">Seleccin</span>
                        <span class="prop-value">Accin: ${i.type.toUpperCase()}</span>
                     </div>
                     <div class="separator-vertical" style="height: 20px; margin: 0 10px;"></div>
                     <button class="prop-btn danger" id="prop-delete" title="Eliminar"><i class="fa-solid fa-trash"></i> Eliminar</button>
                  `,document.getElementById("prop-delete")?.addEventListener("click",()=>this.deleteSelected())):(i instanceof w||i instanceof M||i instanceof T)&&(e.innerHTML=`
                     <div class="prop-info">
                        <span class="prop-label">Seleccin</span>
                        <span class="prop-value">Objeto</span>
                     </div>
                     <div class="separator-vertical" style="height: 20px; margin: 0 10px;"></div>
                     <button class="prop-btn danger" id="prop-delete" title="Eliminar"><i class="fa-solid fa-trash"></i> Eliminar</button>
                  `,document.getElementById("prop-delete")?.addEventListener("click",()=>this.deleteSelected()))}else e.innerHTML='<span class="placeholder-text-small">Seleccione un elemento para ver sus propiedades</span>'}}}renderPlayerActionUI(t,e){t.innerHTML=`
         <div class="prop-info">
            <span class="prop-label">Seleccin</span>
            <span class="prop-value">Jugador #${e.number}</span>
         </div>
         <div class="separator-vertical" style="height: 20px; margin: 0 10px;"></div>
         
         <div style="display: flex; flex-direction: column; gap: 8px; width: 100%;">
             <!-- Row 1: Actions -->
             <div class="action-toolbar" style="display: flex; gap: 5px; justify-content: flex-start; flex-wrap: wrap;">
                 <button class="prop-btn action-btn" data-action="run" title="Correr"><i class="fa-solid fa-person-running"></i></button>
                 <button class="prop-btn action-btn" data-action="dribble" title="Conducir"><i class="fa-solid fa-hockey-puck"></i></button>
                 <button class="prop-btn action-btn" data-action="pass" title="Pase"><i class="fa-solid fa-share"></i></button>
                 <button class="prop-btn action-btn" data-action="shoot" title="Tiro"><i class="fa-solid fa-bullseye"></i></button>
                 <button class="prop-btn action-btn" data-action="tackle" title="Quitar"><i class="fa-solid fa-shield-halved"></i></button>
                 <button class="prop-btn action-btn" data-action="turn" title="Girar"><i class="fa-solid fa-rotate"></i></button>
             </div>
             
             <!-- Row 2: Lines & Delete -->
             <div style="display: flex; gap: 10px; align-items: center; justify-content: space-between;">
                 <div style="display: flex; gap: 5px;">
                     <button class="prop-btn line-type-btn" data-type="straight" title="Recta"><i class="fa-solid fa-slash"></i></button>
                     <button class="prop-btn line-type-btn" data-type="freehand" title="Libre"><i class="fa-solid fa-pencil"></i></button>
                 </div>
                 <button class="prop-btn danger" id="prop-delete" title="Eliminar"><i class="fa-solid fa-trash"></i> Eliminar</button>
             </div>
         </div>
      `,(()=>{if(!(this.currentToolId==="action")){t.querySelectorAll(".active-prop").forEach(n=>n.classList.remove("active-prop"));return}const a=this.currentActionType==="turn"||this.currentActionType==="tackle";t.querySelectorAll(".action-btn").forEach(n=>{n.classList.toggle("active-prop",n.dataset.action===this.currentActionType)}),t.querySelectorAll(".line-type-btn").forEach(n=>{const o=n;o.classList.toggle("active-prop",o.dataset.type===this.currentActionLineType),a?(o.style.opacity="0.5",o.style.pointerEvents="none"):(o.style.opacity="1",o.style.pointerEvents="auto")})})(),t.querySelectorAll(".action-btn").forEach(s=>{s.addEventListener("click",a=>{this.currentActionType=a.currentTarget.dataset.action,this.activateActionTool(e)})}),t.querySelectorAll(".line-type-btn").forEach(s=>{s.addEventListener("click",a=>{this.currentActionLineType=a.currentTarget.dataset.type,this.activateActionTool(e)})}),document.getElementById("prop-delete")?.addEventListener("click",()=>this.deleteSelected())}updateSelectionUI(){this.updatePropertiesPanel(this.currentToolId),this.updateSecondaryMenu();const t=document.getElementById("secondary-menu"),e=document.getElementById("btn-open-menu");this.selectedEntity&&(t?.classList.remove("collapsed"),e?.classList.add("hidden"))}updateSecondaryMenu(){const t=document.querySelector(".menu-content");if(!t)return;if(!this.selectedEntity){t.innerHTML='<p class="placeholder-text">Seleccione un elemento para ver sus propiedades.</p>';return}const e=this.selectedEntity;let i="";const s=["#FFB3BA","#FFDFBA","#FFFFBA","#BAFFC9","#BAE1FF","#E2C9FF","#FFFFFF","#000000","#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#a855f7"];let a='<div class="color-palette">';if(s.forEach(n=>{a+=`<div class="color-swatch" style="background-color: ${n}" data-color="${n}"></div>`}),a+="</div>",e instanceof w)i+=`
              <div class="menu-control-group">
                  <label class="menu-label">Color</label>
                  ${a}
                  <input type="color" id="cone-prop-color" class="menu-input" value="${e.color}">
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Altura: <span id="height-val">${e.height}</span>px</label>
                  <input type="range" id="cone-prop-height" class="menu-input" min="10" max="60" value="${e.height}">
              </div>
           `;else if(e instanceof M)i+=`
              <div class="menu-control-group checkbox-wrapper">
                  <input type="checkbox" id="ball-prop-group" ${e.isGroup?"checked":""}>
                  <label class="menu-label" for="ball-prop-group">Grupo de Bochas</label>
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Color</label>
                  ${a}
                  <input type="color" id="ball-prop-color" class="menu-input" value="${e.color}">
              </div>
           `;else if(e instanceof x)i+=`
              <div class="menu-control-group">
                  <label class="menu-label">Color del Arco</label>
                  ${a}
                  <div style="display: flex; align-items: center; gap: 8px;">
                     <span style="font-size: 0.8rem; color: #888;">Personalizado:</span>
                     <input type="color" id="goal-prop-color" class="menu-input" value="${e.color}" style="flex: 1; height: 30px;">
                  </div>
              </div>
           `;else if(e instanceof T)i+=`
               <div class="menu-control-group checkbox-wrapper">
                  <input type="checkbox" id="group-prop-lines" ${e.showLines?"checked":""}>
                  <label class="menu-label" for="group-prop-lines">Mostrar Lneas</label>
               </div>
           `,e.shapeType==="freehand"&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Suavizado: <span id="group-smooth-val">${e.smoothingFactor}</span></label>
                      <input type="range" id="group-prop-smooth" class="menu-input" min="1" max="20" step="1" value="${e.smoothingFactor}">
                  </div>
               `),i+=`
               <div class="menu-control-group">
                  <label class="menu-label">Distancia: <span id="dist-val">${e.coneDistance}</span>px</label>
                  <input type="range" id="group-prop-dist" class="menu-input" min="20" max="200" step="5" value="${e.coneDistance}">
               </div>
               <div class="menu-control-group">
                  <label class="menu-label">Color del Conjunto</label>
                  ${a}
                  <input type="color" id="group-prop-color" class="menu-input" value="${e.groupColor}">
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Altura Conos: <span id="height-val">${e.groupHeight}</span>px</label>
                  <input type="range" id="group-prop-height" class="menu-input" min="10" max="60" value="${e.groupHeight}">
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Color Cono Seleccionado (#${e.selectedConeIndex})</label>
                  <input type="color" id="group-prop-ind-color" class="menu-input" value="${e.coneColors.get(e.selectedConeIndex)||e.groupColor}">
              </div>
           `;else if(e instanceof E){const n=e,o=n instanceof L,l=n instanceof Y,r=!o&&!l;i+=`
              <div class="menu-control-group">
                  <label class="menu-label">Color del Trazo</label>
                  ${a}
                  <div style="display: flex; align-items: center; gap: 8px;">
                     <span style="font-size: 0.8rem; color: #888;">Personalizado:</span>
                     <input type="color" id="shape-color" class="menu-input" value="${n.color}" style="flex: 1; height: 30px;">
                  </div>
              </div>

              <div class="menu-control-group">
                  <label class="menu-label">Tipo de Lnea</label>
                  <select id="shape-stroke-type" class="menu-select">
                      <option value="solid" ${n.strokeType==="solid"?"selected":""}>Slida</option>
                      <option value="dashed" ${n.strokeType==="dashed"?"selected":""}>Discontinua (Guiones)</option>
                      <option value="dotted" ${n.strokeType==="dotted"?"selected":""}>Punteada</option>
                  </select>
              </div>
          `,o&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Marcador Inicial</label>
                      <select id="line-start-marker" class="menu-select">
                          <option value="none" ${n.startMarker==="none"?"selected":""}>Ninguno</option>
                          <option value="arrow" ${n.startMarker==="arrow"?"selected":""}>Flecha</option>
                      </select>
                  </div>
                  <div class="menu-control-group">
                      <label class="menu-label">Marcador Final</label>
                      <select id="line-end-marker" class="menu-select">
                          <option value="none" ${n.endMarker==="none"?"selected":""}>Ninguno</option>
                          <option value="arrow" ${n.endMarker==="arrow"?"selected":""}>Flecha</option>
                      </select>
                  </div>
              `),l&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Suavizado: <span id="smooth-val">${n.smoothingFactor}</span></label>
                      <input type="range" id="shape-smooth" class="menu-input" min="1" max="20" step="1" value="${n.smoothingFactor}">
                  </div>
              `),r&&(i+=`
                  <div class="menu-control-group checkbox-wrapper">
                      <input type="checkbox" id="shape-has-fill" ${n.hasFill?"checked":""}>
                      <label class="menu-label" for="shape-has-fill">Relleno</label>
                  </div>

                  <div class="menu-control-group" id="container-opacity" style="${n.hasFill?"":"opacity: 0.5; pointer-events: none;"}">
                      <label class="menu-label">Opacidad de Relleno: <span id="opacity-val">${Math.round(n.fillOpacity*100)}%</span></label>
                      <input type="range" id="shape-opacity" class="menu-input" min="0" max="1" step="0.1" value="${n.fillOpacity}">
                  </div>
              `)}else if(e instanceof v){const n=e;i+=`
              <div class="menu-control-group">
                  <label class="menu-label">Equipo</label>
                  <select id="player-team" class="menu-select">
                      <option value="A" ${n.team==="A"?"selected":""}>Equipo A</option>
                      <option value="B" ${n.team==="B"?"selected":""}>Equipo B</option>
                  </select>
              </div>

              <div class="menu-control-group">
                  <label class="menu-label">Color</label>
                  ${a}
                  <div style="display: flex; align-items: center; gap: 8px;">
                     <span style="font-size: 0.8rem; color: #888;">Personalizado:</span>
                     <input type="color" id="shape-color" class="menu-input" value="${n.color}" style="flex: 1; height: 30px;">
                  </div>
              </div>

              <div class="menu-control-group">
                  <label class="menu-label">Etiqueta (Max 3)</label>
                  <input type="text" id="player-label" class="menu-input" maxlength="3" value="${n.number}">
              </div>

              <div class="menu-control-group checkbox-wrapper">
                  <input type="checkbox" id="player-ball" ${n.hasBall?"checked":""}>
                  <label class="menu-label" for="player-ball">Posee Bocha</label>
              </div>

              <div class="menu-control-group">
                  <label class="menu-label">Descripcin</label>
                  <textarea id="player-desc" class="menu-input" rows="3">${n.description}</textarea>
              </div>
          `}else if(e instanceof b){const n=e;if(i+=`
              <div class="menu-control-group">
                  <label class="menu-label">Tipo</label>
                  <input type="text" class="menu-input" value="${n.type.toUpperCase()}" disabled>
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Pre-Evento</label>
                  <input type="text" id="action-preevent" class="menu-input" value="${n.config.preEvent}">
              </div>
              <div class="menu-control-group">
                  <label class="menu-label">Post-Evento</label>
                  <input type="text" id="action-postevent" class="menu-input" value="${n.config.postEvent}">
              </div>
          `,e.pathType==="freehand"&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Suavizado: <span id="action-smooth-val">${n.smoothingFactor}</span></label>
                      <input type="range" id="action-smooth" class="menu-input" min="1" max="20" step="1" value="${n.smoothingFactor}">
                  </div>
              `),e instanceof H||e instanceof C||e instanceof X||e instanceof k){const l=e.speed;i+=`
                  <div class="menu-control-group checkbox-wrapper">
                      <input type="checkbox" id="action-speed-check" ${l!==null?"checked":""}>
                      <label class="menu-label" for="action-speed-check">Velocidad</label>
                  </div>
                  <div class="menu-control-group" id="container-speed" style="${l!==null?"":"opacity: 0.5; pointer-events: none;"}">
                      <label class="menu-label">Valor: <span id="speed-val">${l||50}</span>%</label>
                      <input type="range" id="action-speed-val" class="menu-input" min="0" max="100" value="${l||50}">
                  </div>
              `}e instanceof C&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Gesto Tcnico</label>
                      <select id="action-gesture" class="menu-select">
                          <option value="push" ${e.gesture==="push"?"selected":""}>Push</option>
                          <option value="pegada" ${e.gesture==="pegada"?"selected":""}>Pegada</option>
                          <option value="barrida" ${e.gesture==="barrida"?"selected":""}>Barrida</option>
                          <option value="flick" ${e.gesture==="flick"?"selected":""}>Flick</option>
                      </select>
                  </div>
              `),e instanceof X&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Gesto Tcnico</label>
                      <select id="action-gesture" class="menu-select">
                          <option value="push" ${e.gesture==="push"?"selected":""}>Push</option>
                          <option value="pegada" ${e.gesture==="pegada"?"selected":""}>Pegada</option>
                          <option value="barrida" ${e.gesture==="barrida"?"selected":""}>Barrida</option>
                          <option value="flick" ${e.gesture==="flick"?"selected":""}>Flick</option>
                      </select>
                  </div>
              `),e instanceof k&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Tipo Conduccin</label>
                      <select id="action-dribble-type" class="menu-select">
                          <option value="derecho" ${e.dribbleType==="derecho"?"selected":""}>Derecho</option>
                          <option value="reves" ${e.dribbleType==="reves"?"selected":""}>Revs</option>
                          <option value="aerea" ${e.dribbleType==="aerea"?"selected":""}>Area</option>
                      </select>
                  </div>
                  <div class="menu-control-group">
                      <label class="menu-label">Visualizacin</label>
                      <select id="action-dribble-style" class="menu-select">
                          <option value="straight" ${e.style==="straight"?"selected":""}>Flecha Recta</option>
                          <option value="zigzag" ${e.style==="zigzag"?"selected":""}>ZigZag (Onda)</option>
                      </select>
                  </div>
              `),e instanceof W&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">Radio: <span id="radius-val">${e.radius}</span>px</label>
                      <input type="range" id="action-radius" class="menu-input" min="10" max="100" step="1" value="${e.radius}">
                  </div>
              `),e instanceof U&&(i+=`
                  <div class="menu-control-group">
                      <label class="menu-label">ngulo: <span id="angle-val">${e.angle}</span></label>
                      <input type="range" id="action-angle" class="menu-input" min="-360" max="360" step="5" value="${e.angle}">
                  </div>
              `)}if(t.innerHTML=i,document.querySelectorAll(".color-swatch").forEach(n=>{n.addEventListener("click",o=>{const l=o.target.dataset.color;if(l){this.selectedEntity instanceof E&&(this.selectedEntity.color=l),this.selectedEntity instanceof v&&(this.selectedEntity.color=l),this.selectedEntity instanceof w&&(this.selectedEntity.color=l),this.selectedEntity instanceof M&&(this.selectedEntity.color=l),this.selectedEntity instanceof T&&(this.selectedEntity.groupColor=l),this.selectedEntity instanceof x&&(this.selectedEntity.color=l);const r=document.getElementById("shape-color")||document.getElementById("cone-prop-color")||document.getElementById("ball-prop-color")||document.getElementById("group-prop-color")||document.getElementById("goal-prop-color");r&&(r.value=l)}})}),document.getElementById("shape-color")?.addEventListener("input",n=>{const o=n.target.value;this.selectedEntity instanceof E&&(this.selectedEntity.color=o),this.selectedEntity instanceof v&&(this.selectedEntity.color=o)}),e instanceof w)document.getElementById("cone-prop-color")?.addEventListener("input",n=>{e.color=n.target.value}),document.getElementById("cone-prop-height")?.addEventListener("input",n=>{e.height=parseInt(n.target.value,10);const o=document.getElementById("height-val");o&&(o.textContent=e.height.toString())});else if(e instanceof M)document.getElementById("ball-prop-group")?.addEventListener("change",n=>{e.isGroup=n.target.checked}),document.getElementById("ball-prop-color")?.addEventListener("input",n=>{e.color=n.target.value});else if(e instanceof x)document.getElementById("goal-prop-color")?.addEventListener("input",n=>{e.color=n.target.value});else if(e instanceof T)document.getElementById("group-prop-lines")?.addEventListener("change",n=>{e.showLines=n.target.checked}),e.shapeType==="freehand"&&document.getElementById("group-prop-smooth")?.addEventListener("input",n=>{e.smoothingFactor=parseInt(n.target.value,10);const o=document.getElementById("group-smooth-val");o&&(o.textContent=e.smoothingFactor.toString())}),document.getElementById("group-prop-dist")?.addEventListener("input",n=>{e.coneDistance=parseInt(n.target.value,10);const o=document.getElementById("dist-val");o&&(o.textContent=e.coneDistance.toString())}),document.getElementById("group-prop-color")?.addEventListener("input",n=>{e.groupColor=n.target.value}),document.getElementById("group-prop-height")?.addEventListener("input",n=>{e.groupHeight=parseInt(n.target.value,10);const o=document.getElementById("height-val");o&&(o.textContent=e.groupHeight.toString())}),document.getElementById("group-prop-ind-color")?.addEventListener("input",n=>{const o=n.target.value;e.coneColors.set(e.selectedConeIndex,o)});else if(e instanceof E){const n=e,o=n instanceof L,l=n instanceof Y,r=!o&&!l;if(document.getElementById("shape-stroke-type")?.addEventListener("change",h=>{n.strokeType=h.target.value}),o&&(document.getElementById("line-start-marker")?.addEventListener("change",h=>{n.startMarker=h.target.value}),document.getElementById("line-end-marker")?.addEventListener("change",h=>{n.endMarker=h.target.value})),l){const h=document.getElementById("shape-smooth"),c=document.getElementById("smooth-val");h?.addEventListener("input",d=>{const p=parseInt(d.target.value);n.smoothingFactor=p,c&&(c.textContent=p.toString())})}if(r){const h=document.getElementById("shape-has-fill"),c=document.getElementById("container-opacity");h?.addEventListener("change",m=>{n.hasFill=m.target.checked,c&&(c.style.opacity=n.hasFill?"1":"0.5",c.style.pointerEvents=n.hasFill?"auto":"none")});const d=document.getElementById("shape-opacity"),p=document.getElementById("opacity-val");d?.addEventListener("input",m=>{const f=parseFloat(m.target.value);n.fillOpacity=f,p&&(p.textContent=Math.round(f*100)+"%")})}}else if(e instanceof v){const n=e;document.getElementById("player-team")?.addEventListener("change",o=>{n.team=o.target.value}),document.getElementById("player-label")?.addEventListener("input",o=>{n.number=o.target.value}),document.getElementById("player-ball")?.addEventListener("change",o=>{n.hasBall=o.target.checked}),document.getElementById("player-desc")?.addEventListener("input",o=>{n.description=o.target.value})}else if(e instanceof b){if(document.getElementById("action-preevent")?.addEventListener("input",p=>{e.config.preEvent=p.target.value}),document.getElementById("action-postevent")?.addEventListener("input",p=>{e.config.postEvent=p.target.value}),e.pathType==="freehand"){const p=document.getElementById("action-smooth"),m=document.getElementById("action-smooth-val");p?.addEventListener("input",f=>{const y=parseInt(f.target.value);e.smoothingFactor=y,m&&(m.textContent=y.toString())})}const n=e,o=document.getElementById("action-speed-check"),l=document.getElementById("container-speed"),r=document.getElementById("action-speed-val"),h=document.getElementById("speed-val");o&&o.addEventListener("change",p=>{p.target.checked?(n.speed=parseInt(r.value),l&&(l.style.opacity="1",l.style.pointerEvents="auto")):(n.speed=null,l&&(l.style.opacity="0.5",l.style.pointerEvents="none"))}),r&&r.addEventListener("input",p=>{const m=parseInt(p.target.value);n.speed=m,h&&(h.textContent=m.toString())}),document.getElementById("action-gesture")?.addEventListener("change",p=>{(e instanceof C||e instanceof X)&&(e.gesture=p.target.value)}),document.getElementById("action-dribble-type")?.addEventListener("change",p=>{e instanceof k&&(e.dribbleType=p.target.value)}),document.getElementById("action-dribble-style")?.addEventListener("change",p=>{e instanceof k&&(e.style=p.target.value)});const c=document.getElementById("action-radius");c&&c.addEventListener("input",p=>{e instanceof W&&(e.radius=parseInt(p.target.value),document.getElementById("radius-val").textContent=e.radius.toString())});const d=document.getElementById("action-angle");d&&d.addEventListener("input",p=>{e instanceof U&&(e.angle=parseInt(p.target.value),document.getElementById("angle-val").textContent=e.angle.toString())})}}deleteSelected(){if(this.selectedEntity)if(this.selectedEntity instanceof b){const t=this.selectedEntity,e=t.owner;e instanceof v&&(this.commandManager.execute(new ot(e,t)),this.selectedEntity=null,this.updateSelectionUI())}else this.commandManager.execute(new st(this,this.selectedEntity)),this.selectedEntity=null,this.updateSelectionUI()}resize(){const t=this.canvas.parentElement;t?(this.canvas.width=t.clientWidth,this.canvas.height=t.clientHeight):(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight)}start(){requestAnimationFrame(t=>{this.lastTime=t,this.loop(t)})}lastTime=0;loop(t){const e=(t-this.lastTime)/1e3;this.lastTime=t,this.update(e),this.render(),requestAnimationFrame(i=>this.loop(i))}update(t){this.currentMode==="play"&&(this.animationManager.update(t),this.animationManager.isPaused&&document.getElementById("anim-play")?.querySelector("i")?.classList.replace("fa-pause","fa-play"))}render(){this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.camera.applyTransform(this.ctx,this.canvas),this.field.draw(this.ctx),this.entities.forEach(t=>t.draw(this.ctx,this.currentScene)),this.currentMode==="play"&&this.animationManager.render(this.ctx),this.tools.get(this.currentToolId)?.render(this.ctx),this.ctx.restore()}async optimizeDrill(){const t=document.getElementById("anim-play"),e=t?.innerHTML;t&&(t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',t.style.pointerEvents="none");try{const i=this.serializeDrillState(),s=await fetch("/api/optimize-drill",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(s.ok){const a=await s.json();this.applyOptimizedState(a),console.log("Drill optimized successfully")}else console.error("Optimization failed:",s.statusText)}catch(i){console.error("Error optimizing drill:",i)}finally{t&&e&&(t.innerHTML=e,t.style.pointerEvents="auto")}}serializeDrillState(){return{players:this.entities.filter(e=>e instanceof v).map(e=>{const i=e;return{id:i.id,x:i.x,y:i.y,initialX:i.initialX,initialY:i.initialY,number:i.number,hasBall:i.hasBall,team:i.team,actions:i.actions.map(s=>({id:s.id,type:s.type,startX:s.startX,startY:s.startY,endX:s.endX,endY:s.endY,config:s.config,pathType:s.pathType,points:s.points,sceneIndex:s.sceneIndex,speed:s.speed||null,waitBefore:s.waitBefore||0,gesture:s.gesture,dribbleType:s.dribbleType,style:s.style,radius:s.radius,angle:s.angle}))}})}}applyOptimizedState(t){t.players&&t.players.forEach(e=>{const i=this.entities.find(s=>s.id===e.id);i&&i.actions.forEach(s=>{const a=e.actions.find(n=>n.id===s.id);a&&(a.speed!==void 0&&(s.speed=a.speed),a.waitBefore!==void 0&&(s.waitBefore=a.waitBefore))})})}}window.addEventListener("DOMContentLoaded",()=>{new ut("gameCanvas").start()});
