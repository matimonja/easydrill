var P=Object.defineProperty;var R=(a,e,t)=>e in a?P(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var r=(a,e,t)=>(R(a,typeof e!="symbol"?e+"":e,t),t);import"./modulepreload-polyfill-3cfb730f.js";import{F as Z,G as H,i as I}from"./SyncIndicator-7c816d96.js";import"./preload-helper-cf010ec4.js";import"./ExerciseStorage-321cadc6.js";import"./user-58edc8be.js";import"./client-c375c8af.js";const E=914,u=550,l=E/2,x=u/2,y=229,d=196.3,p=18.3,m={full:{x:-l,y:-x,w:E,h:u},half:{x:0,y:-x,w:l,h:u},quarter:{x:l-y,y:-x,w:y,h:u},area:{x:l-d,y:-(p+d),w:d,h:(p+d)*2}},v=14,f="rgba(251, 146, 60, 0.22)",T="rgba(251, 146, 60, 0.18)",S="#f97316",z="#fb923c",k="#f97316";class D{constructor(e){r(this,"selectedPreset","full");r(this,"customZone",null);r(this,"onConfirm");r(this,"canvas");r(this,"ctx");r(this,"field",new Z);r(this,"interactionMode",null);r(this,"activeHandle",null);r(this,"pointerStart",null);r(this,"drawCurrent",null);r(this,"zoneSnapshot",null);this.onConfirm=e.onConfirm,this.canvas=document.getElementById("zone-preview-canvas"),this.ctx=this.canvas.getContext("2d"),this.setupCards(),this.setupCanvas(),this.setupCTA()}setupCards(){document.querySelectorAll(".zone-card").forEach(t=>{t.addEventListener("click",()=>{const s=t.dataset.preset;this.selectPreset(s)})})}selectPreset(e){var s;this.selectedPreset=e,document.querySelectorAll(".zone-card").forEach(i=>i.classList.remove("active")),(s=document.querySelector(`.zone-card[data-preset="${e}"]`))==null||s.classList.add("active");const t=document.getElementById("custom-section");e==="custom"?(t.classList.add("visible"),this.customZone=null,requestAnimationFrame(()=>this.initCanvas())):t.classList.remove("visible")}setupCanvas(){this.canvas.addEventListener("pointerdown",t=>this.onPointerDown(t)),this.canvas.addEventListener("pointermove",t=>this.onPointerMove(t)),this.canvas.addEventListener("pointerup",t=>this.onPointerUp(t)),this.canvas.addEventListener("pointercancel",()=>this.onPointerCancel()),new ResizeObserver(()=>{this.selectedPreset==="custom"&&this.initCanvas()}).observe(this.canvas.parentElement)}initCanvas(){const e=this.canvas.parentElement,t=window.devicePixelRatio||1;this.canvas.width=e.clientWidth*t,this.canvas.height=e.clientHeight*t,this.ctx.setTransform(t,0,0,t,0,0),this.renderPreview()}getCanvasScale(){const e=this.canvas.width/(window.devicePixelRatio||1),t=this.canvas.height/(window.devicePixelRatio||1),s=50,i=this.field.width+s*2,n=this.field.height+s*2,o=.06,c=e*(1-2*o),h=t*(1-2*o);return Math.min(c/i,h/n)}screenToWorld(e,t){const s=this.canvas.getBoundingClientRect(),i=this.canvas.width/(window.devicePixelRatio||1),n=this.canvas.height/(window.devicePixelRatio||1),o=(e-s.left)/s.width*i,c=(t-s.top)/s.height*n,h=this.getCanvasScale(),b=(o-i/2)/h,g=(c-n/2)/h;return{x:b,y:g}}hitTestHandle(e,t){if(!this.customZone)return null;const s=this.customZone,i=this.getCanvasScale(),n=v/i,o=[{key:"tl",cx:s.x,cy:s.y},{key:"tr",cx:s.x+s.w,cy:s.y},{key:"bl",cx:s.x,cy:s.y+s.h},{key:"br",cx:s.x+s.w,cy:s.y+s.h}];for(const c of o)if(Math.abs(e-c.cx)<n&&Math.abs(t-c.cy)<n)return c.key;return null}hitTestZone(e,t){if(!this.customZone)return!1;const s=this.customZone;return e>=s.x&&e<=s.x+s.w&&t>=s.y&&t<=s.y+s.h}onPointerDown(e){e.preventDefault(),this.canvas.setPointerCapture(e.pointerId);const t=this.screenToWorld(e.clientX,e.clientY);this.pointerStart=t;const s=this.hitTestHandle(t.x,t.y);s?(this.interactionMode="resize",this.activeHandle=s,this.zoneSnapshot={...this.customZone}):this.hitTestZone(t.x,t.y)?(this.interactionMode="move",this.zoneSnapshot={...this.customZone}):(this.interactionMode="draw",this.drawCurrent=t,this.customZone=null),this.updateCursor(t),this.renderPreview()}onPointerMove(e){const t=this.screenToWorld(e.clientX,e.clientY);if(!this.interactionMode){this.updateCursor(t);return}if(e.preventDefault(),this.interactionMode==="draw")this.drawCurrent=t;else if(this.interactionMode==="move"&&this.pointerStart&&this.zoneSnapshot){const s=t.x-this.pointerStart.x,i=t.y-this.pointerStart.y;this.customZone={x:this.zoneSnapshot.x+s,y:this.zoneSnapshot.y+i,w:this.zoneSnapshot.w,h:this.zoneSnapshot.h}}else this.interactionMode==="resize"&&this.pointerStart&&this.zoneSnapshot&&this.activeHandle&&this.applyResize(t);this.renderPreview()}onPointerUp(e){if(!this.interactionMode)return;const t=this.screenToWorld(e.clientX,e.clientY);if(this.interactionMode==="draw"&&this.pointerStart){const s=Math.min(this.pointerStart.x,t.x),i=Math.min(this.pointerStart.y,t.y),n=Math.abs(t.x-this.pointerStart.x),o=Math.abs(t.y-this.pointerStart.y);n>20&&o>20&&(this.customZone={x:s,y:i,w:n,h:o})}this.resetInteraction(),this.renderPreview()}onPointerCancel(){(this.interactionMode==="move"||this.interactionMode==="resize")&&this.zoneSnapshot&&(this.customZone=this.zoneSnapshot),this.resetInteraction(),this.renderPreview()}resetInteraction(){this.interactionMode=null,this.activeHandle=null,this.pointerStart=null,this.drawCurrent=null,this.zoneSnapshot=null}applyResize(e){if(!this.zoneSnapshot||!this.activeHandle)return;const t=this.zoneSnapshot;let s=t.x,i=t.y,n=t.w,o=t.h;const c=30;switch(this.activeHandle){case"tl":s=Math.min(e.x,t.x+t.w-c),i=Math.min(e.y,t.y+t.h-c),n=t.x+t.w-s,o=t.y+t.h-i;break;case"tr":i=Math.min(e.y,t.y+t.h-c),n=Math.max(c,e.x-t.x),o=t.y+t.h-i;break;case"bl":s=Math.min(e.x,t.x+t.w-c),n=t.x+t.w-s,o=Math.max(c,e.y-t.y);break;case"br":n=Math.max(c,e.x-t.x),o=Math.max(c,e.y-t.y);break}this.customZone={x:s,y:i,w:n,h:o}}updateCursor(e){const t=this.hitTestHandle(e.x,e.y);t?t==="tl"||t==="br"?this.canvas.style.cursor="nwse-resize":this.canvas.style.cursor="nesw-resize":this.hitTestZone(e.x,e.y)?this.canvas.style.cursor="move":this.canvas.style.cursor="crosshair"}renderPreview(){const e=this.canvas.width/(window.devicePixelRatio||1),t=this.canvas.height/(window.devicePixelRatio||1);this.ctx.clearRect(0,0,e,t),this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,e,t);const s=this.getCanvasScale();if(this.ctx.save(),this.ctx.translate(e/2,t/2),this.ctx.scale(s,s),this.field.draw(this.ctx),this.interactionMode==="draw"&&this.pointerStart&&this.drawCurrent){const i=Math.min(this.pointerStart.x,this.drawCurrent.x),n=Math.min(this.pointerStart.y,this.drawCurrent.y),o=Math.abs(this.drawCurrent.x-this.pointerStart.x),c=Math.abs(this.drawCurrent.y-this.pointerStart.y);this.ctx.fillStyle=f,this.ctx.fillRect(i,n,o,c),this.ctx.strokeStyle=S,this.ctx.lineWidth=2/s,this.ctx.setLineDash([6/s,4/s]),this.ctx.strokeRect(i,n,o,c),this.ctx.setLineDash([])}if(this.customZone&&this.interactionMode!=="draw"){const i=this.customZone,n=this.interactionMode==="move"||this.interactionMode==="resize";this.ctx.fillStyle=n?f:T,this.ctx.fillRect(i.x,i.y,i.w,i.h),this.ctx.strokeStyle=n?S:z,this.ctx.lineWidth=2/s,this.ctx.setLineDash(n?[]:[6/s,4/s]),this.ctx.strokeRect(i.x,i.y,i.w,i.h),this.ctx.setLineDash([]),this.drawHandles(i,s)}this.ctx.restore()}drawHandles(e,t){const s=v/t,i=s/2,n=[{cx:e.x,cy:e.y},{cx:e.x+e.w,cy:e.y},{cx:e.x,cy:e.y+e.h},{cx:e.x+e.w,cy:e.y+e.h}];this.ctx.fillStyle=k,this.ctx.strokeStyle="#fff",this.ctx.lineWidth=1.5/t;for(const o of n)this.ctx.fillRect(o.cx-i,o.cy-i,s,s),this.ctx.strokeRect(o.cx-i,o.cy-i,s,s)}setupCTA(){document.getElementById("btn-start").addEventListener("click",()=>this.confirm())}confirm(){let e;this.selectedPreset==="custom"?this.customZone?e=this.customZone:e=m.full:e=m[this.selectedPreset];const t=e.h>e.w,s={preset:this.selectedPreset,zone:e,rotate:t};this.onConfirm(s)}}let w=!0;function _(){w=!0,window.scrollTo(0,0)}function C(){w=!1}function W(){const a=document.getElementById("setup-screen");window.addEventListener("scroll",()=>{if(!w)return;const e=a.offsetHeight-window.innerHeight;e<=0?window.scrollTo(0,0):window.scrollY>e&&window.scrollTo(0,e)})}function L(){document.body.classList.add("editor-locked"),window.dispatchEvent(new Event("resize"))}function A(){C(),document.getElementById("app").scrollIntoView({behavior:"smooth"});const e=()=>L();"onscrollend"in window?window.addEventListener("scrollend",e,{once:!0}):setTimeout(e,600)}function M(a,e){new H("gameCanvas",a,e).start(),I()}window.addEventListener("DOMContentLoaded",()=>{const a=new URLSearchParams(window.location.search),e=a.get("id")||void 0,t=a.get("drill")||void 0,s=!!e||!!t;W(),s?(C(),M(void 0,e),requestAnimationFrame(()=>{document.getElementById("app").scrollIntoView({behavior:"instant"}),requestAnimationFrame(()=>L())})):(_(),new D({onConfirm:i=>{M(i),A()}}))});
